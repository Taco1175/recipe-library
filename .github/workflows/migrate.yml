name: Run Supabase Migrations

on:
  push:
    branches: [main]
    paths:
      - 'migrations/**.sql'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run new migrations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          set -e

          # Extract project ref from URL (https://abcdef.supabase.co -> abcdef)
          PROJECT_REF=$(echo "$SUPABASE_URL" | sed 's|https://||' | sed 's|\.supabase\.co.*||')
          echo "Project ref: $PROJECT_REF"

          # Link project
          supabase link --project-ref "$PROJECT_REF" --password "$SUPABASE_SERVICE_KEY"

          # Ensure tracking table exists
          echo "CREATE TABLE IF NOT EXISTS _migrations (filename TEXT PRIMARY KEY, run_at TIMESTAMPTZ DEFAULT NOW());" \
            | supabase db execute --stdin --linked

          # Get already-run filenames
          DONE=$(echo "SELECT filename FROM _migrations;" | supabase db execute --stdin --linked 2>/dev/null || echo "")
          echo "Already run: $DONE"

          # Run each pending .sql file in order
          for f in $(ls migrations/*.sql | sort); do
            filename=$(basename "$f")
            if echo "$DONE" | grep -q "$filename"; then
              echo "⏭  Already ran: $filename"
            else
              echo "▶  Running: $filename"
              supabase db execute --file "$f" --linked
              echo "INSERT INTO _migrations (filename) VALUES ('$filename') ON CONFLICT DO NOTHING;" \
                | supabase db execute --stdin --linked
              echo "✅ Done: $filename"
            fi
          done
