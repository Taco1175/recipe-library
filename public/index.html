<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>My Recipe Library</title>
<style>
:root {
  --bg: #0F1117;
  --bg2: #1a1f2e;
  --bg3: #12151f;
  --bg4: #1e2330;
  --border: #2a2f3e;
  --text: #E8E4DC;
  --text2: #9a9fae;
  --text3: #556;
  --accent: #6e8efb;
  --green: #4CAF50;
  --green-bg: #E8F5E9;
  --green-text: #1B5E20;
  --red: #e07070;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: Georgia, serif; min-height: 100vh; }
a { color: var(--accent); }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app { display: block; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  background: linear-gradient(135deg, #1a1f2e, var(--bg));
  border-bottom: 1px solid var(--border); padding: 20px 24px 18px;
  position: sticky; top: 0; z-index: 50;
}
.header-inner { max-width: 1300px; margin: 0 auto; }
.header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 10px; }
.header h1 { font-size: 24px; font-weight: 700; color: #F5F0E8; display: flex; align-items: center; gap: 10px; }
.header-actions { display: flex; gap: 8px; align-items: center; }
.count-badge { font-size: 12px; color: #888; font-family: monospace; font-weight: 400; }
.pills { display: flex; gap: 6px; flex-wrap: wrap; }
.pill {
  display: inline-flex; align-items: center; gap: 5px; border-radius: 20px;
  padding: 4px 12px; font-size: 11px; cursor: pointer; font-family: monospace;
  border: 1px solid var(--border); background: var(--bg4); color: #aaa;
  transition: all .2s; user-select: none;
}
.pill.active { border-color: var(--dot); background: var(--bg); color: var(--text); }
.pill .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; display: inline-block; flex-shrink: 0; }
.pill.active .dot { background: var(--dot); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { max-width: 1300px; margin: 0 auto; padding: 20px 24px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  border: none; border-radius: 8px; padding: 9px 16px; font-size: 13px;
  font-family: Georgia, serif; cursor: pointer; transition: all .2s;
  display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #5a7df0; }
.btn-primary:disabled { background: #3a4060; color: #666; cursor: default; }
.btn-success { background: #2d6a4f; color: #7bcf8e; border: 1px solid #3a8a65; }
.btn-success:hover { background: #3a7a5f; }
.btn-danger { background: #4a1a1a; color: var(--red); border: 1px solid #6a3030; font-size: 12px; padding: 6px 11px; }
.btn-danger:hover { background: #5a2a2a; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: #aaa; }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-ghost { background: transparent; border: none; color: var(--text2); padding: 8px 10px; }
.btn-ghost:hover { color: var(--text); }
.grocery-badge {
  background: var(--red); color: #fff; border-radius: 50%;
  width: 18px; height: 18px; display: inline-flex; align-items: center;
  justify-content: center; font-size: 10px; font-family: monospace;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.search-wrap { position: relative; flex: 1; min-width: 200px; }
.search-wrap input {
  width: 100%; background: var(--bg4); border: 1px solid var(--border);
  border-radius: 8px; padding: 9px 36px 9px 14px; color: var(--text);
  font-size: 14px; outline: none; font-family: Georgia, serif;
  transition: border-color .2s;
}
.search-wrap input:focus { border-color: var(--accent); }
.search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #556; cursor: pointer; font-size: 16px; padding: 2px; }
select.flt {
  background: var(--bg4); border: 1px solid var(--border); border-radius: 8px;
  padding: 9px 10px; color: var(--text); font-size: 12px; outline: none;
  font-family: Georgia, serif; cursor: pointer;
}

/* ‚îÄ‚îÄ INGREDIENT MATCHER ‚îÄ‚îÄ */
.fridge-bar {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; margin-bottom: 16px; display: none;
}
.fridge-bar.show { display: block; }
.fridge-bar h3 { font-size: 13px; color: #F5F0E8; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.fridge-row { display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; }
.fridge-row textarea {
  flex: 1; min-width: 200px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 12px; color: var(--text); font-size: 13px;
  outline: none; font-family: Georgia, serif; resize: vertical; min-height: 60px;
  transition: border-color .2s;
}
.fridge-row textarea:focus { border-color: var(--accent); }
.fridge-info { font-size: 11px; color: var(--text3); margin-top: 8px; font-family: monospace; }
.match-badge {
  display: inline-flex; align-items: center; gap: 4px; border-radius: 10px;
  padding: 2px 8px; font-size: 10px; font-family: monospace; font-weight: 600;
}
.match-full { background: #1a3a1a; color: #7bcf8e; border: 1px solid #2a5a2a; }
.match-partial { background: #2a2a10; color: #d4b84a; border: 1px solid #4a4a20; }

/* ‚îÄ‚îÄ COUNT ‚îÄ‚îÄ */
.count { font-size: 12px; color: #666; font-family: monospace; margin-bottom: 12px; }
.clear-link { cursor: pointer; margin-left: 10px; color: var(--accent); text-decoration: underline; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.thead {
  display: grid; grid-template-columns: 28px minmax(0,1fr) 90px 110px 54px 44px 80px 30px;
  padding: 10px 14px; background: var(--bg3); border-bottom: 1px solid var(--border);
  font-size: 10px; letter-spacing: .08em; text-transform: uppercase;
  color: var(--text3); font-family: monospace; gap: 8px; align-items: center;
}
.trow-wrap { border-bottom: 1px solid var(--bg4); }
.trow-wrap:last-child { border-bottom: none; }
.trow {
  display: grid; grid-template-columns: 28px minmax(0,1fr) 90px 110px 54px 44px 80px 30px;
  padding: 11px 14px; align-items: center; gap: 8px; cursor: pointer;
  transition: background .15s;
}
.trow:hover { background: var(--bg4); }
.recipe-name { font-size: 13px; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 6px; min-width: 0; }
.recipe-name-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.expand-icon { font-size: 8px; color: #445; transition: transform .2s; flex-shrink: 0; }
.trow-wrap.open .expand-icon { transform: rotate(90deg); }
.has-details .recipe-name { color: #b8d8ff; }
.no-details-hint { font-size: 9px; color: #334; font-family: monospace; flex-shrink: 0; }

/* Recipe detail modal */
.recipe-modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:200; align-items:center; justify-content:center; padding:16px; }
.recipe-modal-overlay.show { display:flex; }
.recipe-modal { background:#1a1f2e; border:1px solid #2a2f3e; border-radius:14px; width:100%; max-width:720px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; position:relative; }
.recipe-modal-header { padding:20px 24px 16px; border-bottom:1px solid #2a2f3e; display:flex; align-items:flex-start; gap:16px; }
.recipe-modal-img { width:100px; height:75px; object-fit:cover; border-radius:8px; flex-shrink:0; }
.recipe-modal-title { flex:1; }
.recipe-modal-title h2 { font-size:18px; color:#F5F0E8; margin:0 0 6px; line-height:1.3; }
.recipe-modal-body { overflow-y:auto; padding:20px 24px; display:grid; grid-template-columns:1fr 1.4fr; gap:24px; }
.recipe-modal-close { position:absolute; top:12px; right:12px; background:none; border:none; color:#666; font-size:20px; cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:6px; }
.recipe-modal-close:hover { background:var(--border); color:var(--text); }
.modal-section-title { font-size:10px; letter-spacing:0.08em; text-transform:uppercase; color:#556; font-family:monospace; margin-bottom:10px; }
.modal-ing-list { list-style:none; padding:0; margin:0; }
.modal-ing-list li { padding:5px 0; border-bottom:1px solid #1e2330; font-size:13px; color:#c8d0e0; line-height:1.4; }
.modal-ing-list li:last-child { border-bottom:none; }
.modal-step-list { list-style:none; padding:0; margin:0; counter-reset:steps; }
.modal-step-list li { counter-increment:steps; padding:8px 0 8px 36px; border-bottom:1px solid #1e2330; font-size:13px; color:#c8d0e0; line-height:1.5; position:relative; }
.modal-step-list li::before { content:counter(steps); position:absolute; left:0; top:8px; width:24px; height:24px; background:#2a3050; color:#6e8efb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-family:monospace; font-weight:600; }
.modal-step-list li:last-child { border-bottom:none; }
.reader-btn { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#6e8efb; background:#1e2a4a; border:1px solid #2a3a6a; border-radius:6px; padding:5px 10px; text-decoration:none; cursor:pointer; margin-top:8px; }
.reader-btn:hover { background:#2a3a6a; }
@media(max-width:600px) { .recipe-modal-body { grid-template-columns:1fr; } .recipe-modal-img { display:none; } }

/* Backfill button */
.backfill-btn { font-size:11px; background:#1e2330; border:1px solid #2a2f3e; color:#888; border-radius:6px; padding:4px 10px; cursor:pointer; font-family:monospace; }
.backfill-btn:hover { color:#aaa; border-color:#3a4050; }

/* Grid view */
.view-toggle { display:flex; gap:4px; }
.view-toggle button { background:#1e2330; border:1px solid #2a2f3e; color:#666; border-radius:6px; width:30px; height:30px; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
.view-toggle button.active { background:#2a3050; border-color:#6e8efb; color:#6e8efb; }
.recipe-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:16px; }
.recipe-card { background:#1a1f2e; border:1px solid #2a2f3e; border-radius:10px; overflow:hidden; cursor:pointer; transition:all 0.2s; position:relative; }
.recipe-card:hover { border-color:#6e8efb; transform:translateY(-2px); box-shadow:0 4px 20px rgba(0,0,0,0.3); }
.recipe-card.no-details { opacity:0.6; }
.recipe-card .card-img { width:100%; aspect-ratio:4/3; object-fit:cover; background:#12151f; display:block; }
.recipe-card .card-img-placeholder { width:100%; aspect-ratio:4/3; background:#12151f; display:flex; align-items:center; justify-content:center; font-size:36px; }
.recipe-card .card-body { padding:10px 12px 12px; }
.recipe-card .card-name { font-size:13px; font-weight:600; color:#e8e4dc; margin-bottom:5px; line-height:1.3; }
.recipe-card .card-name.dim { color:#555; }
.recipe-card .card-meta { display:flex; align-items:center; justify-content:space-between; }
.recipe-card .card-cost { font-size:12px; color:#7bcf8e; font-family:monospace; font-weight:600; }
.recipe-card .card-check { position:absolute; top:8px; left:8px; width:20px; height:20px; accent-color:#6e8efb; cursor:pointer; }
.recipe-card .card-badge { position:absolute; top:8px; right:8px; }
@media (max-width:700px) { .recipe-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px; } }
.trow.no-details .recipe-name-text { color: #555; }
.badge { display: inline-flex; align-items: center; gap: 3px; border-radius: 10px; padding: 2px 8px; font-size: 10px; font-family: monospace; white-space: nowrap; }
.badge .dot { width: 4px; height: 4px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
.meta { font-size: 11px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cost { font-size: 11px; color: #7bcf8e; font-family: monospace; font-weight: 600; }
.sort-hdr { cursor: pointer; user-select: none; white-space: nowrap; }
.sort-hdr:hover span { color: #c8d0e0; }
.sort-hdr span.active { color: #6e8efb; }
.sort-hdr span.active::after { content: " ‚Üì"; }
.sort-hdr span.active.asc::after { content: " ‚Üë"; }
.link-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 26px; height: 26px; border-radius: 6px; background: #1e2a3a;
  border: 1px solid #2a3f5e; color: var(--accent); font-size: 11px;
  text-decoration: none; transition: all .15s; flex-shrink: 0;
}
.link-btn:hover { background: #2a3f5e; }
input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; }

/* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
.detail-panel { display: none; padding: 0 14px 18px 46px; background: #0e1118; border-top: 1px solid var(--bg4); }
.trow-wrap.open .detail-panel { display: block; }
.detail-inner { display: grid; grid-template-columns: 1fr 1.6fr; gap: 24px; padding-top: 18px; }
.detail-section h3 { font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--text3); font-family: monospace; margin-bottom: 8px; }
.ing-list { list-style: none; }
.ing-list li { font-size: 12px; color: #c0c8da; padding: 3px 0 3px 12px; border-bottom: 1px solid #1a1f2e; position: relative; line-height: 1.4; }
.ing-list li:last-child { border-bottom: none; }
.ing-list li::before { content: "¬∑"; color: var(--accent); position: absolute; left: 0; }
.steps-list { list-style: none; counter-reset: steps; }
.steps-list li { font-size: 12px; color: #c0c8da; padding: 6px 0 6px 28px; border-bottom: 1px solid #1a1f2e; position: relative; counter-increment: steps; line-height: 1.5; }
.steps-list li:last-child { border-bottom: none; }
.steps-list li::before {
  content: counter(steps); position: absolute; left: 0; top: 6px;
  width: 18px; height: 18px; background: #1e2a3a; border: 1px solid #2a3f5e;
  border-radius: 50%; font-size: 9px; color: var(--accent); font-family: monospace;
  text-align: center; line-height: 18px;
}
.detail-actions { margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap; }
.detail-loading { display: flex; align-items: center; gap: 10px; color: var(--text2); font-size: 13px; padding: 18px 0; }
.spinner { width: 15px; height: 15px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ ADD PANEL ‚îÄ‚îÄ */
.add-panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 18px; display: none; }
.add-panel.show { display: block; }
.add-panel h2 { font-size: 15px; color: #F5F0E8; margin-bottom: 14px; }
.add-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.field label { display: block; font-size: 10px; color: var(--text3); font-family: monospace; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 4px; }
.field input, .field select {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 10px; color: var(--text); font-size: 13px;
  outline: none; font-family: Georgia, serif; transition: border-color .2s;
}
.field input:focus, .field select:focus { border-color: var(--accent); }
.field.full { grid-column: 1/-1; }
.url-row { display: flex; gap: 8px; align-items: flex-end; }
.url-row .field { flex: 1; margin: 0; }
.add-msg { font-size: 12px; font-family: monospace; padding: 8px 10px; border-radius: 6px; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
.add-msg.error { background: #2a1515; color: var(--red); border: 1px solid #4a2020; }
.add-msg.success { background: #152a1e; color: #7bcf8e; border: 1px solid #2a5a3e; }
.add-msg.loading { background: var(--bg2); color: var(--text2); border: 1px solid var(--border); }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.8); z-index: 100;
  display: none; align-items: flex-start; justify-content: center;
  padding: 24px 16px; overflow-y: auto;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
  width: 100%; max-width: 640px; padding: 28px; position: relative;
  margin: auto;
}
.modal h2 { font-size: 20px; color: #F5F0E8; margin-bottom: 4px; }
.modal .subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.modal-close { position: absolute; top: 14px; right: 14px; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
.modal-close:hover { background: var(--border); color: var(--text); }
.g-section { margin-bottom: 18px; }
.g-section h3 { font-size: 11px; letter-spacing: .1em; text-transform: uppercase; color: var(--accent); font-family: monospace; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
.g-item { display: flex; align-items: baseline; gap: 8px; padding: 5px 0; font-size: 14px; color: #c8d0e0; border-bottom: 1px solid #141820; }
.g-item:last-child { border-bottom: none; }
.g-item::before { content: "‚òê"; color: #4a5070; font-size: 12px; flex-shrink: 0; }
.g-from { font-size: 10px; color: #445; font-family: monospace; margin-left: auto; flex-shrink: 0; padding-left: 8px; }
.modal-footer { margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }

/* ‚îÄ‚îÄ MATCH RESULTS ‚îÄ‚îÄ */
.match-result-header { font-size: 12px; color: var(--text2); margin-bottom: 10px; font-family: monospace; }
.match-score-bar { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
.score-track { flex: 1; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 2px; transition: width .4s; }
.score-pct { font-size: 10px; font-family: monospace; color: var(--text3); width: 28px; text-align: right; }

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty { padding: 40px; text-align: center; color: #555; font-size: 14px; }
.footer-note { margin-top: 12px; font-size: 11px; color: #444; text-align: center; font-family: monospace; }

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 700px) {
  /* Header */
  .header { padding: 12px 14px 10px; }
  .header h1 { font-size: 18px; }
  .header-top { flex-wrap: wrap; gap: 8px; }
  .header-actions { flex-wrap: wrap; gap: 6px; }
  .header-actions .btn { font-size: 11px !important; padding: 5px 8px; }
  .backfill-btn { display: none; } /* hide on mobile */
  .main { padding: 10px 10px; }
  .pills { gap: 4px; }

  /* Hide table header */
  .thead { display: none; }

  /* Mobile row: checkbox | name+meta | archive */
  .trow {
    grid-template-columns: 28px 1fr 32px;
    grid-template-rows: auto;
    padding: 10px 10px;
    gap: 0;
    align-items: center;
  }
  /* Hide all columns except checkbox(1), name(2), archive(9) */
  .trow > *:nth-child(3),
  .trow > *:nth-child(4),
  .trow > *:nth-child(5),
  .trow > *:nth-child(6),
  .trow > *:nth-child(7),
  .trow > *:nth-child(8) { display: none !important; }
  .trow > *:nth-child(9) { grid-column: 3; grid-row: 1; display: flex; justify-content: center; }

  /* Recipe name */
  .recipe-name { font-size: 14px; flex-wrap: nowrap; gap: 4px; }
  .recipe-name-text { color: #e8e4dc; font-size: 13px; }
  .no-details-hint { display: none; }

  /* Mobile meta subtitle */
  .recipe-mobile-meta { display: block !important; font-size: 11px; color: #778; margin-top: 2px; }

  /* Detail panel */
  .detail-panel { padding: 0 10px 16px 10px; }
  .detail-inner { grid-template-columns: 1fr; gap: 16px; }

  /* Add form */
  .add-grid { grid-template-columns: 1fr; }
  .field.full { grid-column: 1; }

  /* Modals */
  .modal { padding: 16px 14px; }
  .recipe-modal { margin: 8px; max-height: calc(100vh - 16px); }
  .recipe-modal-header { padding: 14px 16px 12px; flex-wrap: wrap; }
  .recipe-modal-body { padding: 14px 16px; }

  /* Topbar filters */
  .topbar { gap: 6px; flex-wrap: wrap; }
  .topbar .flt { font-size: 12px; padding: 7px 8px; }
  .view-toggle button { width: 28px; height: 28px; font-size: 13px; }
}

/* Boost text contrast globally */
:root {
  --text2: #b0b5c4;
}
</style>
<script src="/auth.js"></script>
</head>
<body>
<!-- AUTH GUARD -->
<script>
// Auth guard ‚Äî redirect to login if no valid session
(function() {
  const token = localStorage.getItem("sb-access-token");
  const expiry = parseInt(localStorage.getItem("sb-token-expiry") || "0");
  if (!token || Date.now() > expiry) {
    location.href = "/login.html?next=" + encodeURIComponent(location.pathname);
  }
})();
</script>

<!-- APP -->
<script>
// Bootstrap: load config FIRST, then init app
(async () => {
  try {
    const cfg = await fetch("/.netlify/functions/config").then(r => r.json());
    window.__SUPABASE_URL__ = cfg.supabaseUrl;
    window.__SUPABASE_ANON_KEY__ = cfg.supabaseAnonKey;
    window.__GOOGLE_CLIENT_ID__ = cfg.googleClientId;
  } catch(e) { console.error("Config load failed", e); }
  await showApp();
})();
</script>
<div id="app">
  <div class="header">
    <div class="header-inner">
      <div class="header-top">
        <h1>üçΩ My Recipe Library <span class="count-badge" id="total-badge"></span></h1>
        <div class="header-actions">
          <button class="btn btn-outline" style="font-size:12px" onclick="toggleFridge()">ü•¶ What's in my fridge?</button>
          <button class="btn btn-outline" style="font-size:12px" onclick="location.href='planner.html'">üìÖ Plan Week</button>
          <button class="btn btn-outline" style="font-size:12px" onclick="toggleAdd()">Ôºã Add</button>
          <button id="backfill-btn" class="backfill-btn" onclick="backfillImages()">üñº Backfill Images</button>
          <button onclick="startTutorial()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text2);font-size:12px;cursor:pointer;font-family:monospace;display:flex;align-items:center;gap:5px">
            ‚ú® Tutorial
          </button>
          <button onclick="openShareModal()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text2);font-size:12px;cursor:pointer;font-family:monospace;display:flex;align-items:center;gap:5px">
            üë• Share
          </button>
          <div id="user-menu" style="position:relative;display:inline-flex;align-items:center">
            <button onclick="toggleUserMenu()" style="background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:4px 12px 4px 6px;display:flex;align-items:center;gap:6px;cursor:pointer;color:var(--text2);font-size:12px;font-family:monospace">
              <span style="width:24px;height:24px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff" id="user-avatar">?</span>
              <span id="user-email-short"></span>
            </button>
            <div id="user-dropdown" style="display:none;position:absolute;top:36px;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:8px;min-width:180px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,0.4)">
              <div id="user-email-full" style="font-size:11px;color:var(--text3);font-family:monospace;padding:4px 8px 8px;border-bottom:1px solid var(--border);margin-bottom:6px"></div>
              <button onclick="Auth.signOut()" style="width:100%;text-align:left;background:none;border:none;color:var(--red);font-size:13px;padding:6px 8px;border-radius:6px;cursor:pointer;font-family:DM Sans,sans-serif">Sign out</button>
            </div>
          </div>
          <button class="btn btn-success" id="grocery-btn" onclick="openGrocery()" style="display:none">
            üõí <span class="grocery-badge" id="grocery-count">0</span>
          </button>
          <div id="user-menu" style="display:flex;align-items:center;gap:8px;margin-left:4px">
            <span id="user-email" style="font-size:11px;color:var(--text3);font-family:monospace;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
            <button class="btn btn-outline" style="font-size:11px;padding:4px 8px" onclick="Auth.signOut()">Sign Out</button>
          </div>
        </div>
      </div>
      <div class="pills" id="pills"></div>
    </div>
  </div>

  <div class="main">

    <!-- Fridge bar -->
    <div class="fridge-bar" id="fridge-bar">
      <h3>ü•¶ What's in my fridge? <span style="font-size:11px;color:var(--text3);font-family:monospace;font-weight:400">‚Äî find recipes you can make</span></h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <!-- Searchable dropdown trigger -->
        <div style="position:relative;flex:1;min-width:220px;" id="fridge-dropdown-wrap">
          <input id="fridge-search" type="text" placeholder="Search ingredients to add..."
            oninput="fridgeDropdownFilter(this.value)" onfocus="showFridgeDropdown()" onblur="setTimeout(()=>{document.getElementById('fridge-dropdown').style.display='none'},200)" onkeydown="fridgeKeyNav(event)"
            autocomplete="off"
            style="width:100%;background:#12151f;border:1px solid #2a2f3e;border-radius:8px;padding:9px 14px;color:#E8E4DC;font-size:13px;outline:none;font-family:Georgia,serif;">
          <div id="fridge-dropdown" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#1a1f2e;border:1px solid #2a2f3e;border-radius:8px;max-height:220px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.4);">
          </div>
        </div>
        <button class="btn btn-primary" onclick="runFridgeMatch()">üîç Find Recipes</button>
        <button class="btn btn-outline" onclick="clearMatch()">Clear</button>
      </div>
      <!-- Selected ingredient chips -->
      <div id="fridge-chips" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
      <div class="fridge-info" id="fridge-info"></div>
    </div>

    <!-- Add panel -->
    <div class="add-panel" id="add-panel">
      <h2>‚ûï Add New Recipe</h2>
      <div class="add-grid">
        <div class="field full url-row">
          <label>Recipe URL</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="url" id="new-url" placeholder="Paste URL here..."
              onblur="autoFetchRecipe(this.value)" autocomplete="off" style="flex:1">
            <button type="button" onclick="autoFetchRecipe(document.getElementById('new-url').value)"
              style="background:#2a3f5e;border:1px solid #3a5a8e;color:#7eb8f7;border-radius:6px;padding:8px 14px;cursor:pointer;font-size:12px;font-family:monospace;white-space:nowrap;flex-shrink:0"
              onmouseover="this.style.background='#3a5070'" onmouseout="this.style.background='#2a3f5e'">
              üîç Fetch
            </button>
          </div>
        </div>
        <div class="field"><label>Recipe Name</label><input type="text" id="new-name" placeholder="Auto-filled"></div>
        <div class="field"><label>Category</label>
          <select id="new-cat">
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch/Dinner" selected>Lunch/Dinner</option>
            <option value="Salad">Salad</option>
            <option value="Side">Side</option>
            <option value="Dessert">Dessert</option>
          </select>
        </div>
        <div class="field"><label>Protein</label><input type="text" id="new-protein" placeholder="e.g. Chicken"></div>
        <div class="field"><label>Method</label><input type="text" id="new-method" placeholder="e.g. Slow Cooker"></div>
        <div class="field"><label>Source</label><input type="text" id="new-source" placeholder="e.g. Kay Nutrition"></div>
        <div class="field"><label>Est. Aldi Cost</label><input type="text" id="new-cost" placeholder="e.g. $10-13"></div>
        <div class="field"><label>Servings</label><input type="number" id="new-servings" placeholder="e.g. 4" min="1" max="24"></div>
      </div>
      <div id="add-msg" style="display:none" class="add-msg"></div>
      <div id="fetch-preview" style="display:none;margin-top:12px;border:1px solid #2a2f3e;border-radius:8px;overflow:hidden">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
          <div style="padding:12px 14px;border-right:1px solid #2a2f3e">
            <div style="font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:#556;font-family:monospace;margin-bottom:8px">Ingredients</div>
            <ul id="preview-ingredients" style="margin:0;padding:0 0 0 16px;font-size:12px;color:#b0b5c4;line-height:1.8"></ul>
          </div>
          <div style="padding:12px 14px">
            <div style="font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:#556;font-family:monospace;margin-bottom:8px">Steps</div>
            <ol id="preview-steps" style="margin:0;padding:0 0 0 16px;font-size:12px;color:#b0b5c4;line-height:1.8"></ol>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="saveNew()">Save Recipe</button>
        <button class="btn btn-outline" onclick="toggleAdd()">Cancel</button>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="view-toggle">
        <button id="btn-table" class="active" onclick="setView('table')" title="Table view">‚ò∞</button>
        <button id="btn-grid" onclick="setView('grid')" title="Grid view">‚äû</button>
      </div>
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Search recipes‚Ä¶" oninput="onSearch(this.value)">
        <button class="search-clear" onclick="clearSearch()" title="Clear">√ó</button>
      </div>
      <select class="flt" id="filterProt" onchange="fProt=this.value;render()"><option value="">All Proteins</option></select>
      <select class="flt" id="filterMeth" onchange="fMeth=this.value;render()"><option value="">All Methods</option></select>
      <select class="flt" id="sortBy" onchange="sort=this.value;render()">
        <option value="category">Category</option>
        <option value="name">Name A-Z</option>
        <option value="protein">Protein</option>
        <option value="method">Method</option>
        <option value="cost">Cost ‚Üë</option>
        <option value="match">Match %</option>
      </select>
    </div>

    <div class="count" id="count"></div>

    <div id="grid-view" class="recipe-grid" style="display:none"></div>
    <div class="table" id="table-view">
      <div class="thead">
        <div></div>
        <div class="sort-hdr" onclick="setSort('name')"><span id="shdr-name">Recipe</span></div>
        <div class="sort-hdr" onclick="setSort('category')"><span id="shdr-category">Category</span></div>
        <div class="sort-hdr" onclick="setSort('method')"><span id="shdr-method">Method</span></div>

        <div class="sort-hdr" onclick="setSort('cost')"><span id="shdr-cost">Cost</span></div>
        <div id="match-col-header" class="sort-hdr" onclick="setSort('match')"><span id="shdr-match">Match</span></div>
        <div>Servings</div>
        <div></div>
      </div>
      <div id="rows"></div>
    </div>
    <div class="footer-note">Blue = has saved details ¬∑ Click row to expand ¬∑ ‚úì to add to grocery list ¬∑ <a href="/privacy.html" style="color:#556;text-decoration:none">Privacy Policy</a></div>
  </div>
</div>

<!-- Grocery Modal -->
<!-- Recipe Detail Modal -->
<div class="recipe-modal-overlay" id="recipe-modal" onclick="if(event.target===this)closeRecipeModal()">
  <div class="recipe-modal">
    <button class="recipe-modal-close" onclick="closeRecipeModal()">‚úï</button>
    <div class="recipe-modal-header">
      <img id="rmodal-img" class="recipe-modal-img" src="" alt="" style="display:none" onerror="this.style.display='none'">
      <div class="recipe-modal-title">
        <h2 id="rmodal-name"></h2>
        <div id="rmodal-meta" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <a id="rmodal-reader" class="reader-btn" target="_blank">üìñ Full Recipe View</a>
          <a id="rmodal-source" class="reader-btn" target="_blank" style="display:none">‚Üó Original</a>
        </div>
      </div>
    </div>
    <div class="recipe-modal-body">
      <div>
        <div class="modal-section-title">Ingredients</div>
        <ul class="modal-ing-list" id="rmodal-ingredients"></ul>
      </div>
      <div>
        <div class="modal-section-title">Instructions</div>
        <ol class="modal-step-list" id="rmodal-steps"></ol>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="grocery-modal" onclick="if(event.target===this)closeGrocery()">
  <div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column;">
    <button class="modal-close" onclick="closeGrocery()">‚úï</button>
    <h2>üõí Grocery List</h2>
    <p class="subtitle" id="g-subtitle"></p>

    <!-- Cart summary header - always visible at top -->
    <div id="g-cart-header" style="margin-bottom:12px;"></div>

    <!-- Search bar -->
    <input id="g-search" type="text" placeholder="Search ingredients..." oninput="filterGrocery(this.value)"
      style="width:100%;background:#12151f;border:1px solid #2a2f3e;border-radius:8px;padding:9px 14px;color:#E8E4DC;font-size:13px;outline:none;margin-bottom:8px;font-family:Georgia,serif;">

    <!-- Select all / none -->
    <div style="display:flex;gap:10px;margin-bottom:10px;font-size:12px;font-family:monospace;">
      <span onclick="selectAllGrocery(true)" style="color:#6e8efb;cursor:pointer;text-decoration:underline">Select all</span>
      <span onclick="selectAllGrocery(false)" style="color:#6e8efb;cursor:pointer;text-decoration:underline">Deselect all</span>
      <span id="g-selected-count" style="color:#666;margin-left:auto"></span>
    </div>

    <!-- Ingredient list -->
    <div id="g-body" style="overflow-y:auto;flex:1;min-height:0;"></div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="copyCheckedGrocery()">üìã Copy checked</button>
      <button class="btn btn-primary" onclick="closeGrocery()">Done</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ BASE RECIPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE = [
  {id:1,name:"Freezer Breakfast Burritos",category:"Breakfast",protein:"Turkey & Beef",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/472-cal-freezer-breakfast-burritos/",cost:"$8-10"},
  {id:2,name:"Meal Prep Breakfast Burritos",category:"Breakfast",protein:"Sausage & Eggs",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-breakfast-burritos/",cost:"$9-12"},
  {id:3,name:"Veggie-Loaded Egg Scramble",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:4,name:"Protein Yogurt Bowl",category:"Breakfast",protein:"Protein Powder",method:"No Cook",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$3-5"},
  {id:5,name:"Cauliflower & Egg Fried Rice Breakfast Bowl",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:6,name:"Savory Egg Muffin Veggie Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:7,name:"Spinach Breakfast Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-breakfast-casserole/",cost:"$5-7"},
  {id:8,name:"Breakfast Egg Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/breakfast-egg-bake/",cost:"$5-7"},
  {id:9,name:"Spinach Egg Muffins with Feta",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-egg-muffins-with-feta/",cost:"$5-8"},
  {id:10,name:"Bacon Egg Muffin Cups",category:"Breakfast",protein:"Eggs & Bacon",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/bacon-egg-muffin-cups/",cost:"$6-9"},
  {id:11,name:"Greek Omelette Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-omelette-casserole/",cost:"$6-8"},
  {id:12,name:"Egg Muffins with Red Pepper & Spinach",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/egg-muffins-red-pepper-spinach/",cost:"$4-6"},
  {id:13,name:"Big Chicken Caesar Salad",category:"Salad",protein:"Chicken",method:"Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/456-cal-big-as-chicken-caesar-salad/",cost:"$12-15"},
  {id:14,name:"Meal Prep Taco Salad",category:"Salad",protein:"Ground Beef/Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-taco-salad/",cost:"$10-13"},
  {id:15,name:"Mediterranean Tuna Pasta Salad",category:"Salad",protein:"Tuna",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/mediterranean-tuna-pasta-salad/",cost:"$7-10"},
  {id:16,name:"Chicken Shawarma Salad",category:"Salad",protein:"Chicken",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-shawarma-salad/",cost:"$10-13"},
  {id:17,name:"Ground Taco Meat with Cauliflower Rice",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"Clean & Delicious",url:"https://cleananddelicious.com/ground-taco-meat-with-cauliflower-rice/",cost:"$10-13"},
  {id:18,name:"Cauliflower Chicken Fried Rice",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/326-cal-cauliflower-chicken-fried-rice/",cost:"$10-13"},
  {id:19,name:"XL Grinder Salad Wraps",category:"Lunch/Dinner",protein:"Deli Chicken",method:"No Cook",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/516-cal-xl-grinder-salad-wraps/",cost:"$12-15"},
  {id:20,name:"Chicken Tenders & Fries",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/518-cal-chicken-tenders-the-easiest-fries-meal/",cost:"$10-13"},
  {id:21,name:"Slow Cooker Beef Barbacoa",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Taste of Home",url:"https://www.tasteofhome.com/recipes/slow-cooker-beef-barbacoa/",cost:"$15-20"},
  {id:22,name:"Chickpea and Chorizo Taco Soup",category:"Lunch/Dinner",protein:"Chorizo",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:23,name:"Slow Cooker Southwest Sweet Potato Chili",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:24,name:"Creamy Taco Soup",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$9-12"},
  {id:25,name:"Slow Cooker Chicken Fajitas",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:26,name:"Copycat KFC Famous Bowls",category:"Lunch/Dinner",protein:"Chicken",method:"Oven / Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:27,name:"Tex-Mex Roasted Veggie Quesadillas",category:"Lunch/Dinner",protein:"Vegetarian",method:"Oven",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$7-10"},
  {id:28,name:"Copycat Bacon Cheeseburger Hamburger Helper",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:29,name:"Taco Salad with Pan Fried Tortilla Strips",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-12"},
  {id:30,name:"Honey Sriracha Shrimp Fried Cauliflower Rice",category:"Lunch/Dinner",protein:"Shrimp",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$12-15"},
  {id:31,name:"Microwavable BBQ Chicken Pasta Bake",category:"Lunch/Dinner",protein:"Chicken",method:"Microwave",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:32,name:"Pan Roasted Corn & Black Bean Burrito Bowls",category:"Lunch/Dinner",protein:"Vegetarian",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$6-9"},
  {id:33,name:"Slow Cooker Pesto Chicken Pasta",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:34,name:"Slow Cooker Sesame Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:35,name:"Slow Cooker Chicken Shawarma",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:36,name:"Slow Cooker Salsa Verde Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$8-11"},
  {id:37,name:"Slow Cooker BBQ Wings",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-14"},
  {id:38,name:"BBQ Pulled Pork Lettuce Wraps",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$12-16"},
  {id:39,name:"Crockpot Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:40,name:"Slow Cooker Turkey Meatball Subs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:41,name:"Chipotle Chicken Tacos",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:42,name:"Slow Cooker Chicken Adobo",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$9-12"},
  {id:43,name:"Slow Cooker Meatball Soup",category:"Lunch/Dinner",protein:"Beef/Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:44,name:"Crockpot Pork Carnitas",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$13-17"},
  {id:45,name:"Slow Cooker Thai Chicken Lettuce Wraps",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:46,name:"Slow Cooker Chicken Tortilla Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:47,name:"Slow Cooker Beef Carnitas",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$14-18"},
  {id:48,name:"Korean Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/korean-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:49,name:"Turkey Taco Skillet",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/turkey-taco-skillet/",cost:"$9-12"},
  {id:50,name:"Firecracker Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/firecracker-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:51,name:"Chicken Broccoli Rice Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-broccoli-rice-casserole/",cost:"$10-13"},
  {id:52,name:"Greek Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-turkey-meatballs/",cost:"$9-12"},
  {id:53,name:"Greek Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-chicken-casserole/",cost:"$11-14"},
  {id:54,name:"Sheet Pan Chicken and Broccoli",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-chicken-and-broccoli/",cost:"$9-12"},
  {id:55,name:"Spaghetti Squash Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spaghetti-squash-casserole/",cost:"$10-13"},
  {id:56,name:"Spinach Artichoke Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-artichoke-chicken-casserole/",cost:"$11-14"},
  {id:57,name:"Shredded Beef Tacos",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Kay Nutrition",url:"https://kaynutrition.com/shredded-beef-tacos/",cost:"$14-18"},
  {id:58,name:"Beef Shawarma",category:"Lunch/Dinner",protein:"Beef",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-shawarma/",cost:"$13-16"},
  {id:59,name:"Ground Turkey Meal Prep Bowls",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/ground-turkey-meal-prep-bowls/",cost:"$9-12"},
  {id:60,name:"Stuffed Pepper Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/stuffed-pepper-casserole/",cost:"$10-13"},
  {id:61,name:"Beef and Mushroom Stew",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-and-mushroom-stew/",cost:"$13-16"},
  {id:62,name:"Sheet Pan Steak Fajitas",category:"Lunch/Dinner",protein:"Beef",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-steak-fajitas/",cost:"$14-18"},
  {id:63,name:"Sheet Pan Bruschetta Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-bruschetta-chicken/",cost:"$10-13"},
  {id:64,name:"Chicken Burrito Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-burrito-casserole/",cost:"$10-13"},
  {id:65,name:"Meal Prep Instant Noodle Cups",category:"Lunch/Dinner",protein:"Chicken",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-instant-noodle-cups/",cost:"$8-11"},
  {id:66,name:"Air Fryer Broccoli",category:"Side",protein:"None",method:"Air Fryer",source:"Eating Bird Food",url:"https://www.eatingbirdfood.com/air-fryer-broccoli/",cost:"$2-4"},
  {id:67,name:"Honey Mustard Pan Roasted Brussels Sprouts",category:"Side",protein:"None",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$3-5"},
  {id:68,name:"Crock Pot Salsa Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Budget Bytes",url:"https://www.budgetbytes.com/crock-pot-salsa-chicken/",cost:"$7-10"},
  {id:69,name:"Crockpot Swedish Meatballs",category:"Lunch/Dinner",protein:"Beef (Frozen Meatballs)",method:"Slow Cooker",source:"Cooking in the Midwest",url:"https://cookinginthemidwest.com/blog/crockpot-swedish-meatballs/",cost:"$11-14"},
  {id:70,name:"Crockpot Chicken Parmesan Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Eating on a Dime",url:"https://www.eatingonadime.com/crock-pot-creamy-chicken-parmesan-soup/",cost:"$12-15"},
  {id:71,name:"Slow Cooker Breakfast Casserole",category:"Breakfast",protein:"Eggs",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/slow-cooker-breakfast-casserole/",cost:"$6-9"},
  {id:72,name:"Veggie-Loaded Egg Scramble (Awaken)",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:73,name:"Protein Yogurt Bowl (Awaken)",category:"Breakfast",protein:"Protein Powder",method:"No Cook",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$3-5"},
  {id:74,name:"Cauliflower Egg Fried Rice Bowl (Awaken)",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:75,name:"Savory Egg Muffin Veggie Bake (Awaken)",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:76,name:"Slow Cooker Chocolate Caramel Pecan Clusters",category:"Dessert",protein:"None",method:"Slow Cooker",source:"Food Dolls",url:"https://www.fooddolls.com/caramel-pecan-clusters/",cost:"$8-12"}
];

const CC={"Breakfast":{bg:"#FFF3E0",text:"#E65100",dot:"#FF9800"},"Lunch/Dinner":{bg:"#E8F5E9",text:"#1B5E20",dot:"#4CAF50"},"Salad":{bg:"#E3F2FD",text:"#0D47A1",dot:"#2196F3"},"Side":{bg:"#F3E5F5",text:"#4A148C",dot:"#9C27B0"},"Dessert":{bg:"#FCE4EC",text:"#880E4F",dot:"#E91E63"}};
const MI={"Slow Cooker":"ü•ò","Oven":"üî•","Stovetop":"üç≥","Air Fryer":"üí®","No Cook":"ü•ó","Microwave":"üì°","Stovetop / Air Fryer":"üç≥","Stovetop / Oven":"üç≥","Oven / Stovetop":"üî•","Slow Cooker / Stovetop":"ü•ò"};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let recipes = [...BASE];  // replaced by DB data in loadData()
let details = {};
let checked = new Set();
let viewMode = "table";
let servingsMap = {};  // recipe id -> current servings (for scaling)

function getDefaultServings(id) {
  if (details[id]?.servings) return details[id].servings;
  return 4;
}
function getServings(id) {
  if (servingsMap[id] === undefined) servingsMap[id] = getDefaultServings(id);
  return servingsMap[id];
}
function changeServings(e, id, delta) {
  e.stopPropagation();
  servingsMap[id] = Math.max(1, getServings(id) + delta);
  const sv = getServings(id);

  // Update the servings counter in the row without re-rendering everything
  const wrap = document.getElementById("wrap-" + id);
  if (wrap) {
    const counter = wrap.querySelector(".srv-count-" + id);
    if (counter) counter.textContent = sv;
  }

  // Re-render ingredient list in the open detail panel
  const dp = document.getElementById("dp-" + id);
  if (dp && dp.parentElement.classList.contains("open") && details[id]) {
    const ingList = dp.querySelector(".ing-list");
    if (ingList) {
      const def = getDefaultServings(id);
      const mult = def > 0 ? sv / def : 1;
      ingList.innerHTML = details[id].ingredients.map(ing => {
        const scaled = mult !== 1 ? scaleIngredientText(ing, mult) : ing;
        const changed = scaled !== ing;
        return `<li${changed ? ' style="color:#a8d8a8"' : ""}>${esc(scaled)}</li>`;
      }).join("");
    }
  }
}
let fCat="", fProt="", fMeth="", sort="category", sortDir=1, q="";

function setSort(col) {
  if (sort === col) sortDir *= -1;
  else { sort = col; sortDir = 1; }
  document.getElementById("sortBy").value = sort;
  // Update header indicators
  ["name","category","method","source","cost"].forEach(c => {
    const el = document.getElementById("shdr-" + c);
    if (!el) return;
    el.className = sort === c ? (sortDir === 1 ? "active" : "active asc") : "";
  });
  render();
}
let matchScores = {}; // id -> {score, match, note}
let matchActive = false;
let pendingDetails = null;

async function api(path, method="GET", body=null) {
  const hdrs = await Auth.headers();
  if (!hdrs) { Auth.signOut(); throw new Error("Not authenticated"); }
  const r = await fetch(`/.netlify/functions/${path}`, {
    method,
    headers: hdrs,
    body: body ? JSON.stringify(body) : undefined
  });
  return r.json();
}

async function showApp() {
  // Auth guard
  const ok = await Auth.require();
  if (!ok) return;

  // Populate user menu
  const user = Auth.getUser();
  if (user?.email) {
    const avatar = document.getElementById("user-avatar");
    const short = document.getElementById("user-email-short");
    const full = document.getElementById("user-email-full");
    if (avatar) avatar.textContent = user.email[0].toUpperCase();
    if (short) short.textContent = user.email.split("@")[0];
    if (full) full.textContent = user.email;
  }

  await loadData();
  buildSelects();
  render();
}

async function loadData() {
  try {
    const [recipesRes, detailsRes] = await Promise.all([
      api("extra-recipes"),  // now points to full recipes table
      api("recipe-details")
    ]);
    // Always replace with DB data, even if empty
    recipes = Array.isArray(recipesRes) ? recipesRes : [];
    archivedRecipes.clear();
    recipes.forEach(r => { if (r.archived) archivedRecipes.add(r.id); });
    if (Array.isArray(detailsRes)) {
      detailsRes.forEach(d => { details[d.recipe_id] = { ingredients: d.ingredients, steps: d.steps }; });
    }
  } catch(e) { console.error("Load error", e); }
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function getFiltered() {
  let list = recipes.filter(r => {
    const s = q.toLowerCase();
    const d = details[r.id];
    const ingText = (d?.ingredients||[]).join(' ').toLowerCase();
    const stepText = (d?.steps||[]).join(' ').toLowerCase();
    return (!s || r.name.toLowerCase().includes(s) || r.protein.toLowerCase().includes(s) || r.source.toLowerCase().includes(s) || ingText.includes(s) || stepText.includes(s))
      && (!fCat || r.category === fCat)
      && (!fProt || r.protein === fProt)
      && (!fMeth || r.method === fMeth)
      && (!matchActive || matchScores[r.id]);
  });
  list.sort((a,b) => {
    let v = 0;
    if (sort==="match") return (matchScores[b.id]?.score||0) - (matchScores[a.id]?.score||0);
    if (sort==="category") v = a.category.localeCompare(b.category)||a.name.localeCompare(b.name);
    else if (sort==="name") v = a.name.localeCompare(b.name);
    else if (sort==="protein") v = a.protein.localeCompare(b.protein);
    else if (sort==="method") v = a.method.localeCompare(b.method);
    else if (sort==="source") v = a.source.localeCompare(b.source);
    else if (sort==="cost") v = parseInt(a.cost||0)-parseInt(b.cost||0);
    return v * sortDir;
  });
  return list;
}

function buildPills() {
  const counts={};
  recipes.forEach(r=>counts[r.category]=(counts[r.category]||0)+1);
  document.getElementById("pills").innerHTML=Object.entries(counts).map(([cat,n])=>{
    const c=CC[cat]||{bg:"#333",text:"#ccc",dot:"#888"};
    return`<span class="pill${fCat===cat?" active":""}" data-cat="${cat}" style="--bg:${c.bg};--text:${c.text};--dot:${c.dot}"><span class="dot"></span>${cat} ¬∑ ${n}</span>`;
  }).join("");
  document.getElementById("pills").querySelectorAll(".pill").forEach(p=>p.addEventListener("click",()=>{fCat=fCat===p.dataset.cat?"":p.dataset.cat;render();}));
}

function buildSelects() {
  const prots=[...new Set(recipes.map(r=>r.protein))].sort();
  const meths=[...new Set(recipes.map(r=>r.method))].sort();
  const pc=document.getElementById("filterProt"),mc=document.getElementById("filterMeth");
  const pv=pc.value,mv=mc.value;
  pc.innerHTML=`<option value="">All Proteins</option>`+prots.map(p=>`<option${p===pv?" selected":""}>${p}</option>`).join("");
  mc.innerHTML=`<option value="">All Methods</option>`+meths.map(m=>`<option${m===mv?" selected":""}>${m}</option>`).join("");
}

function setView(mode) {
  viewMode = mode;
  document.getElementById("btn-table").classList.toggle("active", mode === "table");
  document.getElementById("btn-grid").classList.toggle("active", mode === "grid");
  document.getElementById("table-view").style.display = mode === "table" ? "" : "none";
  document.getElementById("grid-view").style.display = mode === "grid" ? "" : "none";
  render();
}

function renderGrid(list) {
  const CC_CAT = Object.keys(CC);
  const container = document.getElementById("grid-view");
  if (!list.length) { container.innerHTML = '<div style="color:#555;font-size:14px;padding:40px 0;text-align:center">No recipes match.</div>'; return; }

  container.innerHTML = list.map(r => {
    const hd = !!details[r.id];
    const c = CC[r.category] || { bg:"#333", text:"#ccc", dot:"#888" };
    const icon = MI[r.method] || "üç¥";
    const isChecked = checked.has(r.id);
    const isArchived = archivedRecipes.has(r.id);
    if (isArchived) return "";

    const imgHtml = r.image_url
      ? `<img class="card-img" src="${r.image_url}" alt="${esc(r.name)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
<div class="card-img-placeholder" style="display:none">${icon}</div>`
      : `<div class="card-img-placeholder">${icon}</div>`;

    return `<div class="recipe-card${hd?"":" no-details"}" onclick="cardClick(event,${r.id})">
      <input type="checkbox" class="card-check" ${isChecked?"checked":""} onclick="chk(event,${r.id})">
      ${imgHtml}
      <div class="card-body">
        <div class="card-name${hd?"":" dim"}">${esc(r.name)}</div>
        <div class="card-meta">
          <span style="font-size:11px;color:${c.text};background:${c.bg};padding:2px 7px;border-radius:10px;font-family:monospace">${r.category}</span>
          ${dynamicCostStr(r) ? `<span class="card-cost">${dynamicCostStr(r)}</span>` : ""}
        </div>
      </div>
    </div>`;
  }).join("");
}

function cardClick(event, id) {
  if (event.target.tagName === "INPUT") return;
  openRecipeModal(id);
}

function openRecipeModal(id) {
  const r = recipes.find(x => x.id === id);
  if (!r) return;
  const d = details[id];
  const c = CC[r.category] || { bg:"#333", text:"#ccc", dot:"#888" };

  document.getElementById("rmodal-name").textContent = r.name;

  // Image
  const img = document.getElementById("rmodal-img");
  if (r.image_url) { img.src = r.image_url; img.alt = r.name; img.style.display = "block"; }
  else img.style.display = "none";

  // Meta badges
  document.getElementById("rmodal-meta").innerHTML = `
    <span style="font-size:12px;background:${c.bg};color:${c.text};padding:2px 10px;border-radius:10px;font-family:monospace">${r.category}</span>
    <span style="font-size:12px;color:#9a9fae">${MI[r.method]||"üç¥"} ${r.method}</span>
    ${dynamicCostStr(r) ? `<span style="font-size:12px;color:#7bcf8e;font-family:monospace;font-weight:600">${dynamicCostStr(r)}</span>` : ""}
    ${r.servings ? `<span style="font-size:12px;color:#556;font-family:monospace">${r.servings} servings</span>` : ""}
  `;

  // Reader + source links
  const readerBtn = document.getElementById("rmodal-reader");
  const sourceBtn = document.getElementById("rmodal-source");
  if (r.url) {
    readerBtn.href = "/recipe.html?id=" + r.id;
    readerBtn.style.display = "inline-flex";
    sourceBtn.href = r.url; sourceBtn.style.display = "inline-flex";
  } else {
    readerBtn.style.display = "none"; sourceBtn.style.display = "none";
  }

  // Ingredients + steps
  const ingList = document.getElementById("rmodal-ingredients");
  const stepList = document.getElementById("rmodal-steps");
  if (d?.ingredients?.length) {
    ingList.innerHTML = d.ingredients.map(i => `<li>${esc(i)}</li>`).join("");
  } else {
    ingList.innerHTML = `<li style="color:#445;font-family:monospace">No ingredients saved yet</li>`;
  }
  if (d?.steps?.length) {
    stepList.innerHTML = d.steps.map(s => `<li>${esc(s)}</li>`).join("");
  } else {
    stepList.innerHTML = `<li style="color:#445;font-family:monospace">No steps saved yet</li>`;
  }

  document.getElementById("recipe-modal").classList.add("show");
  document.body.style.overflow = "hidden";
}

function closeRecipeModal() {
  document.getElementById("recipe-modal").classList.remove("show");
  document.body.style.overflow = "";
}
document.addEventListener("keydown", e => { if (e.key === "Escape") closeRecipeModal(); });

// Backfill images for recipes that have a URL but no image
async function backfillImages() {
  const toFetch = recipes.filter(r => r.url && !r.image_url);
  if (!toFetch.length) { alert("All recipes with URLs already have images!"); return; }
  
  const btn = document.getElementById("backfill-btn");
  btn.disabled = true;
  btn.textContent = `Fetching 0/${toFetch.length}...`;

  let done = 0;
  for (const r of toFetch) {
    try {
      const proxyUrl = "https://corsproxy.io/?url=" + encodeURIComponent(r.url);
      const res = await fetch(proxyUrl);
      const html = await res.text();
      const parsed = parseRecipeHTML(html, r.url);
      if (parsed.image) {
        await api("extra-recipes", "POST", { id: r.id, image_url: parsed.image });
        r.image_url = parsed.image;
      }
    } catch(e) {}
    done++;
    btn.textContent = `Fetching ${done}/${toFetch.length}...`;
    await new Promise(res => setTimeout(res, 500)); // rate limit
  }
  btn.textContent = "Done!";
  render();
  setTimeout(() => { btn.disabled = false; btn.textContent = "üñº Backfill Images"; }, 2000);
}

function render() {
  buildPills();
  const list = getFiltered();
  document.getElementById("total-badge").textContent = recipes.length+" recipes";
  const hasFilter = fCat||fProt||fMeth||q||matchActive;
  document.getElementById("count").innerHTML = `Showing ${list.length} of ${recipes.length} recipes${hasFilter?'<span class="clear-link" onclick="clearAll()">Clear</span>':""}`;
  const gb = document.getElementById("grocery-btn");
  gb.style.display = checked.size > 0 ? "inline-flex" : "none";
  document.getElementById("grocery-count").textContent = checked.size;

  // Render grid or table
  if (viewMode === "grid") { renderGrid(list); return; }

  // Match column always visible
  const activeList = list.filter(r => !archivedRecipes.has(r.id));
  const archivedList = recipes.filter(r => archivedRecipes.has(r.id));

  if (!activeList.length && !archivedList.length) { document.getElementById("rows").innerHTML='<div class="empty">No recipes match.</div>'; return; }

  function rowHTML(r, isArchived) {
    const c = CC[r.category]||{bg:"#333",text:"#ccc",dot:"#888"};
    const hd = !!details[r.id];
    const ms = matchScores[r.id];
    return `<div class="trow-wrap" id="wrap-${r.id}">
  <div class="trow${hd?" has-details":" no-details"}" onclick="rowClick(event,${r.id})" style="${isArchived?"opacity:0.4;pointer-events:none;":""}">
    <div style="display:flex;align-items:center;justify-content:center"><input type="checkbox"${checked.has(r.id)?" checked":""} onclick="chk(event,${r.id})"></div>
    <div class="recipe-name">
      <span class="expand-icon">‚ñ∂</span>
      <span class="recipe-name-text" onclick="event.stopPropagation();openRecipeModal(${r.id})" style="cursor:pointer" title="Click to view recipe">${esc(r.name)}</span>
      ${r.url ? `<a href="${r.url}" target="_blank" class="link-btn" onclick="event.stopPropagation()" title="Open recipe" style="flex-shrink:0;width:22px;height:22px;font-size:10px;margin-left:4px">‚Üó</a>` : ""}
      <div class="recipe-mobile-meta" style="display:none">${r.category} ¬∑ ${MI[r.method]||"üç¥"} ${r.method}</div>
    </div>
    <div><span class="badge" style="background:${c.bg};color:${c.text}"><span class="dot" style="background:${c.dot}"></span>${r.category}</span></div>
    <div class="meta">${MI[r.method]||"üç¥"} ${r.method}</div>

    <div class="cost" style="color:${dynamicCostStr(r) ? '#7bcf8e' : '#556'}">${dynamicCostStr(r) || ''}</div>
    <div style="display:flex;align-items:center;justify-content:center">
      ${ms ? `<span class="match-badge ${ms.match==='full'?'match-full':'match-partial'}" title="${esc(ms.note)}">${ms.score}%</span>` : (matchActive ? `<span style="font-size:11px;color:#333;font-family:monospace">‚Äî</span>` : "")}
    </div>
    <div style="display:flex;align-items:center;gap:5px;justify-content:center">
      <button onclick="changeServings(event,${r.id},-1)" style="background:#1e2330;border:1px solid #2a2f3e;color:#aaa;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:13px;line-height:1;padding:0">‚àí</button>
      <span class="srv-count-${r.id}" style="font-size:13px;color:#c8d0e0;font-family:monospace;min-width:18px;text-align:center">${getServings(r.id)}</span>
      <button onclick="changeServings(event,${r.id},+1)" style="background:#1e2330;border:1px solid #2a2f3e;color:#aaa;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:13px;line-height:1;padding:0">+</button>
    </div>
    <div style="pointer-events:all;display:flex;align-items:center;justify-content:center">
      ${isArchived
        ? `<button onclick="event.stopPropagation();unarchiveRecipe(${r.id})" title="Restore"
            style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:#1e2330;border:1px solid #2a4a2a;color:#4a8a4a;font-size:13px;cursor:pointer"
            onmouseover="this.style.background='#1a3a1a'" onmouseout="this.style.background='#1e2330'">‚Ü©</button>`
        : `<button onclick="event.stopPropagation();archiveRecipe(${r.id})" title="Archive"
            style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:transparent;border:none;color:#3a3a4a;font-size:16px;font-weight:700;cursor:pointer;line-height:1"
            onmouseover="this.style.color='#cc4444'" onmouseout="this.style.color='#3a3a4a'">‚úï</button>
          <button onclick="event.stopPropagation();openEditModal(${r.id})" title="Edit recipe"
            style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:transparent;border:none;color:#3a3a4a;font-size:13px;cursor:pointer"
            onmouseover="this.style.color='#6e8efb'" onmouseout="this.style.color='#3a3a4a'">‚úè</button>`
      }
    </div>
  </div>
  <div class="detail-panel" id="dp-${r.id}">
    ${hd ? detailHTML(r) : fetchPromptHTML(r)}
    ${ms ? `<div style="font-size:12px;color:#9a9fae;margin-top:12px;padding:8px;background:#1a1f2e;border-radius:6px">ü•¶ <strong>Matched:</strong> ${esc(ms.note)}</div>` : ""}
  </div>
</div>`;
  }

  let html = activeList.map(r => rowHTML(r, false)).join("");

  if (archivedList.length) {
    html += `<div style="border-top:2px solid #1e2330">
      <div id="archived-toggle" onclick="toggleArchived()"
        style="padding:11px 14px;cursor:pointer;font-size:11px;font-family:monospace;color:#445;display:flex;align-items:center;gap:8px;user-select:none"
        onmouseover="this.style.color='#778'" onmouseout="this.style.color='#445'">
        <span id="archived-arrow" style="font-size:9px;display:inline-block;transition:transform .2s">‚ñ∂</span>
        üì¶ Archived ¬∑ ${archivedList.length} recipe${archivedList.length>1?"s":""}
        <span style="color:#334;font-size:10px">click to expand</span>
      </div>
      <div id="archived-rows" style="display:none">
        ${archivedList.map(r => rowHTML(r, true)).join("")}
      </div>
    </div>`;
  }

  document.getElementById("rows").innerHTML = html;
}

function toggleArchived() {
  const rows = document.getElementById("archived-rows");
  const arrow = document.getElementById("archived-arrow");
  if (!rows) return;
  const open = rows.style.display === "none";
  rows.style.display = open ? "block" : "none";
  arrow.style.transform = open ? "rotate(90deg)" : "";
}

function archiveRecipe(id) {
  if (!confirm(`Archive "${recipes.find(r=>r.id===id)?.name}"?\nIt will be hidden but you can restore it anytime.`)) return;
  checked.delete(id);
  archivedRecipes.add(id);
  api("extra-recipes", "POST", { id, archived: true }).catch(() => {});
  render();
}

function unarchiveRecipe(id) {
  archivedRecipes.delete(id);
  api("extra-recipes", "POST", { id, archived: false }).catch(() => {});
  render();
}

function detailHTML(r) {
  const d = details[r.id];
  const sv = getServings(r.id);
  const def = getDefaultServings(r.id);
  const mult = def > 0 ? sv / def : 1;
  const scaledNote = mult !== 1 ? `<span style="font-size:10px;color:#6a9a6a;font-family:monospace;margin-left:6px">(scaled for ${sv})</span>` : "";
  return `<div class="detail-inner">
    <div class="detail-section">
      <h3>Ingredients ${scaledNote}</h3>
      <ul class="ing-list">${d.ingredients.map(ing => {
        const scaled = mult !== 1 ? scaleIngredientText(ing, mult) : ing;
        const changed = scaled !== ing;
        return `<li${changed ? ' style="color:#a8d8a8"' : ""}>${esc(scaled)}</li>`;
      }).join("")}</ul>
    </div>
    <div class="detail-section"><h3>Instructions</h3><ol class="steps-list">${d.steps.map(s=>`<li>${esc(s)}</li>`).join("")}</ol></div>
  </div>`;
}

function fetchPromptHTML(r) {
  return `<div style="padding:14px 0"><p style="font-size:12px;color:#445;font-family:monospace">No ingredients saved yet ‚Äî paste a URL above and click Fetch, or add a URL to this recipe and re-open it.</p></div>`;
}

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

// ‚îÄ‚îÄ Interactions ‚îÄ‚îÄ
function rowClick(e,id){if(e.target.type==="checkbox"||e.target.tagName==="A")return;document.getElementById("wrap-"+id)?.classList.toggle("open");}
function toggleUserMenu() {
  const dd = document.getElementById("user-dropdown");
  dd.style.display = dd.style.display === "none" ? "block" : "none";
}
document.addEventListener("click", e => {
  if (!e.target.closest("#user-menu")) {
    const dd = document.getElementById("user-dropdown");
    if (dd) dd.style.display = "none";
  }
});

function chk(e,id){e.stopPropagation();e.target.checked?checked.add(id):checked.delete(id);document.getElementById("grocery-btn").style.display=checked.size>0?"inline-flex":"none";document.getElementById("grocery-count").textContent=checked.size;localStorage.setItem("recipe-cart",JSON.stringify([...checked]));}
function onSearch(v){q=v;render();}
function clearSearch(){document.getElementById("search").value="";q="";render();}
function clearAll(){fCat="";fProt="";fMeth="";q="";matchActive=false;matchScores={};fridgeSelected.clear();renderFridgeChips();document.getElementById("search").value="";document.getElementById("filterProt").value="";document.getElementById("filterMeth").value="";document.getElementById("fridge-search").value="";document.getElementById("fridge-info").textContent="";render();}
function toggleFridge(){document.getElementById("fridge-bar").classList.toggle("show");}
function toggleAdd(){document.getElementById("add-panel").classList.toggle("show");}

async function delDetails(id) {
  if (!confirm("Remove saved details?")) return;
  await api(`recipe-details?id=${id}`, "DELETE");
  delete details[id];
  render();
}

// ‚îÄ‚îÄ Add recipe ‚îÄ‚îÄ
let _lastFetchedUrl = "";

// Parse recipe HTML client-side (same logic as server but runs in browser)
function parseRecipeHTML(html, url) {
  const result = { name: null, ingredients: [], steps: [], servings: null };


  // Decode HTML entities in ingredient/step strings
  function decodeEntities(s) {
    return s.replace(/&frac12;/g,"¬Ω").replace(/&frac14;/g,"¬º").replace(/&frac34;/g,"¬æ")
            .replace(/&frac13;/g,"‚Öì").replace(/&frac23;/g,"‚Öî").replace(/&amp;/g,"&")
            .replace(/&nbsp;/g," ").replace(/&#(\d+);/g,(_,n)=>String.fromCharCode(n))
            .replace(/&#x([0-9a-f]+);/gi,(_,h)=>String.fromCharCode(parseInt(h,16)));
  }

  // Strip /print/NNNNN/ from URL before using
  const cleanUrl = url.replace(/\/print\/\d+\/?$/, "/").replace(/\/print\/?$/, "/");

  // 1. JSON-LD
  const scripts = [...html.matchAll(/<script[^>]*type="application\/ld\+json"[^>]*>([\s\S]*?)<\/script>/gi)];
  for (const s of scripts) {
    try {
      let data = JSON.parse(s[1].trim());
      if (data["@graph"]) data = data["@graph"].find(i => i["@type"] === "Recipe") || {};
      if (Array.isArray(data)) data = data.find(i => i["@type"] === "Recipe") || {};
      if (data["@type"] !== "Recipe") continue;
      if (data.name) result.name = data.name.trim();
      if (data.image) result.image = Array.isArray(data.image) ? data.image[0] : (typeof data.image === "object" ? data.image.url : data.image);
      if (Array.isArray(data.recipeIngredient))
        result.ingredients = data.recipeIngredient.map(i => decodeEntities(i.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim())).filter(Boolean);
      if (Array.isArray(data.recipeInstructions))
        result.steps = data.recipeInstructions.map(s => {
          if (typeof s === "string") return s.replace(/<[^>]+>/g, "").trim();
          return (s.text || s.name || "").replace(/<[^>]+>/g, "").trim();
        }).filter(s => s.length > 3);
      const yieldRaw = data.recipeYield;
      if (yieldRaw) {
        const num = parseInt(String(Array.isArray(yieldRaw) ? yieldRaw[0] : yieldRaw).match(/\d+/)?.[0]);
        if (num) result.servings = num;
      }
      if (result.ingredients.length) return result;
    } catch(e) {}
  }

  // 2. WPRM embedded JSON (most reliable ‚Äî has clean structured data)
  if (!result.ingredients.length) {
    const wprmJson = html.match(/window\.wprm_recipes\s*=\s*({[\s\S]*?})\s*<\/script>/);
    if (wprmJson) {
      try {
        const recipes = JSON.parse(wprmJson[1]);
        const recipe = Object.values(recipes)[0];
        if (recipe?.ingredients?.length) {
          result.ingredients = recipe.ingredients.map(i => {
            const parts = [i.amount, i.unit, i.name, i.notes ? `(${i.notes.trim()})` : ""].filter(Boolean);
            return parts.join(" ").replace(/\s+/g, " ").trim();
          });
          if (recipe.originalServingsParsed) result.servings = recipe.originalServingsParsed;
          if (recipe.name) result.name = result.name || recipe.name;
        }
      } catch(e) {}
    }
  }

  // 2b. WPRM HTML fallback (flexible class matching)
  if (!result.ingredients.length) {
    const ingBlocks = [...html.matchAll(/class="wprm-recipe-ingredient["\s][^>]*>([\s\S]*?)<\/li>/g)];
    ingBlocks.forEach(m => {
      const amt   = (m[1].match(/wprm-recipe-ingredient-amount[^>]*>([^<]+)/) || [])[1] || "";
      const unit  = (m[1].match(/wprm-recipe-ingredient-unit[^>]*>([^<]+)/)   || [])[1] || "";
      const name  = (m[1].match(/wprm-recipe-ingredient-name[^>]*>([^<\(]+)/) || [])[1] || "";
      const notes = (m[1].match(/wprm-recipe-ingredient-notes[^>]*>([^<]+)/)  || [])[1] || "";
      const full  = [amt, unit, name.trim(), notes ? `(${notes.trim()})` : ""].filter(Boolean).join(" ").trim();
      if (full) result.ingredients.push(decodeEntities(full));
    });
  }

  // 3. Generic: find largest ingredient-like <ul>
  if (!result.ingredients.length) {
    const MEAS = /(\d+|cup|tsp|tbsp|teaspoon|tablespoon|pound|lb|oz|ounce|gram|clove|bunch|pinch|can)/i;
    const allUls = [...html.matchAll(/<ul[^>]*>([\s\S]*?)<\/ul>/g)];
    let best = null, bestScore = 0;
    for (const ul of allUls) {
      const items = [...ul[1].matchAll(/<li[^>]*>([\s\S]*?)<\/li>/g)]
        .map(m => m[1].replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim()).filter(t => t.length > 2);
      const score = items.filter(t => MEAS.test(t)).length;
      if (score > bestScore && items.length >= 3) { best = items; bestScore = score; }
    }
    if (best) result.ingredients = best;
  }

  // 4. Steps: first <ol> with enough items
  if (!result.steps.length) {
    const allOls = [...html.matchAll(/<ol[^>]*>([\s\S]*?)<\/ol>/g)];
    let best = null;
    for (const ol of allOls) {
      const items = [...ol[1].matchAll(/<li[^>]*>([\s\S]*?)<\/li>/g)]
        .map(m => m[1].replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim()).filter(t => t.length > 10);
      if (!best || items.length > best.length) best = items;
    }
    if (best && best.length >= 2) result.steps = best;
  }

  // 5. Plain-text fallback: strip all HTML and parse sections by heading
  if (!result.ingredients.length) {
    const plain = html.replace(/<[^>]+>/g, " ").replace(/&amp;/g, "&").replace(/&nbsp;/g, " ");
    const lines = plain.split(/\r?\n|\. (?=[A-Z])/).map(l => l.trim()).filter(Boolean);
    let inIng = false, inStep = false;
    for (const line of lines) {
      if (/^ingredient/i.test(line)) { inIng = true; inStep = false; continue; }
      if (/^(instruction|direction|method|how to make)/i.test(line)) { inIng = false; inStep = true; continue; }
      if (/^(note|nutrition|gluten|copyright|powered)/i.test(line)) { inIng = false; inStep = false; continue; }
      if (inIng) {
        const c = line.replace(/^[*\-\xB7\d]+[.)]?\s*/, "").trim();
        if (c.length > 2) result.ingredients.push(decodeEntities(c));
      } else if (inStep && !result.steps.length) {
        const c = line.replace(/^\d+[.)\s]+/, "").trim();
        if (c.length > 10) result.steps.push(c);
      }
    }
    if (!result.servings) {
      const svLine = lines.find(l => /servings?/i.test(l));
      if (svLine) { const m = svLine.match(/(\d+)/); if (m) result.servings = parseInt(m[1]); }
    }
  }

    // Name fallback
  if (!result.name) {
    const h = html.match(/<h[12][^>]*>([^<]+)<\/h[12]>/);
    if (h) result.name = h[1].trim();
    else {
      const h1 = html.match(/<h1[^>]*>([^<]+)<\/h1>/);
      if (h1) result.name = h1[1].trim();
    }
  }

  // Image: try JSON-LD image first, then og:image, then first large img
  if (!result.image) {
    const ogImg = html.match(/<meta[^>]+property="og:image"[^>]+content="([^"]+)"/);
    if (ogImg) result.image = ogImg[1];
    else {
      const twitterImg = html.match(/<meta[^>]+name="twitter:image"[^>]+content="([^"]+)"/);
      if (twitterImg) result.image = twitterImg[1];
    }
  }

  return result;
}

function guessSourceFromUrl(url) {
  try {
    const host = new URL(url).hostname.replace("www.", "");
    const map = {
      "hungryhobby.net": "Hungry Hobby", "kaynutrition.com": "Kay Nutrition",
      "budgetbytes.com": "Budget Bytes", "eatingonadime.com": "Eating on a Dime",
      "cleananddelicious.com": "Clean & Delicious", "tasteofhome.com": "Taste of Home",
      "cookieandkate.com": "Cookie and Kate", "minimalistbaker.com": "Minimalist Baker",
      "skinnytaste.com": "Skinnytaste", "pinchofyum.com": "Pinch of Yum",
      "halfbakedharvest.com": "Half Baked Harvest", "allrecipes.com": "AllRecipes",
      "food52.com": "Food52", "simplyrecipes.com": "Simply Recipes",
      "recipetineats.com": "RecipeTin Eats", "delish.com": "Delish",
      "seriouseats.com": "Serious Eats", "thekitchn.com": "The Kitchn",
      "sisufitness.com": "SISU Fitness", "awaken180weightloss.com": "Awaken180",
      "flexibledietinglifestyle.com": "Flexible Dieting Lifestyle",
      "eatingbirdfood.com": "Eating Bird Food",
    };
    return map[host] || host.split(".")[0].replace(/-/g, " ").replace(/\w/g, c => c.toUpperCase());
  } catch(e) { return ""; }
}

async function autoFetchRecipe(url) {
  url = url.trim();
  if (!url || !url.startsWith("http")) return;
  if (url === _lastFetchedUrl && pendingDetails) return;
  _lastFetchedUrl = url;

  addMsg("üîç Fetching recipe details...", "loading");

  // Normalize URL - strip print query params but KEEP /print/NNNNN/ paths (they work fine)
  let fetchUrl = url
    .replace(/[?&]recipe_print=[^&]*/g, "")
    .replace(/[?&]print=[^&]*/g, "")
    .replace(/[?&]format=print[^&]*/g, "")
    .replace(/[?]$/, "");

  // Auto-fill source immediately from URL
  const srcField = document.getElementById("new-source");
  if (!srcField.value) srcField.value = guessSourceFromUrl(url);

  try {
    // Fetch via allorigins CORS proxy ‚Äî uses your browser's real headers, bypasses bot blocks
    const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(fetchUrl)}`;
    const res = await fetch(proxyUrl);
    const html = await res.text();

    if (!html || html.length < 1000) {
      addMsg("‚ö†Ô∏è Could not load page. Try copying ingredients manually.", "error");
      return;
    }

    const data = parseRecipeHTML(html, fetchUrl);

    if (data.name) document.getElementById("new-name").value = data.name;
    if (data.servings) document.getElementById("new-servings").value = data.servings;
    if (data.image) pendingDetails = { ...pendingDetails, image_url: data.image };

    if (data.ingredients.length) {
      pendingDetails = { ingredients: data.ingredients, steps: data.steps || [], servings: data.servings || 4 };
      addMsg(`‚úÖ Found ${data.ingredients.length} ingredients, ${data.steps.length} steps. Review below then save.`, "success");
      // Show preview
      const prev = document.getElementById("fetch-preview");
      const ingList = document.getElementById("preview-ingredients");
      const stepList = document.getElementById("preview-steps");
      ingList.innerHTML = data.ingredients.map(i => `<li>${i}</li>`).join("");
      stepList.innerHTML = (data.steps||[]).map(s => `<li>${s}</li>`).join("");
      prev.style.display = "block";
    } else {
      addMsg(`‚ö†Ô∏è Page loaded (${html.length} chars) but couldn't find ingredients. Fill in manually.`, "error");
    }
  } catch (e) {
    addMsg("‚ö†Ô∏è Fetch failed: " + e.message, "error");
  }
}

async function saveNew() {
  const name = document.getElementById("new-name").value.trim();
  const url = document.getElementById("new-url").value.trim();
  if (!name) return addMsg("Please enter a recipe name.", "error");
  const nid = Math.max(...BASE.map(r=>r.id), ...recipes.map(r=>r.id)) + 1;
  const nr = { id:nid, name, category:document.getElementById("new-cat").value, protein:document.getElementById("new-protein").value||"Other", method:document.getElementById("new-method").value||"Stovetop", source:document.getElementById("new-source").value||"Unknown", url, cost:document.getElementById("new-cost").value||"TBD", image_url: pendingDetails?.image_url || null };
  recipes.push(nr);
  await api("extra-recipes","POST",nr);
  const servings = parseInt(document.getElementById("new-servings").value) || 4;
  nr.servings = servings;
  if (pendingDetails) {
    await api("recipe-details","POST",{ recipe_id:nid, ingredients:pendingDetails.ingredients, steps:pendingDetails.steps, servings: pendingDetails.servings || servings });
    details[nid] = { ...pendingDetails, servings: pendingDetails.servings || servings };
    pendingDetails = null;
  }
  buildSelects();
  ["new-url","new-name","new-protein","new-method","new-source","new-cost"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("add-panel").classList.remove("show");
  document.getElementById("add-msg").style.display = "none";
  document.getElementById("fetch-preview").style.display = "none";
  document.getElementById("preview-ingredients").innerHTML = "";
  document.getElementById("preview-steps").innerHTML = "";
  render();
  setTimeout(()=>{const w=document.getElementById("wrap-"+nid);if(w){w.scrollIntoView({behavior:"smooth",block:"center"});w.classList.add("open");}},200);
}

function addMsg(txt,type){const el=document.getElementById("add-msg");el.style.display="flex";el.className="add-msg "+type;el.innerHTML=type==="loading"?`<div class="spinner"></div>${txt}`:txt;}

// ‚îÄ‚îÄ Ingredient matcher ‚îÄ‚îÄ
// ‚îÄ‚îÄ Fridge / ingredient matcher (local, no AI) ‚îÄ‚îÄ
let fridgeSelected = new Set(); // selected ingredient strings

function cleanIngredient(raw) {
  return raw.trim()
    .replace(/\(.*?\)/g, '')
    .replace(/,.*$/, '')
    .replace(/^[\d\s\/\.\-¬Ω¬º¬æ‚Öì‚Öî‚Öõ]+/, '')
    .replace(/^(cups?|tbsps?|tsps?|tablespoons?|teaspoons?|oz|lbs?|pounds?|ounces?|g|kg|ml|l|cloves?|cans?|pkgs?|packages?|bunches?|slices?|pieces?|pinch|handful|sprigs?|strips?|scoops?|heads?|stalks?|inches?|inch)\s+/i, '')
    .replace(/^(large|medium|small|extra large|xl|fresh|dried|frozen|boneless|skinless|minced|chopped|diced|sliced|shredded|grated|cooked|raw|whole|ground|lean|organic|sweet|baby|yellow|white|red|green|purple)\s+/gi, '')
    .trim()
    .toLowerCase()
    .replace(/onions$/, 'onion')
    .replace(/peppers$/, 'pepper')
    .replace(/tomatoes$/, 'tomato')
    .replace(/potatoes$/, 'potato')
    .replace(/cloves$/, 'clove')
    .replace(/eggs$/, 'egg')
    .replace(/tortillas$/, 'tortilla')
    .replace(/mushrooms$/, 'mushroom')
    .replace(/avocados$/, 'avocado')
    .replace(/limes$/, 'lime')
    .replace(/lemons$/, 'lemon');
}

function getAllIngredients() {
  const all = new Set();
  Object.values(details).forEach(d => {
    (d.ingredients || []).forEach(ing => {
      const clean = cleanIngredient(ing);
      if (clean.length > 1) all.add(clean);
    });
  });
  return Array.from(all).sort();
}

function showFridgeDropdown() {
  fridgeDropdownFilter(document.getElementById("fridge-search").value);
  document.getElementById("fridge-dropdown").style.display = "block";
}

function fridgeDropdownFilter(q) {
  const dd = document.getElementById("fridge-dropdown");
  const all = getAllIngredients();
  const lower = q.toLowerCase();
  const filtered = all.filter(i => !fridgeSelected.has(i) && i.toLowerCase().includes(lower)).slice(0, 50);
  if (!filtered.length) { dd.innerHTML = `<div style="padding:10px 14px;color:#555;font-size:13px">No matches</div>`; return; }
  window._fridgeDdItems = filtered;
  window._fridgeDdIndex = -1;
  dd.innerHTML = filtered.map((ing, idx) => `
    <div id="fdd-${idx}" onmousedown="event.preventDefault();fridgeAddIngredient(_fridgeDdItems[${idx}])"
      style="padding:9px 14px;font-size:13px;color:#c8d0e0;cursor:pointer;border-bottom:1px solid #12151f"
      onmouseover="fridgeSetIndex(${idx})" onmouseout="">
      ${esc(ing)}
    </div>`).join("");
  dd.style.display = "block";
}

function fridgeSetIndex(idx) {
  const items = document.getElementById("fridge-dropdown").querySelectorAll("[id^='fdd-']");
  items.forEach((el, i) => el.style.background = i === idx ? "#2a3550" : "transparent");
  window._fridgeDdIndex = idx;
}

function fridgeKeyNav(e) {
  const dd = document.getElementById("fridge-dropdown");
  if (dd.style.display === "none") { if (e.key === "ArrowDown") showFridgeDropdown(); return; }
  const items = window._fridgeDdItems || [];
  if (!items.length) return;
  if (e.key === "ArrowDown") {
    e.preventDefault();
    const next = Math.min((window._fridgeDdIndex ?? -1) + 1, items.length - 1);
    fridgeSetIndex(next);
    document.getElementById("fdd-" + next)?.scrollIntoView({ block: "nearest" });
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    const prev = Math.max((window._fridgeDdIndex ?? 0) - 1, 0);
    fridgeSetIndex(prev);
    document.getElementById("fdd-" + prev)?.scrollIntoView({ block: "nearest" });
  } else if (e.key === "Enter") {
    e.preventDefault();
    const idx = window._fridgeDdIndex ?? -1;
    if (idx >= 0 && items[idx]) fridgeAddIngredient(items[idx]);
  } else if (e.key === "Escape") {
    dd.style.display = "none";
    window._fridgeDdIndex = -1;
  }
}

function fridgeAddIngredient(ing) {
  fridgeSelected.add(ing);
  document.getElementById("fridge-search").value = "";
  renderFridgeChips();
  if (fridgeSelected.size > 0) runFridgeMatch();
  // Keep dropdown open so user can keep adding ingredients
  fridgeDropdownFilter("");
  document.getElementById("fridge-search").focus();
}

function renderFridgeChips() {
  const wrap = document.getElementById("fridge-chips");
  wrap.innerHTML = Array.from(fridgeSelected).map(ing => `
    <span style="display:inline-flex;align-items:center;gap:5px;background:#2a3550;border:1px solid #3d5a8a;border-radius:16px;padding:5px 12px;font-size:12px;color:#7eb8f7;font-family:monospace">
      ${esc(ing)}
      <span onclick="fridgeRemoveIngredient(${JSON.stringify(ing)})" style="cursor:pointer;color:#5a7aaa;font-size:15px;line-height:1;margin-left:2px" title="Remove">‚úï</span>
    </span>`).join("");
}

function fridgeRemoveIngredient(ing) {
  fridgeSelected.delete(ing);
  renderFridgeChips();
  if (fridgeSelected.size > 0) runFridgeMatch(); else clearMatch();
}

function runFridgeMatch() {
  if (!fridgeSelected.size) { document.getElementById("fridge-info").textContent = "Add some ingredients first."; return; }
  const userIngs = Array.from(fridgeSelected); // already cleaned
  matchScores = {};
  recipes.forEach(r => {
    const d = details[r.id];
    if (!d || !d.ingredients?.length) return;
    const recipeIngsCleaned = d.ingredients.map(i => cleanIngredient(i));
    const matched = userIngs.filter(u => recipeIngsCleaned.some(ri => ri.includes(u) || u.includes(ri)));
    const score = Math.round((matched.length / recipeIngsCleaned.length) * 100);
    if (score > 0) {
      const match = score >= 70 ? "full" : "partial";
      matchScores[r.id] = { score, match, note: `${matched.length} of ${recipeIngsCleaned.length} ingredients matched (${matched.join(", ")})` };
    }
  });
  matchActive = true;
  sort = "match";
  document.getElementById("sortBy").value = "match";
  const total = Object.keys(matchScores).length;
  document.getElementById("fridge-info").textContent = `‚úÖ Found ${total} recipes using your ingredients`;
  render();
}

function clearMatch() {
  matchScores = {}; matchActive = false; fridgeSelected.clear();
  renderFridgeChips();
  document.getElementById("fridge-search").value = "";
  document.getElementById("fridge-info").textContent = "";
  document.getElementById("fridge-dropdown").style.display = "none";
  if (sort === "match") { sort = "category"; document.getElementById("sortBy").value = "category"; }
  render();
}

// Close dropdown when clicking outside
// dropdown closed via onblur with delay

// ‚îÄ‚îÄ Grocery List ‚îÄ‚îÄ
let groceryItems = [];
let _cachedStructuredRows = [];
let archivedRecipes = new Set(); // persisted across refreshes

// Cost DB: { price, size, unit }
// price = package price at Aldi
// size = package size in that unit
// unit = the unit we measure cost per
const COST_DB = {
  // === PROTEINS (priced per lb) ===
  "chicken breast":       { price: 7.00,  size: 2,    unit: "lb" },
  "chicken thigh":        { price: 6.00,  size: 2,    unit: "lb" },
  "chicken wing":         { price: 8.00,  size: 2,    unit: "lb" },
  "chicken":              { price: 6.00,  size: 2,    unit: "lb" },
  "ground turkey":        { price: 5.00,  size: 1,    unit: "lb" },
  "ground beef":          { price: 6.00,  size: 1,    unit: "lb" },
  "turkey":               { price: 5.00,  size: 1,    unit: "lb" },
  "beef":                 { price: 7.00,  size: 1,    unit: "lb" },
  "pork shoulder":        { price: 5.00,  size: 2,    unit: "lb" },
  "pork":                 { price: 5.00,  size: 2,    unit: "lb" },
  "shrimp":               { price: 8.00,  size: 1,    unit: "lb" },
  "tuna":                 { price: 2.50,  size: 1,    unit: "can" },
  "chorizo":              { price: 4.00,  size: 1,    unit: "lb" },
  "sausage":              { price: 4.50,  size: 1,    unit: "lb" },
  "bacon":                { price: 5.00,  size: 1,    unit: "lb" },
  "deli chicken":         { price: 5.00,  size: 1,    unit: "lb" },
  "meatballs":            { price: 7.00,  size: 26,   unit: "oz" },

  // === DAIRY & EGGS ===
  "eggs":                 { price: 4.00,  size: 12,   unit: "egg" },
  "egg whites":           { price: 4.00,  size: 32,   unit: "oz" },
  "cheddar cheese":       { price: 3.50,  size: 8,    unit: "oz" },
  "mozzarella":           { price: 3.50,  size: 8,    unit: "oz" },
  "parmesan":             { price: 4.00,  size: 8,    unit: "oz" },
  "ricotta":              { price: 4.00,  size: 15,   unit: "oz" },
  "feta":                 { price: 3.50,  size: 6,    unit: "oz" },
  "mexican cheese":       { price: 3.50,  size: 8,    unit: "oz" },
  "cream cheese":         { price: 3.00,  size: 8,    unit: "oz" },
  "heavy cream":          { price: 3.00,  size: 16,   unit: "oz" },
  "sour cream":           { price: 2.00,  size: 16,   unit: "oz" },
  "butter":               { price: 3.00,  size: 16,   unit: "tbsp" },
  "greek yogurt":         { price: 4.00,  size: 32,   unit: "oz" },
  "yogurt":               { price: 3.00,  size: 32,   unit: "oz" },
  "milk":                 { price: 3.00,  size: 128,  unit: "oz" },
  "protein powder":       { price: 30.00, size: 30,   unit: "scoop" },

  // === PRODUCE (priced per unit or oz) ===
  "onion":                { price: 1.50,  size: 3,    unit: "whole" },
  "garlic":               { price: 1.50,  size: 30,   unit: "clove" },
  "bell pepper":          { price: 2.50,  size: 3,    unit: "whole" },
  "spinach":              { price: 3.00,  size: 5,    unit: "oz" },
  "avocado":              { price: 1.50,  size: 1,    unit: "whole" },
  "tomato":               { price: 2.00,  size: 4,    unit: "whole" },
  "jalapeno":             { price: 1.00,  size: 6,    unit: "whole" },
  "jalape√±o":             { price: 1.00,  size: 6,    unit: "whole" },
  "lime":                 { price: 1.50,  size: 6,    unit: "whole" },
  "lemon":                { price: 1.50,  size: 6,    unit: "whole" },
  "cilantro":             { price: 1.00,  size: 1,    unit: "bunch" },
  "parsley":              { price: 1.00,  size: 1,    unit: "bunch" },
  "basil":                { price: 2.00,  size: 1,    unit: "bunch" },
  "green onion":          { price: 1.00,  size: 1,    unit: "bunch" },
  "mushroom":             { price: 3.00,  size: 8,    unit: "oz" },
  "broccoli":             { price: 2.50,  size: 12,   unit: "oz" },
  "cauliflower":          { price: 3.00,  size: 1,    unit: "head" },
  "zucchini":             { price: 1.50,  size: 2,    unit: "whole" },
  "sweet potato":         { price: 2.00,  size: 3,    unit: "whole" },
  "potato":               { price: 2.00,  size: 5,    unit: "whole" },
  "brussels sprouts":     { price: 3.00,  size: 12,   unit: "oz" },
  "artichoke":            { price: 3.00,  size: 14,   unit: "oz" },
  "corn":                 { price: 2.00,  size: 15,   unit: "oz" },

  // === PANTRY / CANNED ===
  "salsa verde":          { price: 3.50,  size: 16,   unit: "oz" },
  "salsa":                { price: 3.00,  size: 16,   unit: "oz" },
  "enchilada sauce":      { price: 2.50,  size: 19,   unit: "oz" },
  "pesto":                { price: 4.00,  size: 6,    unit: "oz" },
  "marinara":             { price: 3.00,  size: 24,   unit: "oz" },
  "tomato sauce":         { price: 1.50,  size: 15,   unit: "oz" },
  "crushed tomatoes":     { price: 2.00,  size: 28,   unit: "oz" },
  "diced tomatoes":       { price: 1.50,  size: 14.5, unit: "oz" },
  "chicken broth":        { price: 2.50,  size: 32,   unit: "oz" },
  "beef broth":           { price: 2.50,  size: 32,   unit: "oz" },
  "vegetable broth":      { price: 2.00,  size: 32,   unit: "oz" },
  "black beans":          { price: 1.50,  size: 15,   unit: "oz" },
  "pinto beans":          { price: 1.50,  size: 15,   unit: "oz" },
  "chickpeas":            { price: 1.50,  size: 15,   unit: "oz" },
  "cream of mushroom":    { price: 2.00,  size: 10.5, unit: "oz" },
  "bread crumbs":         { price: 2.00,  size: 15,   unit: "oz" },

  // === OILS & SAUCES (tbsp-based) ===
  "avocado oil":          { price: 6.00,  size: 48,   unit: "tbsp" },
  "olive oil":            { price: 5.00,  size: 48,   unit: "tbsp" },
  "coconut aminos":       { price: 5.00,  size: 32,   unit: "tbsp" },
  "soy sauce":            { price: 2.50,  size: 32,   unit: "tbsp" },
  "honey":                { price: 4.00,  size: 24,   unit: "tbsp" },
  "rice vinegar":         { price: 2.50,  size: 32,   unit: "tbsp" },
  "ketchup":              { price: 2.50,  size: 40,   unit: "tbsp" },
  "bbq sauce":            { price: 3.00,  size: 24,   unit: "tbsp" },
  "hot sauce":            { price: 2.00,  size: 24,   unit: "tbsp" },
  "sriracha":             { price: 3.00,  size: 28,   unit: "tbsp" },
  "peanut butter":        { price: 3.50,  size: 32,   unit: "tbsp" },
  "cornstarch":           { price: 1.50,  size: 48,   unit: "tbsp" },
  "oat flour":            { price: 3.00,  size: 32,   unit: "tbsp" },
  "tahini":               { price: 4.00,  size: 16,   unit: "tbsp" },

  // === SPICES (tsp-based, tiny cost per use) ===
  "salt":                 { price: 1.00,  size: 200,  unit: "tsp" },
  "pepper":               { price: 1.50,  size: 100,  unit: "tsp" },
  "cumin":                { price: 2.00,  size: 60,   unit: "tsp" },
  "chili powder":         { price: 2.00,  size: 60,   unit: "tsp" },
  "garlic powder":        { price: 2.00,  size: 60,   unit: "tsp" },
  "onion powder":         { price: 2.00,  size: 60,   unit: "tsp" },
  "paprika":              { price: 2.00,  size: 60,   unit: "tsp" },
  "oregano":              { price: 2.00,  size: 40,   unit: "tsp" },
  "cinnamon":             { price: 2.00,  size: 60,   unit: "tsp" },
  "red pepper flakes":    { price: 2.00,  size: 40,   unit: "tsp" },
  "italian seasoning":    { price: 2.00,  size: 40,   unit: "tsp" },
  "taco seasoning":       { price: 2.00,  size: 12,   unit: "tsp" },
  "everything bagel":     { price: 3.00,  size: 60,   unit: "tsp" },

  // === GRAINS & CARBS ===
  "pasta":                { price: 2.50,  size: 16,   unit: "oz" },
  "rotini":               { price: 2.50,  size: 16,   unit: "oz" },
  "egg noodles":          { price: 2.50,  size: 16,   unit: "oz" },
  "chickpea pasta":       { price: 4.00,  size: 8,    unit: "oz" },
  "rice":                 { price: 2.50,  size: 32,   unit: "oz" },
  "cauliflower rice":     { price: 3.50,  size: 12,   unit: "oz" },
  "tater tots":           { price: 3.50,  size: 28,   unit: "oz" },
  "tortillas":            { price: 3.50,  size: 8,    unit: "whole" },
  "corn tortillas":       { price: 3.00,  size: 30,   unit: "whole" },
  "flour tortillas":      { price: 3.50,  size: 8,    unit: "whole" },
  "cassava tortillas":    { price: 5.00,  size: 6,    unit: "whole" },
  "rolls":                { price: 3.00,  size: 8,    unit: "whole" },
  "bread":                { price: 3.00,  size: 16,   unit: "slice" },
  "noodles":              { price: 2.00,  size: 1,    unit: "pack" },
};

// Unit conversion to normalize measurements
const UNIT_CONVERSIONS = {
  // volume to tbsp
  "tsp": 0.333, "teaspoon": 0.333, "teaspoons": 0.333,
  "tbsp": 1, "tablespoon": 1, "tablespoons": 1,
  "cup": 16, "cups": 16,
  "oz": 2, "ounce": 2, "ounces": 2, "fl oz": 2,
  "pint": 32, "quart": 64,
  // weight
  "lb": 1, "lbs": 1, "pound": 1, "pounds": 1,
  "g": 0.0022, "gram": 0.0022, "grams": 0.0022,
  // count
  "whole": 1, "clove": 1, "cloves": 1, "egg": 1, "eggs": 1,
  "can": 1, "cans": 1, "bunch": 1, "head": 1, "scoop": 1, "pack": 1,
  "slice": 1, "slices": 1,
  // meat-specific
  "strip": 1, "strips": 1, "piece": 1, "pieces": 1,
  "fillet": 1, "fillets": 1, "breast": 1, "thigh": 1, "thighs": 1,
};

// Map count-based units to per-lb equivalents for proteins
const COUNT_TO_LB = {
  "strip": 0.05,   // 1 bacon strip ‚âà 0.05 lb
  "strips": 0.05,
  "piece": 0.25,
  "pieces": 0.25,
  "breast": 0.5,   // 1 chicken breast ‚âà 0.5 lb
  "thigh": 0.25,
  "thighs": 0.25,
  "fillet": 0.33,
};

function parseIngredientCost(ingStr) {
  if (!ingStr) return 0;
  const lower = ingStr.toLowerCase().trim();

  // Find matching item in COST_DB
  let matched = null, matchedKey = '';
  for (const key of Object.keys(COST_DB)) {
    if (lower.includes(key) && key.length > matchedKey.length) {
      matched = COST_DB[key];
      matchedKey = key;
    }
  }
  if (!matched) return 0;

  // Parse amount and unit from ingredient string
  // e.g. "2 tbsp olive oil" -> amount=2, unit=tbsp
  const numMatch = lower.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öõ‚Öú‚Öù‚Öû]+\.?\d*)\s*(?:to\s+[\d.]+\s+)?([a-z\s]+?)\s/);
  let amount = 1, unit = matched.unit;

  if (numMatch) {
    // Handle fractions
    const raw = numMatch[1].replace('¬º','0.25').replace('¬Ω','0.5').replace('¬æ','0.75')
      .replace('‚Öì','0.33').replace('‚Öî','0.67').replace('‚Öõ','0.125');
    amount = parseFloat(raw) || 1;
    const parsedUnit = numMatch[2].trim().toLowerCase();
    if (UNIT_CONVERSIONS[parsedUnit] !== undefined) unit = parsedUnit;
  }

  // Convert both to the same base unit and calculate cost
  const pkgUnit = matched.unit;
  const pkgSize = matched.size;
  const pkgPrice = matched.price;

  // If units match directly
  if (unit === pkgUnit || UNIT_CONVERSIONS[unit] === UNIT_CONVERSIONS[pkgUnit]) {
    return (amount / pkgSize) * pkgPrice;
  }

  // Both in volume (tbsp-based) conversion
  const toBbsp = UNIT_CONVERSIONS[unit];
  const pkgToTbsp = UNIT_CONVERSIONS[pkgUnit];
  if (toBbsp && pkgToTbsp) {
    const amountInTbsp = amount * toBbsp;
    const pkgInTbsp = pkgSize * pkgToTbsp;
    return (amountInTbsp / pkgInTbsp) * pkgPrice;
  }

  // Count-based meat units -> lb conversion
  if (COUNT_TO_LB[unit] && pkgUnit === 'lb') {
    const amountInLb = amount * COUNT_TO_LB[unit];
    return (amountInLb / pkgSize) * pkgPrice;
  }

  // Both weight (lb-based)
  const toLb = { lb:1,lbs:1,pound:1,pounds:1,oz:0.0625,ounces:0.0625,g:0.0022,gram:0.0022,grams:0.0022 };
  if (toLb[unit] && toLb[pkgUnit]) {
    const amountInLb = amount * toLb[unit];
    const pkgInLb = pkgSize * toLb[pkgUnit];
    return (amountInLb / pkgInLb) * pkgPrice;
  }

  // Fallback: treat as fractional package (cap at 2x package price)
  const fraction = Math.min(amount / pkgSize, 2);
  return fraction * pkgPrice;
}

function estimateCost(ingredient) {
  // Use parseIngredientCost for accuracy, with a per-ingredient sanity cap
  if (!ingredient) return null;
  const cost = parseIngredientCost(ingredient);
  if (cost > 0 && cost < 15) return cost;
  // Fallback: flat 30% of package price
  const lower = ingredient.toLowerCase();
  for (const [key, item] of Object.entries(COST_DB)) {
    if (lower.includes(key)) return Math.min(item.price * 0.3, 10);
  }
  return null;
}

function normalizeUnit(meas) {
  if (!meas) return '';
  const m = meas.toLowerCase();
  if (['tablespoon','tablespoons'].includes(m)) return 'tbsp';
  if (['teaspoon','teaspoons'].includes(m)) return 'tsp';
  if (['pound','pounds','lbs'].includes(m)) return 'lb';
  if (['ounce','ounces'].includes(m)) return 'oz';
  return m;
}

function formatAmount(amount) {
  if (!amount || amount === 0) return '';
  const whole = Math.floor(amount);
  const frac = amount - whole;
  let fracStr = '';
  if (Math.abs(frac - 0.5) < 0.02) fracStr = '¬Ω';
  else if (Math.abs(frac - 0.25) < 0.02) fracStr = '¬º';
  else if (Math.abs(frac - 0.75) < 0.02) fracStr = '¬æ';
  else if (Math.abs(frac - (1/3)) < 0.02) fracStr = '‚Öì';
  else if (Math.abs(frac - (2/3)) < 0.02) fracStr = '‚Öî';
  else if (frac > 0.02) fracStr = Math.round(frac * 8) / 8 + '';
  if (whole > 0 && fracStr) return `${whole} ${fracStr}`;
  if (whole > 0) return `${whole}`;
  return fracStr || '';
}

// Scale numbers in a text ingredient string
function scaleIngredientText(text, mult) {
  if (mult === 1) return text;
  // Match fractions (1/2, 3/4), mixed numbers (1 1/2), decimals, whole numbers
  return text.replace(/(\d+\s+)?(\d+\/\d+|\d*\.?\d+)/g, (match) => {
    const num = match.includes('/') ? evalFraction(match.trim()) : parseFloat(match);
    if (isNaN(num) || num === 0) return match;
    const scaled = num * mult;
    return formatAmount(scaled) || match;
  });
}

function evalFraction(str) {
  // Handle "1 1/2" or "1/2"
  const parts = str.trim().split(/\s+/);
  if (parts.length === 2) {
    const [a, b] = parts[1].split('/');
    return parseInt(parts[0]) + parseInt(a) / parseInt(b);
  }
  const [a, b] = parts[0].split('/');
  return b ? parseInt(a) / parseInt(b) : parseFloat(a);
}

// Calculate cost from ingredients using per-unit COST_DB
function calcCostFromIngredients(recipeId, servings) {
  const d = details[recipeId];
  if (!d || !d.ingredients || d.ingredients.length < 2) return null;
  const defaultSv = getDefaultServings(recipeId) || 4;
  const sv = servings || defaultSv;
  let total = 0, matched = 0;
  d.ingredients.forEach(ing => {
    const cost = parseIngredientCost(ing);
    if (cost > 0) { total += cost; matched++; }
  });
  if (matched < 2) return null;
  const ratio = sv / defaultSv;
  return total * (ratio > 1 ? 1 + (ratio-1)*0.75 : ratio > 0 ? 1-(1-ratio)*0.75 : 1);
}

// Format dynamic cost as a string like "$8-12"
function dynamicCostStr(r) {
  const d = details[r.id];
  if (!d || !d.ingredients || d.ingredients.length < 2) {
    return r.cost && r.cost !== 'TBD' ? r.cost : null;
  }
  let total = 0, matched = 0;
  d.ingredients.forEach(ing => {
    const cost = parseIngredientCost(ing);
    // Cap individual ingredient at $15 to prevent runaway values
    if (cost > 0 && cost < 15) { total += cost; matched++; }
  });
  if (matched < 2) return r.cost && r.cost !== 'TBD' ? r.cost : null;
  const adjusted = total * 1.15;
  // Sanity check: fall back to stored cost if total looks wrong
  if (adjusted > 60) return r.cost && r.cost !== 'TBD' ? r.cost : null;
  const lo = Math.floor(adjusted * 0.9);
  const hi = Math.ceil(adjusted * 1.1);
  return `$${lo}-${hi}`;
}

function scaledCost(r, sv, def) {
  // Always prefer ingredient-based calculation
  const fromIngredients = calcCostFromIngredients(r.id, sv);
  if (fromIngredients && fromIngredients < 100) return fromIngredients; // sanity cap
  // Fall back to hardcoded cost string
  if (!r.cost || r.cost === 'TBD' || r.cost === 'null') return null;
  const nums = r.cost.replace(/[^0-9\.]/g,' ').trim().split(/\s+/).map(Number).filter(n=>n>0&&n<200);
  if (!nums.length) return null;
  const base = nums.reduce((a,b)=>a+b,0)/nums.length;
  const ratio = def > 0 ? sv / def : 1;
  return base * (ratio > 1 ? 1 + (ratio-1)*0.75 : ratio > 0 ? 1-(1-ratio)*0.75 : 1);
}

function buildCartHeaderHTML(sel) {
  const totalCost = sel.reduce((sum, r) => {
    const c = scaledCost(r, getServings(r.id), getDefaultServings(r.id));
    return sum + (c || 0);
  }, 0);
  return `<div style="margin-bottom:12px;padding:12px 16px;background:#12151f;border:1px solid #2a2f3e;border-radius:10px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:#556;font-family:monospace">üõí In your cart</div>
      ${totalCost > 0 ? `<div style="font-size:12px;color:#6aaa6a;font-family:monospace">~$${totalCost.toFixed(0)} est.</div>` : ''}
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      ${sel.map(r => {
        const sv = getServings(r.id);
        const def = getDefaultServings(r.id);
        const cost = scaledCost(r, sv, def);
        const costStr = cost ? `~$${cost.toFixed(0)}` : '';
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#1a1f2e;border:1px solid #2a2f3e;border-radius:8px">
          <span style="flex:1;font-size:13px;color:#E8E4DC">${esc(r.name)}</span>
          <span style="display:flex;align-items:center;gap:3px;background:#1e2330;border:1px solid #3a4060;border-radius:4px;padding:2px 6px">
            <button onmousedown="event.preventDefault();event.stopPropagation();adjustCartServings(${r.id},-1)" style="background:none;border:none;color:#aaa;cursor:pointer;font-size:14px;padding:0 2px;line-height:1">‚àí</button>
            <span style="font-size:12px;color:#7eb8f7;font-family:monospace;min-width:20px;text-align:center">${sv}<span style="color:#445;font-size:10px"> /${def}</span></span>
            <button onmousedown="event.preventDefault();event.stopPropagation();adjustCartServings(${r.id},+1)" style="background:none;border:none;color:#aaa;cursor:pointer;font-size:14px;padding:0 2px;line-height:1">+</button>
          </span>
          ${costStr ? `<span style="font-size:11px;color:#6aaa6a;font-family:monospace;min-width:32px;text-align:right">${costStr}</span>` : ''}
          <button onmousedown="event.preventDefault();event.stopPropagation();removeFromCart(${r.id})"
            title="Remove from cart"
            style="background:none;border:none;color:#445;cursor:pointer;font-size:16px;padding:0 2px;line-height:1;opacity:0.5" onmouseover="this.style.opacity=1;this.style.color='#cc6666'" onmouseout="this.style.opacity=0.5;this.style.color='#445'">‚úï</button>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

async function openGrocery() {
  if (!checked.size) return;
  archivedRecipes.clear();
  recipes.forEach(r => { if (r.archived) archivedRecipes.add(r.id); });
  document.getElementById("grocery-modal").classList.add("show");
  const body = document.getElementById("g-body");
  body.innerHTML = `<div style="padding:24px;text-align:center;color:#556;font-family:monospace">Loading ingredients...</div>`;
  document.getElementById("g-search").value = "";

  const sel = recipes.filter(r => checked.has(r.id));
  document.getElementById("g-subtitle").textContent = `${sel.length} recipe${sel.length > 1 ? "s" : ""}`;

  // Fetch structured ingredients from DB
  let structuredRows = [];
  try {
    const res = await api("structured-ingredients", "POST", { recipe_ids: sel.map(r => r.id) });
    if (Array.isArray(res)) structuredRows = res;
    _cachedStructuredRows = structuredRows;
  } catch(e) { console.error("structured-ingredients fetch failed", e); structuredRows = _cachedStructuredRows; }

  const structuredIds = new Set(structuredRows.map(r => r.recipe_id));
  const fallbackRecipes = sel.filter(r => !structuredIds.has(r.id) && details[r.id]);
  const noDataRecipes = sel.filter(r => !structuredIds.has(r.id) && !details[r.id]);
  const recipeNames = {};
  sel.forEach(r => recipeNames[r.id] = r.name);

  // Build servings multipliers (current / default) with 75% cost scaling
  const servingsMult = {};
  const costMult = {};  // separate multiplier for cost (75% rate)
  sel.forEach(r => {
    const def = getDefaultServings(r.id);
    const cur = getServings(r.id);
    const ratio = def > 0 ? cur / def : 1;
    servingsMult[r.id] = ratio;
    // Cost scales at 75% rate: doubling servings = 1.5x cost, not 2x
    costMult[r.id] = ratio > 1 ? 1 + (ratio - 1) * 0.75 : ratio > 0 ? 1 - (1 - ratio) * 0.75 : 1;
  });

  // Build cart header HTML
  const cartHeaderHTML = buildCartHeaderHTML(sel);

  // Merge structured rows by (ingredient_key, unit) with servings scaling
  const merged = {};
  structuredRows.forEach(row => {
    const ingKey = row.ingredient.trim().toLowerCase();
    const unit = normalizeUnit(row.measurement);
    const key = `${ingKey}|||${unit}`;
    const mult = servingsMult[row.recipe_id] || 1;
    if (!merged[key]) {
      merged[key] = {
        ingredient: row.ingredient.trim(),
        measurement: unit || null,
        amount: 0,
        hasAmount: false,
        recipes: [],
        cost: estimateCost(row.ingredient),
        sortKey: ingKey,
      };
    }
    if (row.amount) { merged[key].amount += parseFloat(row.amount) * mult; merged[key].hasAmount = true; }
    const rname = recipeNames[row.recipe_id];
    if (rname && !merged[key].recipes.includes(rname)) merged[key].recipes.push(rname);
  });

  // Fallback: use text ingredients for recipes without structured data (best-effort scaling)
  fallbackRecipes.forEach(r => {
    const mult = servingsMult[r.id] || 1;
    (details[r.id].ingredients || []).forEach(ing => {
      // Try to scale numbers in the text
      let scaledIng = ing.trim();
      let wasScaled = false;
      if (mult !== 1) {
        scaledIng = scaleIngredientText(ing.trim(), mult);
        wasScaled = scaledIng !== ing.trim();
      }
      const key = `__text__${ing.trim().toLowerCase()}`;
      if (!merged[key]) merged[key] = {
        ingredient: scaledIng,
        measurement: null, amount: 0, hasAmount: false,
        recipes: [], cost: estimateCost(ing),
        sortKey: ing.trim().toLowerCase(),
        needsReview: mult !== 1, // flag for ‚ö†Ô∏è
      };
      if (!merged[key].recipes.includes(r.name)) merged[key].recipes.push(r.name);
    });
  });

  // Build display items sorted alphabetically
  groceryItems = Object.values(merged)
    .sort((a, b) => a.sortKey.localeCompare(b.sortKey))
    .map(item => {
      const amtStr = item.hasAmount ? `${formatAmount(item.amount)}${item.measurement ? ' ' + item.measurement : ''}` : '';
      const text = amtStr ? `${amtStr} ${item.ingredient}` : item.ingredient;
      return { ...item, text, checked: true };
    });

  document.getElementById("g-cart-header").innerHTML = cartHeaderHTML;
  renderGroceryList(groceryItems);
  updateGroceryCount();

  // Cost summary banner
  const totalCost = groceryItems.reduce((s, i) => s + (i.cost || 0), 0);
  if (totalCost > 0) {
    body.innerHTML += `<div style="margin-top:14px;padding:10px 14px;background:#0f1f0f;border:1px solid #2a4a2a;border-radius:8px;font-size:12px;color:#6aaa6a;font-family:monospace">
      üí∞ Estimated total: <strong style="font-size:14px">~$${totalCost.toFixed(0)}</strong> <span style="color:#3a6a3a">(rough estimate, prices vary)</span>
    </div>`;
  }

  if (noDataRecipes.length) {
    body.innerHTML += `<div style="margin-top:10px;padding:10px;background:#1a1f2e;border:1px solid var(--border);border-radius:8px;font-size:12px;color:#8a8f9e">
      <strong style="color:#aaa">‚ö† No ingredient data for:</strong> ${noDataRecipes.map(r => esc(r.name)).join(", ")}
    </div>`;
  }
}

function adjustCartServings(id, delta) {
  servingsMap[id] = Math.max(1, getServings(id) + delta);
  rerenderGrocery();
}

function removeFromCart(id) {
  if (!confirm(`Remove "${recipes.find(r=>r.id===id)?.name}" from the grocery list?`)) return;
  archivedRecipes.add(id);
  checked.delete(id);
  rerenderGrocery();
  if (checked.size === 0) closeGrocery();
}

function rerenderGrocery() {
  // Re-render using cached data - no DB fetch needed
  const sel = recipes.filter(r => checked.has(r.id));
  if (!sel.length) { closeGrocery(); return; }

  const structuredRows = _cachedStructuredRows.filter(r => checked.has(r.recipe_id));
  const structuredIds = new Set(structuredRows.map(r => r.recipe_id));
  const fallbackRecipes = sel.filter(r => !structuredIds.has(r.id) && details[r.id]);
  const noDataRecipes = sel.filter(r => !structuredIds.has(r.id) && !details[r.id]);
  const recipeNames = {};
  sel.forEach(r => recipeNames[r.id] = r.name);

  const servingsMult = {};
  const costMult = {};
  sel.forEach(r => {
    const def = getDefaultServings(r.id);
    const cur = getServings(r.id);
    const ratio = def > 0 ? cur / def : 1;
    servingsMult[r.id] = ratio;
    costMult[r.id] = ratio > 1 ? 1 + (ratio - 1) * 0.75 : ratio > 0 ? 1 - (1 - ratio) * 0.75 : 1;
  });

  // Rebuild cart header
  const cartHeaderHTML = buildCartHeaderHTML(sel);
  document.getElementById("g-cart-header").innerHTML = cartHeaderHTML;

  // Rebuild merged ingredients
  const merged = {};
  structuredRows.forEach(row => {
    const ingKey = row.ingredient.trim().toLowerCase();
    const unit = normalizeUnit(row.measurement);
    const key = `${ingKey}|||${unit}`;
    const mult = servingsMult[row.recipe_id] || 1;
    if (!merged[key]) merged[key] = { ingredient: row.ingredient.trim(), measurement: unit || null, amount: 0, hasAmount: false, recipes: [], cost: estimateCost(row.ingredient), sortKey: ingKey };
    if (row.amount) { merged[key].amount += parseFloat(row.amount) * mult; merged[key].hasAmount = true; }
    const rname = recipeNames[row.recipe_id];
    if (rname && !merged[key].recipes.includes(rname)) merged[key].recipes.push(rname);
  });
  fallbackRecipes.forEach(r => {
    const mult = servingsMult[r.id] || 1;
    (details[r.id].ingredients || []).forEach(ing => {
      const key = `__text__${ing.trim().toLowerCase()}`;
      let scaledIng = mult !== 1 ? scaleIngredientText(ing.trim(), mult) : ing.trim();
      if (!merged[key]) merged[key] = { ingredient: scaledIng, measurement: null, amount: 0, hasAmount: false, recipes: [], cost: estimateCost(ing), sortKey: ing.trim().toLowerCase(), needsReview: mult !== 1 };
      if (!merged[key].recipes.includes(r.name)) merged[key].recipes.push(r.name);
    });
  });

  groceryItems = Object.values(merged)
    .sort((a,b) => a.sortKey.localeCompare(b.sortKey))
    .map(item => {
      const amtStr = item.hasAmount ? `${formatAmount(item.amount)}${item.measurement ? ' ' + item.measurement : ''}` : '';
      const text = amtStr ? `${amtStr} ${item.ingredient}` : item.ingredient;
      return { ...item, text, checked: true };
    });

  renderGroceryList(groceryItems);
  updateGroceryCount();

  const totalCost = groceryItems.reduce((s, i) => s + (i.cost || 0), 0);
  const body = document.getElementById("g-body");
  if (totalCost > 0) {
    body.innerHTML += `<div style="margin-top:14px;padding:10px 14px;background:#0f1f0f;border:1px solid #2a4a2a;border-radius:8px;font-size:12px;color:#6aaa6a;font-family:monospace">
      üí∞ Estimated total: <strong style="font-size:14px">~$${totalCost.toFixed(0)}</strong> <span style="color:#3a6a3a">(rough estimate, prices vary)</span>
    </div>`;
  }

  // Archived section
  if (archivedRecipes.size) {
    const archHTML = `<details style="margin-top:14px">
      <summary style="font-size:11px;color:#445;font-family:monospace;cursor:pointer;user-select:none;padding:6px 0">
        üì¶ Archived (${archivedRecipes.size}) ‚Äî click to expand
      </summary>
      <div style="margin-top:8px;opacity:0.5;font-size:12px;color:#8a8f9e;font-family:monospace">
        ${[...archivedRecipes].map(id => {
          const r = recipes.find(x=>x.id===id);
          return r ? `<div style="padding:4px 0;display:flex;align-items:center;gap:8px">
            <span>${esc(r.name)}</span>
            <button onmousedown="event.preventDefault();archivedRecipes.delete(${id});checked.add(${id});rerenderGrocery()"
              style="background:none;border:1px solid #2a3f5e;color:#6e8efb;border-radius:4px;font-size:10px;cursor:pointer;padding:1px 6px">restore</button>
          </div>` : '';
        }).join('')}
      </div>
    </details>`;
    body.innerHTML += archHTML;
  }

  if (noDataRecipes.length) {
    body.innerHTML += `<div style="margin-top:10px;padding:10px;background:#1a1f2e;border:1px solid var(--border);border-radius:8px;font-size:12px;color:#8a8f9e">
      <strong style="color:#aaa">‚ö† No ingredient data for:</strong> ${noDataRecipes.map(r => esc(r.name)).join(", ")}
    </div>`;
  }
}

function groceryRowHTML(item, i) {
  const reviewBadge = item.needsReview ? `<span title="Amounts scaled from text ‚Äî please review" style="color:#b8860b;font-size:11px;margin-left:4px;cursor:help">‚ö†Ô∏è</span>` : '';
  const costStr = item.cost ? `<span style="color:#3a7a3a;font-size:11px;font-family:monospace;margin-left:6px">~$${item.cost.toFixed(2)}</span>` : '';
  const recipesStr = item.recipes.length ? `<span style="font-size:11px;color:#445;font-family:monospace;margin-left:6px">${item.recipes.map(esc).join(", ")}</span>` : '';
  return `<label style="display:flex;align-items:flex-start;gap:10px;padding:9px 6px;border-bottom:1px solid #1e2330;cursor:pointer;"
         onmouseover="this.style.background='#1e2330'" onmouseout="this.style.background='transparent'">
    <input type="checkbox" ${item.checked ? "checked" : ""}
      onchange="groceryItems[${i}].checked=this.checked;updateGroceryCount()"
      style="margin-top:3px;accent-color:#6e8efb;flex-shrink:0;width:15px;height:15px;cursor:pointer;">
    <div style="flex:1;min-width:0">
      <span style="font-size:13px;color:#E8E4DC;font-weight:500">${esc(item.text)}</span>${reviewBadge}
      ${costStr}${recipesStr}
    </div>
  </label>`;
}

// Store section classification
const STORE_SECTIONS = [
  { label: "ü•© Meat & Seafood",    keys: ["chicken","beef","pork","turkey","shrimp","fish","steak","chorizo","sausage","bacon","salmon","tuna","ground","brisket","carnitas","meatball"] },
  { label: "ü•¶ Produce",            keys: ["onion","garlic","pepper","spinach","avocado","tomato","jalape√±o","jalapeno","lime","lemon","cilantro","parsley","basil","lettuce","kale","cabbage","carrot","celery","broccoli","cauliflower","zucchini","mushroom","potato","sweet potato","corn","green onion","scallion","ginger","arugula","cucumber","radish","herb","apple","mango","berry","banana","fruit","vegetable","produce","fresh"] },
  { label: "üßÄ Dairy & Eggs",       keys: ["egg","milk","cream","butter","cheese","yogurt","sour cream","ricotta","mozzarella","parmesan","feta","cheddar","heavy cream","cream cheese","half and half"] },
  { label: "ü•´ Canned & Dry Goods", keys: ["can","canned","beans","lentil","chickpea","tomato sauce","diced tomato","crushed tomato","broth","stock","soup","pasta","noodle","rice","quinoa","oat","flour","cornstarch","baking powder","baking soda","sugar","salt"] },
  { label: "üßÇ Spices & Seasonings",keys: ["powder","seasoning","spice","cumin","paprika","oregano","thyme","rosemary","chili","turmeric","cinnamon","cayenne","pepper","salt","bay leaf","red pepper flake","italian seasoning","taco seasoning","everything bagel","za'atar","sumac","curry"] },
  { label: "üç∂ Condiments & Sauces",keys: ["sauce","salsa","pesto","vinegar","oil","mayo","mustard","ketchup","honey","syrup","sriracha","hot sauce","soy sauce","coconut amino","tahini","hummus","dressing","bbq","teriyaki","hoisin","fish sauce","worcestershire","ranch"] },
  { label: "üßä Frozen",             keys: ["frozen","tater tot","edamame","pea"] },
  { label: "üçû Bread & Bakery",     keys: ["tortilla","bread","roll","bun","pita","wrap","naan","bagel","crouton","panko","breadcrumb"] },
  { label: "üß¥ Deli",               keys: ["deli","lunch meat","ham","pepperoni","salami","prosciutto","rotisserie"] },
  { label: "üõí Other",              keys: [] },
];

function classifyItem(text) {
  const lower = text.toLowerCase();
  for (const section of STORE_SECTIONS) {
    if (section.keys.length && section.keys.some(k => lower.includes(k))) return section.label;
  }
  return "üõí Other";
}

function renderGroceryList(items) {
  const body = document.getElementById("g-body");
  if (!items.length) { body.innerHTML = `<p style="color:#8a8f9e;font-size:13px;padding:12px 0">No ingredients found.</p>`; return; }

  // Group by store section
  const sections = {};
  items.forEach((item, i) => {
    const sec = classifyItem(item.text);
    if (!sections[sec]) sections[sec] = [];
    sections[sec].push({ item, i });
  });

  // Render in STORE_SECTIONS order
  let html = '';
  for (const { label } of STORE_SECTIONS) {
    if (!sections[label]) continue;
    html += `<div style="margin-bottom:4px">
      <div style="padding:8px 6px 4px;font-size:10px;font-family:monospace;letter-spacing:.08em;text-transform:uppercase;color:#445;border-bottom:1px solid #1e2330;margin-bottom:2px">${label}</div>
      ${sections[label].map(({item,i}) => groceryRowHTML(item, i)).join("")}
    </div>`;
  }
  body.innerHTML = html;
}

function filterGrocery(q) {
  const lower = q.toLowerCase();
  const body = document.getElementById("g-body");
  const filtered = groceryItems.filter(item =>
    item.text.toLowerCase().includes(lower) || item.recipes.some(r => r.toLowerCase().includes(lower))
  );
  if (!filtered.length) { body.innerHTML = `<p style="color:#8a8f9e;font-size:13px;padding:12px 0">No matches.</p>`; return; }
  body.innerHTML = filtered.map(item => groceryRowHTML(item, groceryItems.indexOf(item))).join("");
}

function selectAllGrocery(val) {
  groceryItems.forEach(item => item.checked = val);
  renderGroceryList(groceryItems);
  updateGroceryCount();
}

function updateGroceryCount() {
  const checkedItems = groceryItems.filter(i => i.checked);
  const cost = checkedItems.reduce((s, i) => s + (i.cost || 0), 0);
  document.getElementById("g-selected-count").textContent =
    `${checkedItems.length} of ${groceryItems.length} ¬∑ ~$${cost.toFixed(0)} est.`;
}

function closeGrocery() { document.getElementById("grocery-modal").classList.remove("show"); }

function copyCheckedGrocery() {
  const checkedItems = groceryItems.filter(i => i.checked);
  const lines = checkedItems.map(i => `‚òê ${i.text}`);
  const totalCost = checkedItems.reduce((s, i) => s + (i.cost || 0), 0);
  const text = `üõí GROCERY LIST\n\n${lines.join("\n")}\n\nüí∞ Estimated total: ~$${totalCost.toFixed(0)}`;
  navigator.clipboard.writeText(text).then(() => {
    const b = event.target; b.textContent = "‚úÖ Copied!";
    setTimeout(() => b.textContent = "üìã Copy checked", 2000);
  });
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ

// ‚îÄ‚îÄ Sharing ‚îÄ‚îÄ
async function openShareModal() {
  document.getElementById("share-modal").style.display = "flex";
  await loadShares();
}

function closeShareModal() {
  document.getElementById("share-modal").style.display = "none";
  document.getElementById("share-msg").textContent = "";
  document.getElementById("share-email").value = "";
}

async function loadShares() {
  const list = document.getElementById("share-list");
  list.innerHTML = '<div style="font-size:13px;color:var(--text3)">Loading...</div>';
  try {
    const shares = await api("library-shares");
    if (!Array.isArray(shares) || shares.length === 0) {
      list.innerHTML = '<div style="font-size:13px;color:var(--text3)">No one has access yet.</div>';
      return;
    }
    list.innerHTML = shares.map(s => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border-radius:8px;border:1px solid var(--border)">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;flex-shrink:0">
          ${s.shared_with_email[0].toUpperCase()}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.shared_with_email}</div>
          <div style="font-size:11px;color:var(--text3);font-family:monospace">${s.shared_with_id ? '\u2713 Account linked' : '\u23f3 Pending sign up'}</div>
        </div>
        <select onchange="updateSharePerm('${s.id}', this.value)"
          style="background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text2);font-size:12px;outline:none;cursor:pointer">
          <option value="view" ${s.permission === 'view' ? 'selected' : ''}>View only</option>
          <option value="edit" ${s.permission === 'edit' ? 'selected' : ''}>Can edit</option>
        </select>
        <button onclick="revokeShare('${s.id}')"
          style="background:none;border:1px solid #4a2020;color:#f87171;border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer">
          Revoke
        </button>
      </div>
    `).join('');
  } catch(e) {
    list.innerHTML = '<div style="font-size:13px;color:#f87171">Failed to load shares.</div>';
  }
}

async function inviteUser() {
  const email = document.getElementById("share-email").value.trim();
  const permission = document.getElementById("share-perm").value;
  const msg = document.getElementById("share-msg");
  const btn = document.getElementById("share-invite-btn");
  if (!email) { msg.style.color = "#f87171"; msg.textContent = "Please enter an email."; return; }
  btn.disabled = true; btn.textContent = "Inviting...";
  msg.textContent = "";
  try {
    const res = await api("library-shares", "POST", { email, permission });
    if (res.error) {
      msg.style.color = "#f87171"; msg.textContent = res.error;
    } else {
      msg.style.color = "#7bcf8e";
      msg.textContent = res.userFound
        ? "\u2713 " + email + " now has " + permission + " access."
        : "\u2713 Invited! They'll get access when they sign up.";
      document.getElementById("share-email").value = "";
      await loadShares();
    }
  } catch(e) {
    msg.style.color = "#f87171"; msg.textContent = "Something went wrong.";
  }
  btn.disabled = false; btn.textContent = "Invite";
}

async function updateSharePerm(id, permission) {
  await api("library-shares", "PATCH", { id, permission });
}

async function revokeShare(id) {
  if (!confirm("Remove this person's access?")) return;
  await api("library-shares?id=" + id, "DELETE");
  await loadShares();
}

document.getElementById("share-modal").addEventListener("click", function(e) {
  if (e.target === document.getElementById("share-modal")) closeShareModal();
});


// ‚îÄ‚îÄ Edit Recipe Modal ‚îÄ‚îÄ
let editingId = null;

function openEditModal(id) {
  const r = recipes.find(x => x.id === id);
  if (!r) return;
  editingId = id;

  // Populate basic fields
  document.getElementById("edit-name").value = r.name || "";
  document.getElementById("edit-cat").value = r.category || "Lunch/Dinner";
  document.getElementById("edit-protein").value = r.protein || "";
  document.getElementById("edit-method").value = r.method || "";
  document.getElementById("edit-source").value = r.source || "";
  document.getElementById("edit-cost").value = r.cost || "";
  document.getElementById("edit-url").value = r.url || "";
  document.getElementById("edit-servings").value = getServings(id);
  document.getElementById("edit-modal-subtitle").textContent = "ID #" + id;
  document.getElementById("edit-msg").style.display = "none";

  // Populate ingredients
  const d = details[id] || {};
  renderEditIngredients(d.ingredients || []);
  renderEditSteps(d.steps || []);

  document.getElementById("edit-modal").style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeEditModal() {
  document.getElementById("edit-modal").style.display = "none";
  document.body.style.overflow = "";
  editingId = null;
}

function renderEditIngredients(ings) {
  const list = document.getElementById("edit-ingredients-list");
  list.innerHTML = ings.map((ing, i) => `
    <div style="display:flex;gap:6px;align-items:center" id="edit-ing-row-${i}">
      <input value="${esc(ing)}" onchange="updateEditIngredient(${i}, this.value)"
        style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
      <button onclick="removeEditIngredient(${i})" style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;line-height:1;padding:2px 6px" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#555'">√ó</button>
    </div>
  `).join("");
  list._data = [...ings];
}

function renderEditSteps(steps) {
  const list = document.getElementById("edit-steps-list");
  list.innerHTML = steps.map((step, i) => `
    <div style="display:flex;gap:6px;align-items:flex-start" id="edit-step-row-${i}">
      <span style="font-size:11px;color:var(--text3);font-family:monospace;padding-top:10px;min-width:18px;text-align:right">${i+1}.</span>
      <textarea onchange="updateEditStep(${i}, this.value)" rows="2"
        style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif;resize:vertical;line-height:1.5">${esc(step)}</textarea>
      <button onclick="removeEditStep(${i})" style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;line-height:1;padding:6px 6px 0" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#555'">√ó</button>
    </div>
  `).join("");
  list._data = [...steps];
}

function getEditIngredients() {
  return Array.from(document.getElementById("edit-ingredients-list").querySelectorAll("input"))
    .map(el => el.value.trim()).filter(Boolean);
}

function getEditSteps() {
  return Array.from(document.getElementById("edit-steps-list").querySelectorAll("textarea"))
    .map(el => el.value.trim()).filter(Boolean);
}

function updateEditIngredient(i, val) {
  document.getElementById("edit-ingredients-list")._data[i] = val;
}

function updateEditStep(i, val) {
  document.getElementById("edit-steps-list")._data[i] = val;
}

function removeEditIngredient(i) {
  const ings = getEditIngredients();
  ings.splice(i, 1);
  renderEditIngredients(ings);
}

function removeEditStep(i) {
  const steps = getEditSteps();
  steps.splice(i, 1);
  renderEditSteps(steps);
}

function addEditIngredient() {
  const ings = getEditIngredients();
  ings.push("");
  renderEditIngredients(ings);
  // Focus the new input
  const inputs = document.getElementById("edit-ingredients-list").querySelectorAll("input");
  inputs[inputs.length - 1]?.focus();
}

function addEditStep() {
  const steps = getEditSteps();
  steps.push("");
  renderEditSteps(steps);
  const tas = document.getElementById("edit-steps-list").querySelectorAll("textarea");
  tas[tas.length - 1]?.focus();
}

function showEditMsg(text, type) {
  const el = document.getElementById("edit-msg");
  el.style.display = "block";
  el.textContent = text;
  el.style.background = type === "error" ? "#2a1515" : "#152a1e";
  el.style.color = type === "error" ? "#f87171" : "#7bcf8e";
  el.style.border = "1px solid " + (type === "error" ? "#4a2020" : "#2a5a3e");
}

async function saveEdit() {
  if (!editingId) return;
  const btn = document.getElementById("edit-save-btn");
  btn.disabled = true; btn.textContent = "Saving...";

  const name = document.getElementById("edit-name").value.trim();
  if (!name) { showEditMsg("Recipe name is required.", "error"); btn.disabled = false; btn.textContent = "Save Changes"; return; }

  const updatedRecipe = {
    id: editingId,
    name,
    category: document.getElementById("edit-cat").value,
    protein: document.getElementById("edit-protein").value.trim() || "Other",
    method: document.getElementById("edit-method").value.trim() || "Stovetop",
    source: document.getElementById("edit-source").value.trim(),
    cost: document.getElementById("edit-cost").value.trim(),
    url: document.getElementById("edit-url").value.trim(),
  };

  const ingredients = getEditIngredients();
  const steps = getEditSteps();
  const servings = parseInt(document.getElementById("edit-servings").value) || 4;

  try {
    // Save recipe metadata
    await api("extra-recipes", "POST", updatedRecipe);

    // Save details
    await api("recipe-details", "POST", {
      recipe_id: editingId,
      ingredients,
      steps,
      servings,
    });

    // Update local state
    const idx = recipes.findIndex(r => r.id === editingId);
    if (idx !== -1) recipes[idx] = { ...recipes[idx], ...updatedRecipe };
    details[editingId] = { ingredients, steps, servings };

    showEditMsg("‚úì Saved!", "success");
    setTimeout(() => {
      closeEditModal();
      buildSelects();
      render();
    }, 600);
  } catch(e) {
    showEditMsg("Save failed. Please try again.", "error");
  }

  btn.disabled = false; btn.textContent = "Save Changes";
}

// Close on backdrop click
document.getElementById("edit-modal").addEventListener("click", function(e) {
  if (e.target === this) closeEditModal();
});



</script>

<!-- Share Modal -->
<div id="share-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:32px;width:100%;max-width:480px;margin:16px;box-shadow:0 24px 64px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
      <h2 style="font-family:'Playfair Display',serif;font-size:22px;color:var(--text)">üë• Share Library</h2>
      <button onclick="closeShareModal()" style="background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;line-height:1">√ó</button>
    </div>

    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Invite someone to view or edit your entire recipe library.</p>

    <!-- Invite form -->
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="share-email" type="email" placeholder="their@email.com"
        style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif"
        onkeydown="if(event.key==='Enter') inviteUser()">
      <select id="share-perm"
        style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-size:13px;outline:none;cursor:pointer">
        <option value="view">View only</option>
        <option value="edit">Can edit</option>
      </select>
      <button onclick="inviteUser()" id="share-invite-btn"
        style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:9px 16px;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap">
        Invite
      </button>
    </div>
    <div id="share-msg" style="font-size:12px;font-family:monospace;min-height:18px;margin-bottom:16px"></div>

    <!-- Current shares -->
    <div style="border-top:1px solid var(--border);padding-top:16px">
      <p style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;margin-bottom:12px">People with access</p>
      <div id="share-list" style="display:flex;flex-direction:column;gap:8px">
        <div style="font-size:13px;color:var(--text3)">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Recipe Modal -->
<div id="edit-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;align-items:flex-start;justify-content:center;overflow-y:auto;padding:24px 16px">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:100%;max-width:680px;margin:auto;box-shadow:0 24px 64px rgba(0,0,0,0.5)">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:24px 28px 20px;border-bottom:1px solid var(--border)">
      <div>
        <h2 style="font-family:'Playfair Display',serif;font-size:22px;color:var(--text);margin:0 0 4px">‚úè Edit Recipe</h2>
        <p style="font-size:12px;color:var(--text3);font-family:monospace;margin:0" id="edit-modal-subtitle"></p>
      </div>
      <button onclick="closeEditModal()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer;line-height:1;padding:4px">√ó</button>
    </div>

    <!-- Body -->
    <div style="padding:24px 28px;display:flex;flex-direction:column;gap:20px">

      <!-- Basic Info -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div style="grid-column:1/-1">
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Recipe Name</label>
          <input id="edit-name" type="text" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:14px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Category</label>
          <select id="edit-cat" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;cursor:pointer">
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch/Dinner">Lunch/Dinner</option>
            <option value="Salad">Salad</option>
            <option value="Side">Side</option>
            <option value="Dessert">Dessert</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Protein</label>
          <input id="edit-protein" type="text" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Method</label>
          <input id="edit-method" type="text" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Source</label>
          <input id="edit-source" type="text" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Est. Cost</label>
          <input id="edit-cost" type="text" placeholder="e.g. $10-13" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">URL</label>
          <input id="edit-url" type="url" placeholder="https://..." style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase;display:block;margin-bottom:5px">Servings</label>
          <input id="edit-servings" type="number" min="1" max="24" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;outline:none;font-family:'DM Sans',sans-serif">
        </div>
      </div>

      <!-- Ingredients -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase">Ingredients</label>
          <button onclick="addEditIngredient()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--accent);font-size:11px;padding:3px 10px;cursor:pointer;font-family:monospace">+ Add</button>
        </div>
        <div id="edit-ingredients-list" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto"></div>
      </div>

      <!-- Steps -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <label style="font-size:11px;color:var(--text3);font-family:monospace;letter-spacing:0.05em;text-transform:uppercase">Steps</label>
          <button onclick="addEditStep()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--accent);font-size:11px;padding:3px 10px;cursor:pointer;font-family:monospace">+ Add</button>
        </div>
        <div id="edit-steps-list" style="display:flex;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto"></div>
      </div>

      <!-- Message -->
      <div id="edit-msg" style="display:none;font-size:13px;font-family:monospace;padding:8px 12px;border-radius:8px"></div>

      <!-- Footer -->
      <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:4px;border-top:1px solid var(--border)">
        <button onclick="closeEditModal()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:9px 18px;color:var(--text2);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif">Cancel</button>
        <button onclick="saveEdit()" id="edit-save-btn" style="background:var(--accent);border:none;border-radius:8px;padding:9px 22px;color:#fff;font-size:13px;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif">Save Changes</button>
      </div>
    </div>
  </div>
</div>




<!-- Tutorial -->
<div id="tut-backdrop" style="display:none;position:fixed;inset:0;z-index:3000;background:transparent;pointer-events:all"></div>
<div id="tut-highlight" style="display:none;position:fixed;z-index:3001;border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,0.72);pointer-events:none;transition:left 0.25s,top 0.25s,width 0.25s,height 0.25s"></div>
<div id="tut-card" style="display:none;position:fixed;z-index:3002;background:#1a1f2e;border:1px solid #6e8efb;border-radius:14px;padding:20px 22px;width:290px;box-shadow:0 12px 40px rgba(0,0,0,0.7)">
  <div id="tut-arrow" style="position:absolute;width:12px;height:12px;background:#1a1f2e;border-left:1px solid #6e8efb;border-top:1px solid #6e8efb;"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:8px">
      <span id="tut-emoji" style="font-size:18px"></span>
      <strong id="tut-title" style="font-size:14px;color:#F5F0E8"></strong>
    </div>
    <button id="tut-x" style="background:none;border:none;color:#556;font-size:18px;cursor:pointer;line-height:1">√ó</button>
  </div>
  <p id="tut-body" style="margin:0 0 14px;font-size:13px;color:#b0b5c4;line-height:1.6"></p>
  <div style="display:flex;align-items:center;justify-content:space-between">
    <div id="tut-dots" style="display:flex;gap:4px"></div>
    <div style="display:flex;gap:6px">
      <button id="tut-skip" style="background:none;border:1px solid #2a2f3e;border-radius:6px;padding:5px 10px;color:#667;font-size:12px;cursor:pointer">Skip</button>
      <button id="tut-next" style="background:#6e8efb;border:none;border-radius:6px;padding:5px 14px;color:#fff;font-size:12px;cursor:pointer;font-weight:600">Next ‚Üí</button>
    </div>
  </div>
</div>

<script>
(function() {
  var STEPS = [
    { emoji:"üëã", title:"Welcome!", body:"This is your recipe library and meal planner. Let me show you around!", sel:null },
    { emoji:"üîç", title:"Search & Filter", body:"Search recipes by name, protein, or source. Use the dropdowns to filter by category, protein, or method.", sel:"input[placeholder*='Search']" },
    { emoji:"‚òëÔ∏è", title:"Select Recipes", body:"Check the box next to recipes to add them to your grocery list. Select multiple to combine ingredients.", sel:"input[type='checkbox']" },
    { emoji:"üõí", title:"Grocery List", body:"After selecting recipes, this button generates a combined shopping list with all ingredients.", sel:"#grocery-btn" },
    { emoji:"üìÖ", title:"Plan Your Week", body:"Open the weekly planner to drag recipes onto days, view your Google Calendar, and export meal plans.", sel:"button[onclick*='planner']" },
    { emoji:"‚ûï", title:"Add Recipes", body:"Click Add to create a new recipe. Paste in a URL and the app will try to auto-fill the details.", sel:"button[onclick*='toggleAdd']" },
    { emoji:"üë•", title:"Share Your Library", body:"Invite someone by email to view or edit your recipe library. They'll get an email invite.", sel:"button[onclick*='ShareModal']" },
    { emoji:"üéâ", title:"You're all set!", body:"Start by browsing, select some recipes, and hit Grocery List. Happy cooking!", sel:null },
  ];

  var idx = 0;
  var backdrop = document.getElementById("tut-backdrop");
  var highlight = document.getElementById("tut-highlight");
  var card = document.getElementById("tut-card");

  document.getElementById("tut-x").onclick = skip;
  document.getElementById("tut-skip").onclick = skip;
  document.getElementById("tut-next").onclick = next;
  backdrop.onclick = skip;

  function skip() {
    backdrop.style.display = "none";
    highlight.style.display = "none";
    card.style.display = "none";
    localStorage.setItem("tut-seen","1");
  }

  function next() {
    idx++;
    if (idx >= STEPS.length) { skip(); return; }
    show(idx);
  }

  function show(i) {
    var step = STEPS[i];
    document.getElementById("tut-emoji").textContent = step.emoji;
    document.getElementById("tut-title").textContent = step.title;
    document.getElementById("tut-body").textContent = step.body;
    document.getElementById("tut-next").textContent = i === STEPS.length - 1 ? "Done ‚úì" : "Next ‚Üí";
    document.getElementById("tut-dots").innerHTML = STEPS.map(function(_,j) {
      return '<div style="width:6px;height:6px;border-radius:50%;background:' + (j===i?'#6e8efb':'#2a2f3e') + '"></div>';
    }).join('');

    backdrop.style.display = "block";
    card.style.display = "block";

    var target = null;
    if (step.sel) {
      var sels = step.sel.split(", ");
      for (var s = 0; s < sels.length; s++) {
        target = document.querySelector(sels[s].trim());
        if (target) break;
      }
    }

    var arrow = document.getElementById("tut-arrow");
    if (target) {
      var r = target.getBoundingClientRect();
      var pad = 8;
      highlight.style.display = "block";
      highlight.style.left = (r.left - pad) + "px";
      highlight.style.top = (r.top - pad) + "px";
      highlight.style.width = (r.width + pad*2) + "px";
      highlight.style.height = (r.height + pad*2) + "px";

      var cardW = 290;
      var cardH = card.offsetHeight || 180;
      var spaceBelow = window.innerHeight - r.bottom;
      var spaceAbove = r.top;
      var left = Math.max(12, Math.min(r.left + r.width/2 - cardW/2, window.innerWidth - cardW - 12));

      if (spaceBelow >= cardH + 24 || spaceBelow >= spaceAbove) {
        // Card below target ‚Äî arrow points UP
        card.style.top = (r.bottom + 16) + "px";
        card.style.left = left + "px";
        card.style.transform = "";
        arrow.style.top = "-7px";
        arrow.style.left = (Math.min(r.left + r.width/2 - left - 6, cardW - 24)) + "px";
        arrow.style.transform = "rotate(45deg)";
        arrow.style.borderRight = "none";
        arrow.style.borderBottom = "none";
        arrow.style.borderLeft = "1px solid #6e8efb";
        arrow.style.borderTop = "1px solid #6e8efb";
      } else {
        // Card above target ‚Äî arrow points DOWN
        card.style.top = (r.top - cardH - 16) + "px";
        card.style.left = left + "px";
        card.style.transform = "";
        arrow.style.top = (cardH - 7) + "px";
        arrow.style.left = (Math.min(r.left + r.width/2 - left - 6, cardW - 24)) + "px";
        arrow.style.transform = "rotate(225deg)";
        arrow.style.borderRight = "none";
        arrow.style.borderBottom = "none";
        arrow.style.borderLeft = "1px solid #6e8efb";
        arrow.style.borderTop = "1px solid #6e8efb";
      }
      arrow.style.display = "block";
    } else {
      highlight.style.display = "none";
      arrow.style.display = "none";
      card.style.top = "50%";
      card.style.left = "50%";
      card.style.transform = "translate(-50%,-50%)";
    }
  }

  window.startTutorial = function() { idx = 0; show(0); };

  // Auto-show for first time users (wait for app to load)
  if (!localStorage.getItem("tut-seen")) {
    setTimeout(function() { window.startTutorial(); }, 1200);
  }
})();
</script>
</body>
</html>
