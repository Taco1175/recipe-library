<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>My Recipe Library</title>
<style>
:root {
  --bg: #0F1117;
  --bg2: #1a1f2e;
  --bg3: #12151f;
  --bg4: #1e2330;
  --border: #2a2f3e;
  --text: #E8E4DC;
  --text2: #9a9fae;
  --text3: #556;
  --accent: #6e8efb;
  --green: #4CAF50;
  --green-bg: #E8F5E9;
  --green-text: #1B5E20;
  --red: #e07070;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: Georgia, serif; min-height: 100vh; }
a { color: var(--accent); }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app { display: block; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  background: linear-gradient(135deg, #1a1f2e, var(--bg));
  border-bottom: 1px solid var(--border); padding: 20px 24px 18px;
  position: sticky; top: 0; z-index: 50;
}
.header-inner { max-width: 1300px; margin: 0 auto; }
.header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 10px; }
.header h1 { font-size: 24px; font-weight: 700; color: #F5F0E8; display: flex; align-items: center; gap: 10px; }
.header-actions { display: flex; gap: 8px; align-items: center; }
.count-badge { font-size: 12px; color: #888; font-family: monospace; font-weight: 400; }
.pills { display: flex; gap: 6px; flex-wrap: wrap; }
.pill {
  display: inline-flex; align-items: center; gap: 5px; border-radius: 20px;
  padding: 4px 12px; font-size: 11px; cursor: pointer; font-family: monospace;
  border: 1px solid var(--border); background: var(--bg4); color: #aaa;
  transition: all .2s; user-select: none;
}
.pill.active { border-color: var(--dot); background: var(--bg); color: var(--text); }
.pill .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; display: inline-block; flex-shrink: 0; }
.pill.active .dot { background: var(--dot); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { max-width: 1300px; margin: 0 auto; padding: 20px 24px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  border: none; border-radius: 8px; padding: 9px 16px; font-size: 13px;
  font-family: Georgia, serif; cursor: pointer; transition: all .2s;
  display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #5a7df0; }
.btn-primary:disabled { background: #3a4060; color: #666; cursor: default; }
.btn-success { background: #2d6a4f; color: #7bcf8e; border: 1px solid #3a8a65; }
.btn-success:hover { background: #3a7a5f; }
.btn-danger { background: #4a1a1a; color: var(--red); border: 1px solid #6a3030; font-size: 12px; padding: 6px 11px; }
.btn-danger:hover { background: #5a2a2a; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: #aaa; }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-ghost { background: transparent; border: none; color: var(--text2); padding: 8px 10px; }
.btn-ghost:hover { color: var(--text); }
.grocery-badge {
  background: var(--red); color: #fff; border-radius: 50%;
  width: 18px; height: 18px; display: inline-flex; align-items: center;
  justify-content: center; font-size: 10px; font-family: monospace;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.search-wrap { position: relative; flex: 1; min-width: 200px; }
.search-wrap input {
  width: 100%; background: var(--bg4); border: 1px solid var(--border);
  border-radius: 8px; padding: 9px 36px 9px 14px; color: var(--text);
  font-size: 14px; outline: none; font-family: Georgia, serif;
  transition: border-color .2s;
}
.search-wrap input:focus { border-color: var(--accent); }
.search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #556; cursor: pointer; font-size: 16px; padding: 2px; }
select.flt {
  background: var(--bg4); border: 1px solid var(--border); border-radius: 8px;
  padding: 9px 10px; color: var(--text); font-size: 12px; outline: none;
  font-family: Georgia, serif; cursor: pointer;
}

/* ‚îÄ‚îÄ INGREDIENT MATCHER ‚îÄ‚îÄ */
.fridge-bar {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; margin-bottom: 16px; display: none;
}
.fridge-bar.show { display: block; }
.fridge-bar h3 { font-size: 13px; color: #F5F0E8; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.fridge-row { display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; }
.fridge-row textarea {
  flex: 1; min-width: 200px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 12px; color: var(--text); font-size: 13px;
  outline: none; font-family: Georgia, serif; resize: vertical; min-height: 60px;
  transition: border-color .2s;
}
.fridge-row textarea:focus { border-color: var(--accent); }
.fridge-info { font-size: 11px; color: var(--text3); margin-top: 8px; font-family: monospace; }
.match-badge {
  display: inline-flex; align-items: center; gap: 4px; border-radius: 10px;
  padding: 2px 8px; font-size: 10px; font-family: monospace; font-weight: 600;
}
.match-full { background: #1a3a1a; color: #7bcf8e; border: 1px solid #2a5a2a; }
.match-partial { background: #2a2a10; color: #d4b84a; border: 1px solid #4a4a20; }

/* ‚îÄ‚îÄ COUNT ‚îÄ‚îÄ */
.count { font-size: 12px; color: #666; font-family: monospace; margin-bottom: 12px; }
.clear-link { cursor: pointer; margin-left: 10px; color: var(--accent); text-decoration: underline; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.thead {
  display: grid; grid-template-columns: 28px 1fr 90px 100px 100px 50px 48px 30px;
  padding: 10px 14px; background: var(--bg3); border-bottom: 1px solid var(--border);
  font-size: 10px; letter-spacing: .08em; text-transform: uppercase;
  color: var(--text3); font-family: monospace; gap: 8px; align-items: center;
}
.trow-wrap { border-bottom: 1px solid var(--bg4); }
.trow-wrap:last-child { border-bottom: none; }
.trow {
  display: grid; grid-template-columns: 28px 1fr 90px 100px 100px 50px 48px 30px;
  padding: 11px 14px; align-items: center; gap: 8px; cursor: pointer;
  transition: background .15s;
}
.trow:hover { background: var(--bg4); }
.recipe-name { font-size: 13px; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 6px; min-width: 0; }
.recipe-name-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.expand-icon { font-size: 8px; color: #445; transition: transform .2s; flex-shrink: 0; }
.trow-wrap.open .expand-icon { transform: rotate(90deg); }
.has-details .recipe-name { color: #b8d8ff; }
.no-details-hint { font-size: 9px; color: #334; font-family: monospace; flex-shrink: 0; }
.badge { display: inline-flex; align-items: center; gap: 3px; border-radius: 10px; padding: 2px 8px; font-size: 10px; font-family: monospace; white-space: nowrap; }
.badge .dot { width: 4px; height: 4px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
.meta { font-size: 11px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cost { font-size: 11px; color: #7bcf8e; font-family: monospace; font-weight: 600; }
.link-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 26px; height: 26px; border-radius: 6px; background: #1e2a3a;
  border: 1px solid #2a3f5e; color: var(--accent); font-size: 11px;
  text-decoration: none; transition: all .15s; flex-shrink: 0;
}
.link-btn:hover { background: #2a3f5e; }
input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; }

/* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
.detail-panel { display: none; padding: 0 14px 18px 46px; background: #0e1118; border-top: 1px solid var(--bg4); }
.trow-wrap.open .detail-panel { display: block; }
.detail-inner { display: grid; grid-template-columns: 1fr 1.6fr; gap: 24px; padding-top: 18px; }
.detail-section h3 { font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--text3); font-family: monospace; margin-bottom: 8px; }
.ing-list { list-style: none; }
.ing-list li { font-size: 12px; color: #c0c8da; padding: 3px 0 3px 12px; border-bottom: 1px solid #1a1f2e; position: relative; line-height: 1.4; }
.ing-list li:last-child { border-bottom: none; }
.ing-list li::before { content: "¬∑"; color: var(--accent); position: absolute; left: 0; }
.steps-list { list-style: none; counter-reset: steps; }
.steps-list li { font-size: 12px; color: #c0c8da; padding: 6px 0 6px 28px; border-bottom: 1px solid #1a1f2e; position: relative; counter-increment: steps; line-height: 1.5; }
.steps-list li:last-child { border-bottom: none; }
.steps-list li::before {
  content: counter(steps); position: absolute; left: 0; top: 6px;
  width: 18px; height: 18px; background: #1e2a3a; border: 1px solid #2a3f5e;
  border-radius: 50%; font-size: 9px; color: var(--accent); font-family: monospace;
  text-align: center; line-height: 18px;
}
.detail-actions { margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap; }
.detail-loading { display: flex; align-items: center; gap: 10px; color: var(--text2); font-size: 13px; padding: 18px 0; }
.spinner { width: 15px; height: 15px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ ADD PANEL ‚îÄ‚îÄ */
.add-panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 18px; display: none; }
.add-panel.show { display: block; }
.add-panel h2 { font-size: 15px; color: #F5F0E8; margin-bottom: 14px; }
.add-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.field label { display: block; font-size: 10px; color: var(--text3); font-family: monospace; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 4px; }
.field input, .field select {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 10px; color: var(--text); font-size: 13px;
  outline: none; font-family: Georgia, serif; transition: border-color .2s;
}
.field input:focus, .field select:focus { border-color: var(--accent); }
.field.full { grid-column: 1/-1; }
.url-row { display: flex; gap: 8px; align-items: flex-end; }
.url-row .field { flex: 1; margin: 0; }
.add-msg { font-size: 12px; font-family: monospace; padding: 8px 10px; border-radius: 6px; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
.add-msg.error { background: #2a1515; color: var(--red); border: 1px solid #4a2020; }
.add-msg.success { background: #152a1e; color: #7bcf8e; border: 1px solid #2a5a3e; }
.add-msg.loading { background: var(--bg2); color: var(--text2); border: 1px solid var(--border); }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.8); z-index: 100;
  display: none; align-items: flex-start; justify-content: center;
  padding: 24px 16px; overflow-y: auto;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
  width: 100%; max-width: 640px; padding: 28px; position: relative;
  margin: auto;
}
.modal h2 { font-size: 20px; color: #F5F0E8; margin-bottom: 4px; }
.modal .subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.modal-close { position: absolute; top: 14px; right: 14px; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
.modal-close:hover { background: var(--border); color: var(--text); }
.g-section { margin-bottom: 18px; }
.g-section h3 { font-size: 11px; letter-spacing: .1em; text-transform: uppercase; color: var(--accent); font-family: monospace; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
.g-item { display: flex; align-items: baseline; gap: 8px; padding: 5px 0; font-size: 14px; color: #c8d0e0; border-bottom: 1px solid #141820; }
.g-item:last-child { border-bottom: none; }
.g-item::before { content: "‚òê"; color: #4a5070; font-size: 12px; flex-shrink: 0; }
.g-from { font-size: 10px; color: #445; font-family: monospace; margin-left: auto; flex-shrink: 0; padding-left: 8px; }
.modal-footer { margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }

/* ‚îÄ‚îÄ MATCH RESULTS ‚îÄ‚îÄ */
.match-result-header { font-size: 12px; color: var(--text2); margin-bottom: 10px; font-family: monospace; }
.match-score-bar { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
.score-track { flex: 1; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 2px; transition: width .4s; }
.score-pct { font-size: 10px; font-family: monospace; color: var(--text3); width: 28px; text-align: right; }

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty { padding: 40px; text-align: center; color: #555; font-size: 14px; }
.footer-note { margin-top: 12px; font-size: 11px; color: #444; text-align: center; font-family: monospace; }

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 700px) {
  .header { padding: 14px 16px 12px; }
  .header h1 { font-size: 20px; }
  .main { padding: 14px 16px; }
  .thead { display: none; }
  .trow {
    grid-template-columns: 28px 1fr 28px;
    grid-template-rows: auto auto;
  }
  .trow > *:nth-child(3),
  .trow > *:nth-child(4),
  .trow > *:nth-child(5),
  .trow > *:nth-child(6) { display: none; }
  .trow > *:nth-child(7) { grid-column: 3; grid-row: 1; }
  .recipe-name { font-size: 13px; }
  .recipe-mobile-meta { grid-column: 2; font-size: 11px; color: var(--text2); }
  .detail-panel { padding: 0 10px 16px 10px; }
  .detail-inner { grid-template-columns: 1fr; gap: 16px; }
  .add-grid { grid-template-columns: 1fr; }
  .field.full { grid-column: 1; }
  .modal { padding: 20px 16px; }
  .topbar { gap: 6px; }
  .pills { gap: 5px; }
}
</style>
</head>
<body>

<!-- APP -->
<div id="app">
  <div class="header">
    <div class="header-inner">
      <div class="header-top">
        <h1>üçΩ My Recipe Library <span class="count-badge" id="total-badge"></span></h1>
        <div class="header-actions">
          <button class="btn btn-outline" style="font-size:12px" onclick="toggleFridge()">ü•¶ What's in my fridge?</button>
          <button class="btn btn-outline" style="font-size:12px" onclick="toggleAdd()">Ôºã Add</button>
          <button class="btn btn-success" id="grocery-btn" onclick="openGrocery()" style="display:none">
            üõí <span class="grocery-badge" id="grocery-count">0</span>
          </button>
        </div>
      </div>
      <div class="pills" id="pills"></div>
    </div>
  </div>

  <div class="main">

    <!-- Fridge bar -->
    <div class="fridge-bar" id="fridge-bar">
      <h3>ü•¶ What's in my fridge? <span style="font-size:11px;color:var(--text3);font-family:monospace;font-weight:400">‚Äî find recipes you can make</span></h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <!-- Searchable dropdown trigger -->
        <div style="position:relative;flex:1;min-width:220px;" id="fridge-dropdown-wrap">
          <input id="fridge-search" type="text" placeholder="Search ingredients to add..."
            oninput="fridgeDropdownFilter(this.value)" onfocus="showFridgeDropdown()" onblur="setTimeout(()=>{document.getElementById('fridge-dropdown').style.display='none'},200)"
            autocomplete="off"
            style="width:100%;background:#12151f;border:1px solid #2a2f3e;border-radius:8px;padding:9px 14px;color:#E8E4DC;font-size:13px;outline:none;font-family:Georgia,serif;">
          <div id="fridge-dropdown" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#1a1f2e;border:1px solid #2a2f3e;border-radius:8px;max-height:220px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.4);">
          </div>
        </div>
        <button class="btn btn-primary" onclick="runFridgeMatch()">üîç Find Recipes</button>
        <button class="btn btn-outline" onclick="clearMatch()">Clear</button>
      </div>
      <!-- Selected ingredient chips -->
      <div id="fridge-chips" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
      <div class="fridge-info" id="fridge-info"></div>
    </div>

    <!-- Add panel -->
    <div class="add-panel" id="add-panel">
      <h2>‚ûï Add New Recipe</h2>
      <div class="add-grid">
        <div class="field full url-row">
          <div class="field"><label>Recipe URL</label><input type="url" id="new-url" placeholder="https://..."></div>
        </div>
        <div class="field"><label>Recipe Name</label><input type="text" id="new-name" placeholder="Auto-filled"></div>
        <div class="field"><label>Category</label>
          <select id="new-cat">
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch/Dinner" selected>Lunch/Dinner</option>
            <option value="Salad">Salad</option>
            <option value="Side">Side</option>
            <option value="Dessert">Dessert</option>
          </select>
        </div>
        <div class="field"><label>Protein</label><input type="text" id="new-protein" placeholder="e.g. Chicken"></div>
        <div class="field"><label>Method</label><input type="text" id="new-method" placeholder="e.g. Slow Cooker"></div>
        <div class="field"><label>Source</label><input type="text" id="new-source" placeholder="e.g. Kay Nutrition"></div>
        <div class="field"><label>Est. Aldi Cost</label><input type="text" id="new-cost" placeholder="e.g. $10-13"></div>
      </div>
      <div id="add-msg" style="display:none" class="add-msg"></div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="saveNew()">Save Recipe</button>
        <button class="btn btn-outline" onclick="toggleAdd()">Cancel</button>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Search recipes‚Ä¶" oninput="onSearch(this.value)">
        <button class="search-clear" onclick="clearSearch()" title="Clear">√ó</button>
      </div>
      <select class="flt" id="filterProt" onchange="fProt=this.value;render()"><option value="">All Proteins</option></select>
      <select class="flt" id="filterMeth" onchange="fMeth=this.value;render()"><option value="">All Methods</option></select>
      <select class="flt" id="sortBy" onchange="sort=this.value;render()">
        <option value="category">Category</option>
        <option value="name">Name A-Z</option>
        <option value="protein">Protein</option>
        <option value="method">Method</option>
        <option value="cost">Cost ‚Üë</option>
        <option value="match">Match %</option>
      </select>
    </div>

    <div class="count" id="count"></div>

    <div class="table">
      <div class="thead">
        <div></div><div>Recipe</div><div>Category</div><div>Method</div><div>Source</div><div>Cost</div><div id="match-col-header"></div><div></div>
      </div>
      <div id="rows"></div>
    </div>
    <div class="footer-note">Blue = has saved details ¬∑ Click row to expand ¬∑ ‚úì to add to grocery list</div>
  </div>
</div>

<!-- Grocery Modal -->
<div class="modal-overlay" id="grocery-modal" onclick="if(event.target===this)closeGrocery()">
  <div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column;">
    <button class="modal-close" onclick="closeGrocery()">‚úï</button>
    <h2>üõí Grocery List</h2>
    <p class="subtitle" id="g-subtitle"></p>

    <!-- Search bar -->
    <input id="g-search" type="text" placeholder="Search ingredients..." oninput="filterGrocery(this.value)"
      style="width:100%;background:#12151f;border:1px solid #2a2f3e;border-radius:8px;padding:9px 14px;color:#E8E4DC;font-size:13px;outline:none;margin-bottom:12px;font-family:Georgia,serif;">

    <!-- Select all / none -->
    <div style="display:flex;gap:10px;margin-bottom:10px;font-size:12px;font-family:monospace;">
      <span onclick="selectAllGrocery(true)" style="color:#6e8efb;cursor:pointer;text-decoration:underline">Select all</span>
      <span onclick="selectAllGrocery(false)" style="color:#6e8efb;cursor:pointer;text-decoration:underline">Deselect all</span>
      <span id="g-selected-count" style="color:#666;margin-left:auto"></span>
    </div>

    <!-- Ingredient list -->
    <div id="g-body" style="overflow-y:auto;flex:1;min-height:0;"></div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="copyCheckedGrocery()">üìã Copy checked</button>
      <button class="btn btn-primary" onclick="closeGrocery()">Done</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ BASE RECIPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE = [
  {id:1,name:"Freezer Breakfast Burritos",category:"Breakfast",protein:"Turkey & Beef",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/472-cal-freezer-breakfast-burritos/",cost:"$8-10"},
  {id:2,name:"Meal Prep Breakfast Burritos",category:"Breakfast",protein:"Sausage & Eggs",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-breakfast-burritos/",cost:"$9-12"},
  {id:3,name:"Veggie-Loaded Egg Scramble",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:4,name:"Protein Yogurt Bowl",category:"Breakfast",protein:"Protein Powder",method:"No Cook",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$3-5"},
  {id:5,name:"Cauliflower & Egg Fried Rice Breakfast Bowl",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:6,name:"Savory Egg Muffin Veggie Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:7,name:"Spinach Breakfast Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-breakfast-casserole/",cost:"$5-7"},
  {id:8,name:"Breakfast Egg Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/breakfast-egg-bake/",cost:"$5-7"},
  {id:9,name:"Spinach Egg Muffins with Feta",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-egg-muffins-with-feta/",cost:"$5-8"},
  {id:10,name:"Bacon Egg Muffin Cups",category:"Breakfast",protein:"Eggs & Bacon",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/bacon-egg-muffin-cups/",cost:"$6-9"},
  {id:11,name:"Greek Omelette Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-omelette-casserole/",cost:"$6-8"},
  {id:12,name:"Egg Muffins with Red Pepper & Spinach",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/egg-muffins-red-pepper-spinach/",cost:"$4-6"},
  {id:13,name:"Big Chicken Caesar Salad",category:"Salad",protein:"Chicken",method:"Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/456-cal-big-as-chicken-caesar-salad/",cost:"$12-15"},
  {id:14,name:"Meal Prep Taco Salad",category:"Salad",protein:"Ground Beef/Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-taco-salad/",cost:"$10-13"},
  {id:15,name:"Mediterranean Tuna Pasta Salad",category:"Salad",protein:"Tuna",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/mediterranean-tuna-pasta-salad/",cost:"$7-10"},
  {id:16,name:"Chicken Shawarma Salad",category:"Salad",protein:"Chicken",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-shawarma-salad/",cost:"$10-13"},
  {id:17,name:"Ground Taco Meat with Cauliflower Rice",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"Clean & Delicious",url:"https://cleananddelicious.com/ground-taco-meat-with-cauliflower-rice/",cost:"$10-13"},
  {id:18,name:"Cauliflower Chicken Fried Rice",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/326-cal-cauliflower-chicken-fried-rice/",cost:"$10-13"},
  {id:19,name:"XL Grinder Salad Wraps",category:"Lunch/Dinner",protein:"Deli Chicken",method:"No Cook",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/516-cal-xl-grinder-salad-wraps/",cost:"$12-15"},
  {id:20,name:"Chicken Tenders & Fries",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/518-cal-chicken-tenders-the-easiest-fries-meal/",cost:"$10-13"},
  {id:21,name:"Slow Cooker Beef Barbacoa",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Taste of Home",url:"https://www.tasteofhome.com/recipes/slow-cooker-beef-barbacoa/",cost:"$15-20"},
  {id:22,name:"Chickpea and Chorizo Taco Soup",category:"Lunch/Dinner",protein:"Chorizo",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:23,name:"Slow Cooker Southwest Sweet Potato Chili",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:24,name:"Creamy Taco Soup",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$9-12"},
  {id:25,name:"Slow Cooker Chicken Fajitas",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:26,name:"Copycat KFC Famous Bowls",category:"Lunch/Dinner",protein:"Chicken",method:"Oven / Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:27,name:"Tex-Mex Roasted Veggie Quesadillas",category:"Lunch/Dinner",protein:"Vegetarian",method:"Oven",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$7-10"},
  {id:28,name:"Copycat Bacon Cheeseburger Hamburger Helper",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:29,name:"Taco Salad with Pan Fried Tortilla Strips",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-12"},
  {id:30,name:"Honey Sriracha Shrimp Fried Cauliflower Rice",category:"Lunch/Dinner",protein:"Shrimp",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$12-15"},
  {id:31,name:"Microwavable BBQ Chicken Pasta Bake",category:"Lunch/Dinner",protein:"Chicken",method:"Microwave",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:32,name:"Pan Roasted Corn & Black Bean Burrito Bowls",category:"Lunch/Dinner",protein:"Vegetarian",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$6-9"},
  {id:33,name:"Slow Cooker Pesto Chicken Pasta",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:34,name:"Slow Cooker Sesame Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:35,name:"Slow Cooker Chicken Shawarma",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:36,name:"Slow Cooker Salsa Verde Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$8-11"},
  {id:37,name:"Slow Cooker BBQ Wings",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-14"},
  {id:38,name:"BBQ Pulled Pork Lettuce Wraps",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$12-16"},
  {id:39,name:"Crockpot Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:40,name:"Slow Cooker Turkey Meatball Subs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:41,name:"Chipotle Chicken Tacos",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:42,name:"Slow Cooker Chicken Adobo",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$9-12"},
  {id:43,name:"Slow Cooker Meatball Soup",category:"Lunch/Dinner",protein:"Beef/Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:44,name:"Crockpot Pork Carnitas",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$13-17"},
  {id:45,name:"Slow Cooker Thai Chicken Lettuce Wraps",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:46,name:"Slow Cooker Chicken Tortilla Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:47,name:"Slow Cooker Beef Carnitas",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$14-18"},
  {id:48,name:"Korean Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/korean-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:49,name:"Turkey Taco Skillet",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/turkey-taco-skillet/",cost:"$9-12"},
  {id:50,name:"Firecracker Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/firecracker-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:51,name:"Chicken Broccoli Rice Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-broccoli-rice-casserole/",cost:"$10-13"},
  {id:52,name:"Greek Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-turkey-meatballs/",cost:"$9-12"},
  {id:53,name:"Greek Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-chicken-casserole/",cost:"$11-14"},
  {id:54,name:"Sheet Pan Chicken and Broccoli",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-chicken-and-broccoli/",cost:"$9-12"},
  {id:55,name:"Spaghetti Squash Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spaghetti-squash-casserole/",cost:"$10-13"},
  {id:56,name:"Spinach Artichoke Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-artichoke-chicken-casserole/",cost:"$11-14"},
  {id:57,name:"Shredded Beef Tacos",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Kay Nutrition",url:"https://kaynutrition.com/shredded-beef-tacos/",cost:"$14-18"},
  {id:58,name:"Beef Shawarma",category:"Lunch/Dinner",protein:"Beef",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-shawarma/",cost:"$13-16"},
  {id:59,name:"Ground Turkey Meal Prep Bowls",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/ground-turkey-meal-prep-bowls/",cost:"$9-12"},
  {id:60,name:"Stuffed Pepper Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/stuffed-pepper-casserole/",cost:"$10-13"},
  {id:61,name:"Beef and Mushroom Stew",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-and-mushroom-stew/",cost:"$13-16"},
  {id:62,name:"Sheet Pan Steak Fajitas",category:"Lunch/Dinner",protein:"Beef",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-steak-fajitas/",cost:"$14-18"},
  {id:63,name:"Sheet Pan Bruschetta Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-bruschetta-chicken/",cost:"$10-13"},
  {id:64,name:"Chicken Burrito Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-burrito-casserole/",cost:"$10-13"},
  {id:65,name:"Meal Prep Instant Noodle Cups",category:"Lunch/Dinner",protein:"Chicken",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-instant-noodle-cups/",cost:"$8-11"},
  {id:66,name:"Air Fryer Broccoli",category:"Side",protein:"None",method:"Air Fryer",source:"Eating Bird Food",url:"https://www.eatingbirdfood.com/air-fryer-broccoli/",cost:"$2-4"},
  {id:67,name:"Honey Mustard Pan Roasted Brussels Sprouts",category:"Side",protein:"None",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$3-5"},
  {id:68,name:"Crock Pot Salsa Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Budget Bytes",url:"https://www.budgetbytes.com/crock-pot-salsa-chicken/",cost:"$7-10"},
  {id:69,name:"Crockpot Swedish Meatballs",category:"Lunch/Dinner",protein:"Beef (Frozen Meatballs)",method:"Slow Cooker",source:"Cooking in the Midwest",url:"https://cookinginthemidwest.com/blog/crockpot-swedish-meatballs/",cost:"$11-14"},
  {id:70,name:"Crockpot Chicken Parmesan Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Eating on a Dime",url:"https://www.eatingonadime.com/crock-pot-creamy-chicken-parmesan-soup/",cost:"$12-15"}
];

const CC={"Breakfast":{bg:"#FFF3E0",text:"#E65100",dot:"#FF9800"},"Lunch/Dinner":{bg:"#E8F5E9",text:"#1B5E20",dot:"#4CAF50"},"Salad":{bg:"#E3F2FD",text:"#0D47A1",dot:"#2196F3"},"Side":{bg:"#F3E5F5",text:"#4A148C",dot:"#9C27B0"},"Dessert":{bg:"#FCE4EC",text:"#880E4F",dot:"#E91E63"}};
const MI={"Slow Cooker":"ü•ò","Oven":"üî•","Stovetop":"üç≥","Air Fryer":"üí®","No Cook":"ü•ó","Microwave":"üì°","Stovetop / Air Fryer":"üç≥","Stovetop / Oven":"üç≥","Oven / Stovetop":"üî•","Slow Cooker / Stovetop":"ü•ò"};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let recipes = [...BASE];
let details = {};
let checked = new Set();
let fCat="", fProt="", fMeth="", sort="category", q="";
let matchScores = {}; // id -> {score, match, note}
let matchActive = false;
let pendingDetails = null;

function api(path, method="GET", body=null) {
  return fetch(`/.netlify/functions/${path}`, {
    method,
    headers: { "Content-Type":"application/json" },
    body: body ? JSON.stringify(body) : undefined
  }).then(r => r.json());
}

async function showApp() {
  await loadData();
  buildSelects();
  render();
}

async function loadData() {
  try {
    const [extraRes, detailsRes] = await Promise.all([
      api("extra-recipes"),
      api("recipe-details")
    ]);
    if (Array.isArray(extraRes)) {
      extraRes.forEach(r => { if (!recipes.find(x=>x.id===r.id)) recipes.push(r); });
    }
    if (Array.isArray(detailsRes)) {
      detailsRes.forEach(d => { details[d.recipe_id] = { ingredients: d.ingredients, steps: d.steps }; });
    }
  } catch(e) { console.error("Load error", e); }
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function getFiltered() {
  let list = recipes.filter(r => {
    const s = q.toLowerCase();
    const d = details[r.id];
    const ingText = (d?.ingredients||[]).join(' ').toLowerCase();
    const stepText = (d?.steps||[]).join(' ').toLowerCase();
    return (!s || r.name.toLowerCase().includes(s) || r.protein.toLowerCase().includes(s) || r.source.toLowerCase().includes(s) || ingText.includes(s) || stepText.includes(s))
      && (!fCat || r.category === fCat)
      && (!fProt || r.protein === fProt)
      && (!fMeth || r.method === fMeth)
      && (!matchActive || matchScores[r.id]);
  });
  list.sort((a,b) => {
    if (sort==="match") return (matchScores[b.id]?.score||0) - (matchScores[a.id]?.score||0);
    if (sort==="category") return a.category.localeCompare(b.category)||a.name.localeCompare(b.name);
    if (sort==="name") return a.name.localeCompare(b.name);
    if (sort==="protein") return a.protein.localeCompare(b.protein);
    if (sort==="method") return a.method.localeCompare(b.method);
    if (sort==="cost") return parseInt(a.cost||0)-parseInt(b.cost||0);
    return 0;
  });
  return list;
}

function buildPills() {
  const counts={};
  recipes.forEach(r=>counts[r.category]=(counts[r.category]||0)+1);
  document.getElementById("pills").innerHTML=Object.entries(counts).map(([cat,n])=>{
    const c=CC[cat]||{bg:"#333",text:"#ccc",dot:"#888"};
    return`<span class="pill${fCat===cat?" active":""}" data-cat="${cat}" style="--bg:${c.bg};--text:${c.text};--dot:${c.dot}"><span class="dot"></span>${cat} ¬∑ ${n}</span>`;
  }).join("");
  document.getElementById("pills").querySelectorAll(".pill").forEach(p=>p.addEventListener("click",()=>{fCat=fCat===p.dataset.cat?"":p.dataset.cat;render();}));
}

function buildSelects() {
  const prots=[...new Set(recipes.map(r=>r.protein))].sort();
  const meths=[...new Set(recipes.map(r=>r.method))].sort();
  const pc=document.getElementById("filterProt"),mc=document.getElementById("filterMeth");
  const pv=pc.value,mv=mc.value;
  pc.innerHTML=`<option value="">All Proteins</option>`+prots.map(p=>`<option${p===pv?" selected":""}>${p}</option>`).join("");
  mc.innerHTML=`<option value="">All Methods</option>`+meths.map(m=>`<option${m===mv?" selected":""}>${m}</option>`).join("");
}

function render() {
  buildPills();
  const list = getFiltered();
  document.getElementById("total-badge").textContent = recipes.length+" recipes";
  const hasFilter = fCat||fProt||fMeth||q||matchActive;
  document.getElementById("count").innerHTML = `Showing ${list.length} of ${recipes.length} recipes${hasFilter?'<span class="clear-link" onclick="clearAll()">Clear</span>':""}`;
  const gb = document.getElementById("grocery-btn");
  gb.style.display = checked.size > 0 ? "inline-flex" : "none";
  document.getElementById("grocery-count").textContent = checked.size;

  document.getElementById("match-col-header").textContent = matchActive ? "Match" : "";
  if (!list.length) { document.getElementById("rows").innerHTML='<div class="empty">No recipes match.</div>'; return; }
  document.getElementById("rows").innerHTML = list.map(r => {
    const c = CC[r.category]||{bg:"#333",text:"#ccc",dot:"#888"};
    const hd = !!details[r.id];
    const ms = matchScores[r.id];
    const matchCol = matchActive
      ? ms
        ? `<div><span class="match-badge ${ms.match==='full'?'match-full':'match-partial'}" title="${esc(ms.note)}">${ms.score}%</span></div>`
        : `<div><span style="font-size:11px;color:#444;font-family:monospace">‚Äî</span></div>`
      : `<div></div>`;
    return `<div class="trow-wrap" id="wrap-${r.id}">
  <div class="trow${hd?" has-details":""}" onclick="rowClick(event,${r.id})">
    <div style="display:flex;align-items:center;justify-content:center"><input type="checkbox"${checked.has(r.id)?" checked":""} onclick="chk(event,${r.id})"></div>
    <div class="recipe-name">
      <span class="expand-icon">‚ñ∂</span>
      <span class="recipe-name-text">${esc(r.name)}</span>
    </div>
    <div><span class="badge" style="background:${c.bg};color:${c.text}"><span class="dot" style="background:${c.dot}"></span>${r.category}</span></div>
    <div class="meta">${MI[r.method]||"üç¥"} ${r.method}</div>
    <div class="meta">${r.source}</div>
    <div class="cost">${r.cost}</div>
    ${matchCol}
    <div><a href="${r.url}" target="_blank" class="link-btn" onclick="event.stopPropagation()">‚Üó</a></div>
  </div>
  <div class="detail-panel" id="dp-${r.id}">
    ${hd ? detailHTML(r) : fetchPromptHTML(r)}
    ${ms ? `<div style="font-size:12px;color:#9a9fae;margin-top:12px;padding:8px;background:#1a1f2e;border-radius:6px">ü•¶ <strong>Matched:</strong> ${esc(ms.note)}</div>` : ""}
  </div>
</div>`;
  }).join("");
}

function detailHTML(r) {
  const d = details[r.id];
  return `<div class="detail-inner">
    <div class="detail-section"><h3>Ingredients</h3><ul class="ing-list">${d.ingredients.map(i=>`<li>${esc(i)}</li>`).join("")}</ul></div>
    <div class="detail-section"><h3>Instructions</h3><ol class="steps-list">${d.steps.map(s=>`<li>${esc(s)}</li>`).join("")}</ol></div>
  </div>`;
}

function fetchPromptHTML(r) {
  return `<div style="padding:16px 0"><p style="font-size:13px;color:#8a8f9e">No details available yet.</p></div>`;
}

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

// ‚îÄ‚îÄ Interactions ‚îÄ‚îÄ
function rowClick(e,id){if(e.target.type==="checkbox"||e.target.tagName==="A")return;document.getElementById("wrap-"+id)?.classList.toggle("open");}
function chk(e,id){e.stopPropagation();e.target.checked?checked.add(id):checked.delete(id);document.getElementById("grocery-btn").style.display=checked.size>0?"inline-flex":"none";document.getElementById("grocery-count").textContent=checked.size;}
function onSearch(v){q=v;render();}
function clearSearch(){document.getElementById("search").value="";q="";render();}
function clearAll(){fCat="";fProt="";fMeth="";q="";matchActive=false;matchScores={};fridgeSelected.clear();renderFridgeChips();document.getElementById("search").value="";document.getElementById("filterProt").value="";document.getElementById("filterMeth").value="";document.getElementById("fridge-search").value="";document.getElementById("fridge-info").textContent="";render();}
function toggleFridge(){document.getElementById("fridge-bar").classList.toggle("show");}
function toggleAdd(){document.getElementById("add-panel").classList.toggle("show");}

async function delDetails(id) {
  if (!confirm("Remove saved details?")) return;
  await api(`recipe-details?id=${id}`, "DELETE");
  delete details[id];
  render();
}

// ‚îÄ‚îÄ Add recipe ‚îÄ‚îÄ
async function saveNew() {
  const name = document.getElementById("new-name").value.trim();
  const url = document.getElementById("new-url").value.trim();
  if (!name) return addMsg("Please enter a recipe name.", "error");
  const nid = Math.max(...recipes.map(r=>r.id)) + 1;
  const nr = { id:nid, name, category:document.getElementById("new-cat").value, protein:document.getElementById("new-protein").value||"Other", method:document.getElementById("new-method").value||"Stovetop", source:document.getElementById("new-source").value||"Unknown", url, cost:document.getElementById("new-cost").value||"TBD" };
  recipes.push(nr);
  await api("extra-recipes","POST",nr);
  if (pendingDetails) {
    await api("recipe-details","POST",{ recipe_id:nid, ingredients:pendingDetails.ingredients, steps:pendingDetails.steps });
    details[nid] = pendingDetails;
    pendingDetails = null;
  }
  buildSelects();
  ["new-url","new-name","new-protein","new-method","new-source","new-cost"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("add-panel").classList.remove("show");
  document.getElementById("add-msg").style.display = "none";
  render();
  setTimeout(()=>{const w=document.getElementById("wrap-"+nid);if(w){w.scrollIntoView({behavior:"smooth",block:"center"});w.classList.add("open");}},200);
}

function addMsg(txt,type){const el=document.getElementById("add-msg");el.style.display="flex";el.className="add-msg "+type;el.innerHTML=type==="loading"?`<div class="spinner"></div>${txt}`:txt;}

// ‚îÄ‚îÄ Ingredient matcher ‚îÄ‚îÄ
// ‚îÄ‚îÄ Fridge / ingredient matcher (local, no AI) ‚îÄ‚îÄ
let fridgeSelected = new Set(); // selected ingredient strings

function cleanIngredient(raw) {
  return raw.trim()
    .replace(/\(.*?\)/g, '')
    .replace(/,.*$/, '')
    .replace(/^[\d\s\/\.\-¬Ω¬º¬æ‚Öì‚Öî‚Öõ]+/, '')
    .replace(/^(cups?|tbsps?|tsps?|tablespoons?|teaspoons?|oz|lbs?|pounds?|ounces?|g|kg|ml|l|cloves?|cans?|pkgs?|packages?|bunches?|slices?|pieces?|pinch|handful|sprigs?|strips?|scoops?|heads?|stalks?|inches?|inch)\s+/i, '')
    .replace(/^(large|medium|small|extra large|xl|fresh|dried|frozen|boneless|skinless|minced|chopped|diced|sliced|shredded|grated|cooked|raw|whole|ground|lean|organic|sweet|baby|yellow|white|red|green|purple)\s+/gi, '')
    .trim()
    .toLowerCase()
    .replace(/onions$/, 'onion')
    .replace(/peppers$/, 'pepper')
    .replace(/tomatoes$/, 'tomato')
    .replace(/potatoes$/, 'potato')
    .replace(/cloves$/, 'clove')
    .replace(/eggs$/, 'egg')
    .replace(/tortillas$/, 'tortilla')
    .replace(/mushrooms$/, 'mushroom')
    .replace(/avocados$/, 'avocado')
    .replace(/limes$/, 'lime')
    .replace(/lemons$/, 'lemon');
}

function getAllIngredients() {
  const all = new Set();
  Object.values(details).forEach(d => {
    (d.ingredients || []).forEach(ing => {
      const clean = cleanIngredient(ing);
      if (clean.length > 1) all.add(clean);
    });
  });
  return Array.from(all).sort();
}

function showFridgeDropdown() {
  fridgeDropdownFilter(document.getElementById("fridge-search").value);
  document.getElementById("fridge-dropdown").style.display = "block";
}

function fridgeDropdownFilter(q) {
  const dd = document.getElementById("fridge-dropdown");
  const all = getAllIngredients();
  const lower = q.toLowerCase();
  const filtered = all.filter(i => !fridgeSelected.has(i) && i.toLowerCase().includes(lower)).slice(0, 50);
  if (!filtered.length) { dd.innerHTML = `<div style="padding:10px 14px;color:#555;font-size:13px">No matches</div>`; return; }
  dd.innerHTML = filtered.map(ing => `
    <div onmousedown="event.preventDefault();fridgeAddIngredient(${JSON.stringify(ing)})"
      style="padding:9px 14px;font-size:13px;color:#c8d0e0;cursor:pointer;border-bottom:1px solid #12151f"
      onmouseover="this.style.background='#1e2330'" onmouseout="this.style.background='transparent'">
      ${esc(ing)}
    </div>`).join("");
  dd.style.display = "block";
}

function fridgeAddIngredient(ing) {
  fridgeSelected.add(ing);
  document.getElementById("fridge-search").value = "";
  document.getElementById("fridge-dropdown").style.display = "none";
  renderFridgeChips();
  if (fridgeSelected.size > 0) runFridgeMatch();
}

function renderFridgeChips() {
  const wrap = document.getElementById("fridge-chips");
  wrap.innerHTML = Array.from(fridgeSelected).map(ing => `
    <span style="display:inline-flex;align-items:center;gap:5px;background:#2a3550;border:1px solid #3d5a8a;border-radius:16px;padding:5px 12px;font-size:12px;color:#7eb8f7;font-family:monospace">
      ${esc(ing)}
      <span onclick="fridgeRemoveIngredient(${JSON.stringify(ing)})" style="cursor:pointer;color:#5a7aaa;font-size:15px;line-height:1;margin-left:2px" title="Remove">‚úï</span>
    </span>`).join("");
}

function fridgeRemoveIngredient(ing) {
  fridgeSelected.delete(ing);
  renderFridgeChips();
  if (fridgeSelected.size > 0) runFridgeMatch(); else clearMatch();
}

function runFridgeMatch() {
  if (!fridgeSelected.size) { document.getElementById("fridge-info").textContent = "Add some ingredients first."; return; }
  const userIngs = Array.from(fridgeSelected); // already cleaned
  matchScores = {};
  recipes.forEach(r => {
    const d = details[r.id];
    if (!d || !d.ingredients?.length) return;
    const recipeIngsCleaned = d.ingredients.map(i => cleanIngredient(i));
    const matched = userIngs.filter(u => recipeIngsCleaned.some(ri => ri.includes(u) || u.includes(ri)));
    const score = Math.round((matched.length / recipeIngsCleaned.length) * 100);
    if (score > 0) {
      const match = score >= 70 ? "full" : "partial";
      matchScores[r.id] = { score, match, note: `${matched.length} of ${recipeIngsCleaned.length} ingredients matched (${matched.join(", ")})` };
    }
  });
  matchActive = true;
  sort = "match";
  document.getElementById("sortBy").value = "match";
  const total = Object.keys(matchScores).length;
  document.getElementById("fridge-info").textContent = `‚úÖ Found ${total} recipes using your ingredients`;
  render();
}

function clearMatch() {
  matchScores = {}; matchActive = false; fridgeSelected.clear();
  renderFridgeChips();
  document.getElementById("fridge-search").value = "";
  document.getElementById("fridge-info").textContent = "";
  document.getElementById("fridge-dropdown").style.display = "none";
  if (sort === "match") { sort = "category"; document.getElementById("sortBy").value = "category"; }
  render();
}

// Close dropdown when clicking outside
// dropdown closed via onblur with delay

// ‚îÄ‚îÄ Grocery List ‚îÄ‚îÄ
let groceryItems = [];

const COST_DB = {
  // Proteins
  "chicken breast": 4.00, "chicken thigh": 3.50, "chicken wing": 5.00, "chicken": 3.50,
  "ground turkey": 5.00, "ground beef": 6.00, "turkey": 5.00, "beef": 7.00,
  "pork shoulder": 4.00, "pork butt": 4.00, "pork": 5.00,
  "shrimp": 8.00, "tuna": 2.50, "chorizo": 4.00, "sausage": 4.50, "bacon": 5.00,
  "frozen meatballs": 7.00, "meatballs": 7.00,
  // Dairy & Eggs
  "eggs": 4.00, "egg whites": 4.00, "cheddar cheese": 3.50, "mozzarella": 3.50,
  "parmesan": 4.00, "ricotta": 4.00, "feta": 3.50, "mexican cheese": 3.50,
  "heavy cream": 3.00, "sour cream": 2.00, "butter": 3.00, "cream cheese": 3.00,
  "yogurt": 3.00,
  // Produce
  "onion": 1.00, "garlic": 1.50, "bell pepper": 1.50, "spinach": 3.00,
  "avocado": 1.50, "tomato": 2.00, "jalapeno": 0.50, "jalape√±o": 0.50,
  "lime": 1.00, "lemon": 1.00, "cilantro": 1.00, "parsley": 1.00, "basil": 2.00,
  "green onion": 1.00, "mushroom": 3.00, "broccoli": 2.50, "cauliflower": 3.00,
  "zucchini": 1.50, "sweet potato": 2.00, "potato": 2.00, "brussels sprouts": 3.00,
  // Pantry/Canned
  "salsa verde": 3.50, "salsa": 3.00, "enchilada sauce": 2.50, "pesto": 4.00,
  "marinara": 3.00, "tomato sauce": 1.50, "crushed tomatoes": 2.00, "diced tomatoes": 1.50,
  "chicken broth": 2.50, "beef broth": 2.50, "vegetable broth": 2.00,
  "black beans": 1.50, "pinto beans": 1.50, "chickpeas": 1.50,
  "cream of mushroom soup": 2.00, "bread crumbs": 2.00,
  // Oils, Sauces
  "avocado oil": 6.00, "olive oil": 5.00, "coconut aminos": 5.00, "soy sauce": 2.50,
  "honey": 4.00, "rice vinegar": 2.50, "ketchup": 2.50, "bbq sauce": 3.00,
  "hot sauce": 2.00, "sriracha": 3.00, "peanut butter": 3.50, "cornstarch": 1.50,
  "oat flour": 3.00,
  // Grains & Carbs
  "pasta": 2.50, "rotini": 2.50, "egg noodles": 2.50, "chickpea pasta": 4.00,
  "cassava tortillas": 5.00, "corn tortillas": 3.00, "flour tortillas": 3.50, "tortillas": 3.50,
  "rice": 2.50, "cauliflower rice": 3.50, "tater tots": 3.50, "rolls": 3.00,
};

function estimateCost(ingredient) {
  if (!ingredient) return null;
  const lower = ingredient.toLowerCase();
  for (const [key, cost] of Object.entries(COST_DB)) {
    if (lower.includes(key)) return cost;
  }
  return null;
}

function normalizeUnit(meas) {
  if (!meas) return '';
  const m = meas.toLowerCase();
  if (['tablespoon','tablespoons'].includes(m)) return 'tbsp';
  if (['teaspoon','teaspoons'].includes(m)) return 'tsp';
  if (['pound','pounds','lbs'].includes(m)) return 'lb';
  if (['ounce','ounces'].includes(m)) return 'oz';
  return m;
}

function formatAmount(amount) {
  if (!amount || amount === 0) return '';
  const whole = Math.floor(amount);
  const frac = amount - whole;
  let fracStr = '';
  if (Math.abs(frac - 0.5) < 0.02) fracStr = '¬Ω';
  else if (Math.abs(frac - 0.25) < 0.02) fracStr = '¬º';
  else if (Math.abs(frac - 0.75) < 0.02) fracStr = '¬æ';
  else if (Math.abs(frac - (1/3)) < 0.02) fracStr = '‚Öì';
  else if (Math.abs(frac - (2/3)) < 0.02) fracStr = '‚Öî';
  else if (frac > 0.02) fracStr = Math.round(frac * 8) / 8 + '';
  if (whole > 0 && fracStr) return `${whole} ${fracStr}`;
  if (whole > 0) return `${whole}`;
  return fracStr || '';
}

async function openGrocery() {
  if (!checked.size) return;
  document.getElementById("grocery-modal").classList.add("show");
  const body = document.getElementById("g-body");
  body.innerHTML = `<div style="padding:24px;text-align:center;color:#556;font-family:monospace">Loading ingredients...</div>`;
  document.getElementById("g-search").value = "";

  const sel = recipes.filter(r => checked.has(r.id));
  document.getElementById("g-subtitle").textContent = `${sel.length} recipe${sel.length > 1 ? "s" : ""}`;

  // Fetch structured ingredients from DB
  let structuredRows = [];
  try {
    const res = await api("structured-ingredients", "POST", { recipe_ids: sel.map(r => r.id) });
    if (Array.isArray(res)) structuredRows = res;
  } catch(e) { console.error("structured-ingredients fetch failed", e); }

  const structuredIds = new Set(structuredRows.map(r => r.recipe_id));
  const fallbackRecipes = sel.filter(r => !structuredIds.has(r.id) && details[r.id]);
  const noDataRecipes = sel.filter(r => !structuredIds.has(r.id) && !details[r.id]);
  const recipeNames = {};
  sel.forEach(r => recipeNames[r.id] = r.name);

  // Merge structured rows by (ingredient_key, unit)
  const merged = {};
  structuredRows.forEach(row => {
    const ingKey = row.ingredient.trim().toLowerCase();
    const unit = normalizeUnit(row.measurement);
    const key = `${ingKey}|||${unit}`;
    if (!merged[key]) {
      merged[key] = {
        ingredient: row.ingredient.trim(),
        measurement: unit || null,
        amount: 0,
        hasAmount: false,
        recipes: [],
        cost: estimateCost(row.ingredient),
        sortKey: ingKey,
      };
    }
    if (row.amount) { merged[key].amount += parseFloat(row.amount); merged[key].hasAmount = true; }
    const rname = recipeNames[row.recipe_id];
    if (rname && !merged[key].recipes.includes(rname)) merged[key].recipes.push(rname);
  });

  // Fallback: use text ingredients for recipes without structured data
  fallbackRecipes.forEach(r => {
    (details[r.id].ingredients || []).forEach(ing => {
      const key = `__text__${ing.trim().toLowerCase()}`;
      if (!merged[key]) merged[key] = { ingredient: ing.trim(), measurement: null, amount: 0, hasAmount: false, recipes: [], cost: estimateCost(ing), sortKey: ing.trim().toLowerCase() };
      if (!merged[key].recipes.includes(r.name)) merged[key].recipes.push(r.name);
    });
  });

  // Build display items sorted alphabetically
  groceryItems = Object.values(merged)
    .sort((a, b) => a.sortKey.localeCompare(b.sortKey))
    .map(item => {
      const amtStr = item.hasAmount ? `${formatAmount(item.amount)}${item.measurement ? ' ' + item.measurement : ''}` : '';
      const text = amtStr ? `${amtStr} ${item.ingredient}` : item.ingredient;
      return { ...item, text, checked: true };
    });

  renderGroceryList(groceryItems);
  updateGroceryCount();

  // Cost summary banner
  const totalCost = groceryItems.reduce((s, i) => s + (i.cost || 0), 0);
  if (totalCost > 0) {
    body.innerHTML += `<div style="margin-top:14px;padding:10px 14px;background:#0f1f0f;border:1px solid #2a4a2a;border-radius:8px;font-size:12px;color:#6aaa6a;font-family:monospace">
      üí∞ Estimated total: <strong style="font-size:14px">~$${totalCost.toFixed(0)}</strong> <span style="color:#3a6a3a">(rough estimate, prices vary)</span>
    </div>`;
  }

  if (noDataRecipes.length) {
    body.innerHTML += `<div style="margin-top:10px;padding:10px;background:#1a1f2e;border:1px solid var(--border);border-radius:8px;font-size:12px;color:#8a8f9e">
      <strong style="color:#aaa">‚ö† No ingredient data for:</strong> ${noDataRecipes.map(r => esc(r.name)).join(", ")}
    </div>`;
  }
}

function groceryRowHTML(item, i) {
  const costStr = item.cost ? `<span style="color:#3a7a3a;font-size:11px;font-family:monospace;margin-left:6px">~$${item.cost.toFixed(2)}</span>` : '';
  const recipesStr = item.recipes.length ? `<span style="font-size:11px;color:#445;font-family:monospace;margin-left:6px">${item.recipes.map(esc).join(", ")}</span>` : '';
  return `<label style="display:flex;align-items:flex-start;gap:10px;padding:9px 6px;border-bottom:1px solid #1e2330;cursor:pointer;"
         onmouseover="this.style.background='#1e2330'" onmouseout="this.style.background='transparent'">
    <input type="checkbox" ${item.checked ? "checked" : ""}
      onchange="groceryItems[${i}].checked=this.checked;updateGroceryCount()"
      style="margin-top:3px;accent-color:#6e8efb;flex-shrink:0;width:15px;height:15px;cursor:pointer;">
    <div style="flex:1;min-width:0">
      <span style="font-size:13px;color:#E8E4DC;font-weight:500">${esc(item.text)}</span>
      ${costStr}${recipesStr}
    </div>
  </label>`;
}

function renderGroceryList(items) {
  const body = document.getElementById("g-body");
  if (!items.length) { body.innerHTML = `<p style="color:#8a8f9e;font-size:13px;padding:12px 0">No ingredients found.</p>`; return; }
  body.innerHTML = items.map((item, i) => groceryRowHTML(item, i)).join("");
}

function filterGrocery(q) {
  const lower = q.toLowerCase();
  const body = document.getElementById("g-body");
  const filtered = groceryItems.filter(item =>
    item.text.toLowerCase().includes(lower) || item.recipes.some(r => r.toLowerCase().includes(lower))
  );
  if (!filtered.length) { body.innerHTML = `<p style="color:#8a8f9e;font-size:13px;padding:12px 0">No matches.</p>`; return; }
  body.innerHTML = filtered.map(item => groceryRowHTML(item, groceryItems.indexOf(item))).join("");
}

function selectAllGrocery(val) {
  groceryItems.forEach(item => item.checked = val);
  renderGroceryList(groceryItems);
  updateGroceryCount();
}

function updateGroceryCount() {
  const checkedItems = groceryItems.filter(i => i.checked);
  const cost = checkedItems.reduce((s, i) => s + (i.cost || 0), 0);
  document.getElementById("g-selected-count").textContent =
    `${checkedItems.length} of ${groceryItems.length} ¬∑ ~$${cost.toFixed(0)} est.`;
}

function closeGrocery() { document.getElementById("grocery-modal").classList.remove("show"); }

function copyCheckedGrocery() {
  const checkedItems = groceryItems.filter(i => i.checked);
  const lines = checkedItems.map(i => `‚òê ${i.text}`);
  const totalCost = checkedItems.reduce((s, i) => s + (i.cost || 0), 0);
  const text = `üõí GROCERY LIST\n\n${lines.join("\n")}\n\nüí∞ Estimated total: ~$${totalCost.toFixed(0)}`;
  navigator.clipboard.writeText(text).then(() => {
    const b = event.target; b.textContent = "‚úÖ Copied!";
    setTimeout(() => b.textContent = "üìã Copy checked", 2000);
  });
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ
showApp();
</script>
</body>
</html>
