<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --cream: #FAF7F2;
    --paper: #F4EFE6;
    --ink: #1C1917;
    --ink2: #44403C;
    --ink3: #78716C;
    --accent: #C2410C;
    --accent2: #EA580C;
    --border: #E7DDD0;
    --green: #15803D;
  }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* Top bar */
  .topbar {
    background: var(--ink);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  .back-btn {
    color: #aaa;
    text-decoration: none;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    background: none;
    border: none;
  }
  .back-btn:hover { color: #fff; }
  .topbar-title {
    color: #fff;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }
  .print-btn {
    background: #fff2;
    border: 1px solid #fff3;
    color: #ccc;
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .print-btn:hover { background: #fff3; color: #fff; }

  /* Hero */
  .hero {
    position: relative;
    height: 340px;
    overflow: hidden;
    background: var(--ink);
  }
  .hero-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
  }
  .hero-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 80px;
    background: linear-gradient(135deg, #1C1917 0%, #292524 100%);
  }
  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(28,25,23,0.85) 0%, transparent 60%);
    display: flex;
    align-items: flex-end;
    padding: 32px 40px;
  }
  .hero-text { max-width: 700px; }
  .hero-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 5vw, 48px);
    color: #fff;
    line-height: 1.15;
    margin-bottom: 12px;
  }
  .hero-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .hero-pill {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
  }
  .pill-cat { background: var(--accent); color: #fff; }
  .pill-method { background: rgba(255,255,255,0.15); color: #ddd; border: 1px solid rgba(255,255,255,0.2); }
  .pill-cost { background: rgba(21,128,61,0.8); color: #fff; }
  .pill-servings { background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid rgba(255,255,255,0.15); }

  /* Content */
  .content {
    max-width: 900px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 48px;
    align-items: start;
  }

  /* Ingredients sidebar */
  .ing-card {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    position: sticky;
    top: 64px;
  }
  .ing-card h2 {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--ink);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  /* Servings scaler */
  .servings-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 18px;
    font-size: 13px;
    color: var(--ink3);
  }
  .servings-ctrl {
    display: flex;
    align-items: center;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .servings-ctrl button {
    background: var(--cream);
    border: none;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 16px;
    color: var(--ink2);
    display: flex; align-items: center; justify-content: center;
  }
  .servings-ctrl button:hover { background: var(--border); }
  .servings-ctrl span {
    padding: 0 10px;
    font-size: 14px;
    font-weight: 500;
    color: var(--ink);
    min-width: 32px;
    text-align: center;
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    line-height: 28px;
  }

  .ing-list { list-style: none; }
  .ing-list li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--ink2);
    line-height: 1.4;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .ing-list li:last-child { border-bottom: none; }
  .ing-list li::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent2);
    flex-shrink: 0;
    margin-top: 5px;
  }
  .ing-list li.checked {
    opacity: 0.4;
    text-decoration: line-through;
  }
  .ing-list li.checked::before { background: var(--ink3); }

  /* Steps */
  .steps-section h2 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    color: var(--ink);
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }
  .step {
    display: flex;
    gap: 20px;
    margin-bottom: 28px;
    align-items: flex-start;
  }
  .step-num {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--ink);
    color: #fff;
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .step-text {
    font-size: 16px;
    line-height: 1.7;
    color: var(--ink2);
    padding-top: 6px;
  }

  /* Loading/error states */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    gap: 16px;
    color: var(--ink3);
  }
  .spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Source link */
  .source-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--accent);
    text-decoration: none;
    margin-top: 32px;
    padding: 8px 16px;
    border: 1px solid var(--accent);
    border-radius: 6px;
  }
  .source-link:hover { background: var(--accent); color: #fff; }

  /* No details state */
  .no-details {
    background: var(--paper);
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 32px;
    text-align: center;
    color: var(--ink3);
    font-size: 14px;
    line-height: 1.6;
  }

  @media print {
    .topbar, .back-btn, .print-btn { display: none; }
    .hero { height: 200px; }
    .ing-card { position: static; }
    body { background: #fff; }
  }

  @media (max-width: 700px) {
    .content { grid-template-columns: 1fr; gap: 32px; padding: 24px 16px 60px; }
    .hero { height: 240px; }
    .hero-overlay { padding: 20px 16px; }
    .ing-card { position: static; }
  }
</style>
<script>
(async () => {
  try {
    const cfg = await fetch("/.netlify/functions/config").then(r => r.json());
    window.__SUPABASE_URL__ = cfg.supabaseUrl;
    window.__SUPABASE_ANON_KEY__ = cfg.supabaseAnonKey;
  } catch(e) {}
})();
</script>
<script src="/auth.js"></script>
</head>
<body>
<!-- AUTH GUARD -->
<script>
// Auth guard ‚Äî redirect to login if no valid session
(function() {
  const token = localStorage.getItem("sb-access-token");
  const expiry = parseInt(localStorage.getItem("sb-token-expiry") || "0");
  if (!token || Date.now() > expiry) {
    location.href = "/login.html?next=" + encodeURIComponent(location.pathname);
  }
})();
</script>

<div class="topbar">
  <button class="back-btn" onclick="history.back()">‚Üê Back</button>
  <span class="topbar-title" id="topbar-title">Loading recipe‚Ä¶</span>
  <button class="print-btn" onclick="window.print()">üñ® Print</button>
</div>

<div id="app">
  <div class="loading-state">
    <div class="spinner"></div>
    <span>Loading recipe‚Ä¶</span>
  </div>
</div>

<script>
const API = "/.netlify/functions";
async function apiFetch(fn, method="GET", body=null) {
  const hdrs = await Auth.headers();
  if (!hdrs) { Auth.signOut(); throw new Error("Not authenticated"); }
  const opts = { method, headers: hdrs };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(`${API}/${fn}`, opts);
  return r.json();
}

const CC = {"Breakfast":{bg:"#FFF3E0",text:"#E65100"},"Lunch/Dinner":{bg:"#E8F5E9",text:"#1B5E20"},"Salad":{bg:"#E3F2FD",text:"#0D47A1"},"Side":{bg:"#F3E5F5",text:"#4A148C"},"Dessert":{bg:"#FCE4EC",text:"#880E4F"}};
const MI = {"Slow Cooker":"ü•ò","Oven":"üî•","Stovetop":"üç≥","Air Fryer":"üí®","No Cook":"ü•ó","Microwave":"üì°","Stovetop / Air Fryer":"üç≥","Stovetop / Oven":"üç≥","Oven / Stovetop":"üî•","Slow Cooker / Stovetop":"ü•ò"};

let baseServings = 4;
let currentServings = 4;
let rawIngredients = [];

function parseAmount(str) {
  // Try to extract a leading number/fraction from an ingredient string
  const m = str.match(/^([\d\s\/.‚Öõ¬º‚Öì‚Öú¬Ω‚Öù‚Öî¬æ‚Öû]+)/);
  if (!m) return null;
  let s = m[1].trim();
  // Unicode fractions
  const fracs = {"‚Öõ":0.125,"¬º":0.25,"‚Öì":0.333,"‚Öú":0.375,"¬Ω":0.5,"‚Öù":0.625,"‚Öî":0.667,"¬æ":0.75,"‚Öû":0.875};
  for (const [f,v] of Object.entries(fracs)) s = s.replace(f, " "+v);
  // Handle "1 1/2" style
  const parts = s.trim().split(/\s+/);
  let total = 0;
  for (const p of parts) {
    if (p.includes("/")) { const [n,d] = p.split("/"); total += parseFloat(n)/parseFloat(d); }
    else total += parseFloat(p) || 0;
  }
  return total || null;
}

function scaleIngredient(ing, ratio) {
  if (ratio === 1) return ing;
  return ing.replace(/^([\d\s\/.‚Öõ¬º‚Öì‚Öú¬Ω‚Öù‚Öî¬æ‚Öû]+)/, match => {
    const val = parseAmount(match);
    if (!val) return match;
    const scaled = val * ratio;
    // Format nicely
    if (scaled === Math.floor(scaled)) return String(scaled);
    // Try common fractions
    const fracs = [[1/8,"‚Öõ"],[1/4,"¬º"],[1/3,"‚Öì"],[3/8,"‚Öú"],[1/2,"¬Ω"],[2/3,"‚Öî"],[3/4,"¬æ"]];
    const whole = Math.floor(scaled);
    const frac = scaled - whole;
    for (const [v,sym] of fracs) {
      if (Math.abs(frac - v) < 0.05) return (whole ? whole + " " : "") + sym;
    }
    return scaled.toFixed(1).replace(/\.0$/,"");
  });
}

function renderIngredients() {
  const ratio = currentServings / baseServings;
  const items = document.querySelectorAll(".ing-list li");
  items.forEach((li, i) => {
    const text = scaleIngredient(rawIngredients[i], ratio);
    li.childNodes[0].textContent = text;
  });
  document.getElementById("srv-count").textContent = currentServings;
}

function changeServings(delta) {
  currentServings = Math.max(1, Math.min(24, currentServings + delta));
  renderIngredients();
}

function toggleIng(li) { li.classList.toggle("checked"); }

async function init() {
  const ok = await Auth.require();
  if (!ok) return;
  const params = new URLSearchParams(location.search);
  const id = parseInt(params.get("id"));
  if (!id) { document.getElementById("app").innerHTML = '<div class="loading-state">No recipe ID provided.</div>'; return; }

  try {
    const [recipes, allDetails] = await Promise.all([
      apiFetch("extra-recipes"),
      apiFetch("recipe-details")
    ]);

    const recipe = Array.isArray(recipes) ? recipes.find(r => r.id === id) : null;
    const detail = Array.isArray(allDetails) ? allDetails.find(d => d.recipe_id === id) : null;

    if (!recipe) { document.getElementById("app").innerHTML = '<div class="loading-state">Recipe not found.</div>'; return; }

    document.title = recipe.name + " ‚Äî Recipe";
    document.getElementById("topbar-title").textContent = recipe.name;
    baseServings = detail?.servings || recipe.servings || 4;
    currentServings = baseServings;
    rawIngredients = detail?.ingredients || [];

    const c = CC[recipe.category] || { bg:"#ddd", text:"#333" };
    const icon = MI[recipe.method] || "üç¥";

    const heroHtml = recipe.image_url
      ? `<img class="hero-img" src="${recipe.image_url}" alt="${recipe.name}">`
      : `<div class="hero-placeholder">${icon}</div>`;

    const ingredientsHtml = rawIngredients.length
      ? `<div class="servings-row">
          <span>Servings:</span>
          <div class="servings-ctrl">
            <button onclick="changeServings(-1)">‚àí</button>
            <span id="srv-count">${currentServings}</span>
            <button onclick="changeServings(1)">+</button>
          </div>
        </div>
        <ul class="ing-list">
          ${rawIngredients.map(i => `<li onclick="toggleIng(this)">${i}</li>`).join("")}
        </ul>`
      : `<div class="no-details" style="padding:16px;font-size:13px">No ingredients saved yet.<br>Go back and fetch the recipe URL.</div>`;

    const stepsHtml = detail?.steps?.length
      ? detail.steps.map((s, i) => `
          <div class="step">
            <div class="step-num">${i+1}</div>
            <div class="step-text">${s}</div>
          </div>`).join("")
      : `<div class="no-details">No steps saved yet.</div>`;

    const sourceHtml = recipe.url
      ? `<a class="source-link" href="${recipe.url}" target="_blank">‚Üó View Original Recipe</a>`
      : "";

    document.getElementById("app").innerHTML = `
      <div class="hero">
        ${heroHtml}
        <div class="hero-overlay">
          <div class="hero-text">
            <h1 class="hero-title">${recipe.name}</h1>
            <div class="hero-meta">
              ${recipe.category ? `<span class="hero-pill pill-cat">${recipe.category}</span>` : ""}
              ${recipe.method ? `<span class="hero-pill pill-method">${icon} ${recipe.method}</span>` : ""}
              ${recipe.cost ? `<span class="hero-pill pill-cost">${recipe.cost}</span>` : ""}
              ${currentServings ? `<span class="hero-pill pill-servings">${currentServings} servings</span>` : ""}
            </div>
          </div>
        </div>
      </div>
      <div class="content">
        <aside>
          <div class="ing-card">
            <h2>Ingredients</h2>
            ${ingredientsHtml}
          </div>
        </aside>
        <main>
          <div class="steps-section">
            <h2>Instructions</h2>
            ${stepsHtml}
            ${sourceHtml}
          </div>
        </main>
      </div>
    `;
  } catch(e) {
    document.getElementById("app").innerHTML = `<div class="loading-state">Error loading recipe: ${e.message}</div>`;
  }
}

init();
</script>
</body>
</html>
