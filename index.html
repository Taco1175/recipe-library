<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Recipe Library</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0F1117;color:#E8E4DC;font-family:Georgia,serif;min-height:100vh}
.header{background:linear-gradient(135deg,#1a1f2e,#0F1117);border-bottom:1px solid #2a2f3e;padding:28px 40px 22px}
.header-inner{max-width:1300px;margin:0 auto}
.header h1{font-size:30px;font-weight:700;color:#F5F0E8;margin-bottom:4px;display:flex;align-items:baseline;gap:12px}
.count-badge{font-size:13px;color:#888;font-family:monospace;font-weight:400}
.header p{color:#8a8f9e;font-size:13px;margin-bottom:16px}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;border-radius:20px;padding:5px 14px;font-size:12px;cursor:pointer;font-family:monospace;border:1px solid #2a2f3e;background:#1e2330;color:#aaa;transition:all .2s;user-select:none}
.pill.active{border-color:var(--dot);background:var(--bg);color:var(--text)}
.pill .dot{width:7px;height:7px;border-radius:50%;background:#555;display:inline-block;flex-shrink:0}
.pill.active .dot{background:var(--dot)}
.main{max-width:1300px;margin:0 auto;padding:24px 40px}
.topbar{display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
.topbar-left{display:flex;gap:10px;flex:1;align-items:center;flex-wrap:wrap}
.topbar input{background:#1e2330;border:1px solid #2a2f3e;border-radius:8px;padding:10px 16px;color:#E8E4DC;font-size:14px;outline:none;font-family:Georgia,serif;min-width:200px;flex:1}
.topbar select{background:#1e2330;border:1px solid #2a2f3e;border-radius:8px;padding:10px 12px;color:#E8E4DC;font-size:13px;outline:none;font-family:Georgia,serif;cursor:pointer}
.btn{border:none;border-radius:8px;padding:10px 18px;font-size:13px;font-family:Georgia,serif;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:7px;white-space:nowrap}
.btn-primary{background:#6e8efb;color:#fff}
.btn-primary:hover{background:#5a7df0}
.btn-primary:disabled{background:#3a4060;color:#666;cursor:default}
.btn-success{background:#2d6a4f;color:#7bcf8e;border:1px solid #3a8a65}
.btn-success:hover{background:#3a7a5f}
.btn-danger{background:#4a1a1a;color:#e07070;border:1px solid #6a3030;font-size:12px;padding:7px 12px}
.btn-danger:hover{background:#5a2a2a}
.btn-outline{background:transparent;border:1px solid #2a2f3e;color:#aaa}
.btn-outline:hover{border-color:#6e8efb;color:#6e8efb}
.grocery-badge{background:#e07070;color:#fff;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-family:monospace}
.count{font-size:12px;color:#666;font-family:monospace;margin-bottom:14px}
.clear-link{cursor:pointer;margin-left:12px;color:#6e8efb;text-decoration:underline}
.table{background:#1a1f2e;border:1px solid #2a2f3e;border-radius:12px;overflow:hidden}
.thead{display:grid;grid-template-columns:28px 1.8fr 100px 130px 140px 110px 58px 34px;padding:11px 16px;background:#12151f;border-bottom:1px solid #2a2f3e;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#556;font-family:monospace;gap:8px;align-items:center}
.trow-wrap{border-bottom:1px solid #1e2330}
.trow-wrap:last-child{border-bottom:none}
.trow{display:grid;grid-template-columns:28px 1.8fr 100px 130px 140px 110px 58px 34px;padding:12px 16px;align-items:center;gap:8px;cursor:pointer}
.trow:hover{background:#1e2330}
.recipe-name{font-size:13px;font-weight:500;color:#E8E4DC;display:flex;align-items:center;gap:7px;min-width:0}
.expand-icon{font-size:9px;color:#445;transition:transform .2s;flex-shrink:0}
.trow-wrap.open .expand-icon{transform:rotate(90deg)}
.has-details .recipe-name{color:#b8d8ff}
.no-details-hint{font-size:10px;color:#3a4050;font-family:monospace;margin-left:2px;flex-shrink:0}
.badge{display:inline-flex;align-items:center;gap:4px;border-radius:12px;padding:3px 9px;font-size:11px;font-family:monospace;white-space:nowrap}
.badge .dot{width:5px;height:5px;border-radius:50%;display:inline-block;flex-shrink:0}
.meta{font-size:12px;color:#9a9fae}
.source-col{font-size:11px;color:#556;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cost{font-size:12px;color:#7bcf8e;font-family:monospace;font-weight:600}
.link-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;background:#1e2a3a;border:1px solid #2a3f5e;color:#6e8efb;font-size:12px;text-decoration:none;transition:all .15s;flex-shrink:0}
.link-btn:hover{background:#2a3f5e}
input[type=checkbox]{width:15px;height:15px;accent-color:#6e8efb;cursor:pointer}
.detail-panel{display:none;padding:0 20px 20px 52px;background:#0e1118;border-top:1px solid #1e2330}
.trow-wrap.open .detail-panel{display:block}
.detail-inner{display:grid;grid-template-columns:1fr 1.7fr;gap:28px;padding-top:20px}
.detail-section h3{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:#556;font-family:monospace;margin-bottom:10px}
.ingredient-list{list-style:none}
.ingredient-list li{font-size:13px;color:#c0c8da;padding:4px 0 4px 14px;border-bottom:1px solid #1a1f2e;position:relative;line-height:1.4}
.ingredient-list li:last-child{border-bottom:none}
.ingredient-list li::before{content:"¬∑";color:#6e8efb;position:absolute;left:0}
.steps-list{list-style:none;counter-reset:steps}
.steps-list li{font-size:13px;color:#c0c8da;padding:7px 0 7px 30px;border-bottom:1px solid #1a1f2e;position:relative;counter-increment:steps;line-height:1.55}
.steps-list li:last-child{border-bottom:none}
.steps-list li::before{content:counter(steps);position:absolute;left:0;top:7px;width:20px;height:20px;background:#1e2a3a;border:1px solid #2a3f5e;border-radius:50%;font-size:10px;color:#6e8efb;font-family:monospace;text-align:center;line-height:20px}
.detail-actions{margin-top:14px;display:flex;gap:8px}
.detail-loading{display:flex;align-items:center;gap:10px;color:#8a8f9e;font-size:13px;padding:20px 0}
.spinner{width:16px;height:16px;border:2px solid #2a2f3e;border-top-color:#6e8efb;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.add-panel{background:#1a1f2e;border:1px solid #2a2f3e;border-radius:12px;padding:24px;margin-bottom:24px;display:none}
.add-panel.show{display:block}
.add-panel h2{font-size:15px;color:#F5F0E8;margin-bottom:16px}
.add-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.field label{display:block;font-size:10px;color:#556;font-family:monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px}
.field input,.field select{width:100%;background:#12151f;border:1px solid #2a2f3e;border-radius:8px;padding:9px 12px;color:#E8E4DC;font-size:13px;outline:none;font-family:Georgia,serif;transition:border-color .2s}
.field input:focus,.field select:focus{border-color:#6e8efb}
.field.full{grid-column:1/-1}
.url-row{display:flex;gap:8px;align-items:flex-end}
.url-row .field{flex:1;margin:0}
.add-msg{font-size:12px;font-family:monospace;padding:8px 12px;border-radius:6px;margin-top:10px;display:flex;align-items:center;gap:8px}
.add-msg.error{background:#2a1515;color:#e07070;border:1px solid #4a2020}
.add-msg.success{background:#152a1e;color:#7bcf8e;border:1px solid #2a5a3e}
.add-msg.loading{background:#1a1f2e;color:#8a8f9e;border:1px solid #2a2f3e}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;display:none;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto}
.modal-overlay.show{display:flex}
.modal{background:#1a1f2e;border:1px solid #2a2f3e;border-radius:16px;width:100%;max-width:660px;padding:32px;position:relative}
.modal h2{font-size:20px;color:#F5F0E8;margin-bottom:4px}
.modal .subtitle{font-size:13px;color:#8a8f9e;margin-bottom:24px}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:#666;font-size:20px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px}
.modal-close:hover{background:#2a2f3e;color:#E8E4DC}
.g-section{margin-bottom:20px}
.g-section h3{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:#6e8efb;font-family:monospace;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #2a2f3e}
.g-item{display:flex;align-items:baseline;gap:8px;padding:5px 0;font-size:14px;color:#c8d0e0;border-bottom:1px solid #141820}
.g-item:last-child{border-bottom:none}
.g-item::before{content:"‚òê";color:#4a5070;font-size:12px;flex-shrink:0}
.g-from{font-size:11px;color:#445;font-family:monospace;margin-left:auto;flex-shrink:0;padding-left:10px}
.modal-footer{margin-top:24px;display:flex;gap:10px;justify-content:flex-end}
.empty{padding:40px;text-align:center;color:#555;font-size:14px}
.footer-note{margin-top:14px;font-size:11px;color:#444;text-align:center;font-family:monospace}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>üçΩ My Recipe Library <span class="count-badge" id="total-badge"></span></h1>
    <p>Click any recipe to expand ¬∑ Check boxes to build a grocery list ¬∑ Add new recipes with Ôºã</p>
    <div class="pills" id="pills"></div>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <input type="text" id="search" placeholder="Search recipes, proteins, sources...">
      <select id="filterProt"><option value="">All Proteins</option></select>
      <select id="filterMeth"><option value="">All Methods</option></select>
      <select id="sortBy">
        <option value="category">Sort: Category</option>
        <option value="name">Sort: Name</option>
        <option value="protein">Sort: Protein</option>
        <option value="method">Sort: Method</option>
        <option value="cost">Sort: Cost ‚Üë</option>
      </select>
    </div>
    <button class="btn btn-outline" onclick="toggleAdd()">Ôºã Add Recipe</button>
    <button class="btn btn-success" id="grocery-btn" onclick="openGrocery()" style="display:none">
      üõí Grocery List <span class="grocery-badge" id="grocery-count">0</span>
    </button>
  </div>

  <!-- Add Panel -->
  <div class="add-panel" id="add-panel">
    <h2>‚ûï Add New Recipe from URL</h2>
    <div class="add-grid">
      <div class="field full url-row">
        <div class="field"><label>Recipe URL *</label><input type="url" id="new-url" placeholder="https://..."></div>
        <button class="btn btn-primary" id="fetch-btn" onclick="fetchAndAdd()">‚ú® Fetch &amp; Fill</button>
      </div>
      <div class="field"><label>Recipe Name</label><input type="text" id="new-name" placeholder="Auto-filled from URL"></div>
      <div class="field"><label>Category</label>
        <select id="new-cat">
          <option value="Breakfast">Breakfast</option>
          <option value="Lunch/Dinner" selected>Lunch/Dinner</option>
          <option value="Salad">Salad</option>
          <option value="Side">Side</option>
          <option value="Dessert">Dessert</option>
        </select>
      </div>
      <div class="field"><label>Protein</label><input type="text" id="new-protein" placeholder="e.g. Chicken"></div>
      <div class="field"><label>Cooking Method</label><input type="text" id="new-method" placeholder="e.g. Slow Cooker"></div>
      <div class="field"><label>Source / Blog</label><input type="text" id="new-source" placeholder="e.g. Kay Nutrition"></div>
      <div class="field"><label>Est. Aldi Cost</label><input type="text" id="new-cost" placeholder="e.g. $10-13"></div>
    </div>
    <div id="add-msg" style="display:none" class="add-msg"></div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn btn-primary" onclick="saveNew()">Save Recipe</button>
      <button class="btn btn-outline" onclick="toggleAdd()">Cancel</button>
    </div>
  </div>

  <div class="count" id="count"></div>

  <div class="table">
    <div class="thead">
      <div></div><div>Recipe Name</div><div>Category</div><div>Protein</div><div>Method</div><div>Source</div><div>Cost</div><div></div>
    </div>
    <div id="rows"></div>
  </div>
  <div class="footer-note">Blue recipe names have saved details ¬∑ Click any row to expand ¬∑ Check to add to grocery list</div>
</div>

<!-- Grocery Modal -->
<div class="modal-overlay" id="grocery-modal" onclick="if(event.target===this)closeGrocery()">
  <div class="modal">
    <button class="modal-close" onclick="closeGrocery()">‚úï</button>
    <h2>üõí Grocery List</h2>
    <p class="subtitle" id="g-subtitle"></p>
    <div id="g-body"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="copyList()">üìã Copy</button>
      <button class="btn btn-primary" onclick="closeGrocery()">Done</button>
    </div>
  </div>
</div>

<script>
const BASE = [
  {id:1,name:"Freezer Breakfast Burritos",category:"Breakfast",protein:"Turkey & Beef",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/472-cal-freezer-breakfast-burritos/",cost:"$8-10"},
  {id:2,name:"Meal Prep Breakfast Burritos",category:"Breakfast",protein:"Sausage & Eggs",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-breakfast-burritos/",cost:"$9-12"},
  {id:3,name:"Veggie-Loaded Egg Scramble",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:4,name:"Protein Yogurt Bowl",category:"Breakfast",protein:"Protein Powder",method:"No Cook",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$3-5"},
  {id:5,name:"Cauliflower & Egg Fried Rice Breakfast Bowl",category:"Breakfast",protein:"Eggs",method:"Stovetop",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:6,name:"Savory Egg Muffin Veggie Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Awaken180",url:"https://awaken180weightloss.com/4-low-calorie-high-volume-breakfasts-you-can-make-in-5-minutes/",cost:"$4-6"},
  {id:7,name:"Spinach Breakfast Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-breakfast-casserole/",cost:"$5-7"},
  {id:8,name:"Breakfast Egg Bake",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/breakfast-egg-bake/",cost:"$5-7"},
  {id:9,name:"Spinach Egg Muffins with Feta",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-egg-muffins-with-feta/",cost:"$5-8"},
  {id:10,name:"Bacon Egg Muffin Cups",category:"Breakfast",protein:"Eggs & Bacon",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/bacon-egg-muffin-cups/",cost:"$6-9"},
  {id:11,name:"Greek Omelette Casserole",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-omelette-casserole/",cost:"$6-8"},
  {id:12,name:"Egg Muffins with Red Pepper & Spinach",category:"Breakfast",protein:"Eggs",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/egg-muffins-red-pepper-spinach/",cost:"$4-6"},
  {id:13,name:"Big Chicken Caesar Salad",category:"Salad",protein:"Chicken",method:"Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/456-cal-big-as-chicken-caesar-salad/",cost:"$12-15"},
  {id:14,name:"Meal Prep Taco Salad",category:"Salad",protein:"Ground Beef/Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-taco-salad/",cost:"$10-13"},
  {id:15,name:"Mediterranean Tuna Pasta Salad",category:"Salad",protein:"Tuna",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/mediterranean-tuna-pasta-salad/",cost:"$7-10"},
  {id:16,name:"Chicken Shawarma Salad",category:"Salad",protein:"Chicken",method:"Stovetop / Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-shawarma-salad/",cost:"$10-13"},
  {id:17,name:"Ground Taco Meat with Cauliflower Rice",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"Clean & Delicious",url:"https://cleananddelicious.com/ground-taco-meat-with-cauliflower-rice/",cost:"$10-13"},
  {id:18,name:"Cauliflower Chicken Fried Rice",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/326-cal-cauliflower-chicken-fried-rice/",cost:"$10-13"},
  {id:19,name:"XL Grinder Salad Wraps",category:"Lunch/Dinner",protein:"Deli Chicken",method:"No Cook",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/516-cal-xl-grinder-salad-wraps/",cost:"$12-15"},
  {id:20,name:"Chicken Tenders & Fries",category:"Lunch/Dinner",protein:"Chicken",method:"Stovetop / Air Fryer",source:"Flexible Dieting Lifestyle",url:"https://flexibledietinglifestyle.com/518-cal-chicken-tenders-the-easiest-fries-meal/",cost:"$10-13"},
  {id:21,name:"Slow Cooker Beef Barbacoa",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Taste of Home",url:"https://www.tasteofhome.com/recipes/slow-cooker-beef-barbacoa/",cost:"$15-20"},
  {id:22,name:"Chickpea and Chorizo Taco Soup",category:"Lunch/Dinner",protein:"Chorizo",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:23,name:"Slow Cooker Southwest Sweet Potato Chili",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:24,name:"Creamy Taco Soup",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$9-12"},
  {id:25,name:"Slow Cooker Chicken Fajitas",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:26,name:"Copycat KFC Famous Bowls",category:"Lunch/Dinner",protein:"Chicken",method:"Oven / Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:27,name:"Tex-Mex Roasted Veggie Quesadillas",category:"Lunch/Dinner",protein:"Vegetarian",method:"Oven",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$7-10"},
  {id:28,name:"Copycat Bacon Cheeseburger Hamburger Helper",category:"Lunch/Dinner",protein:"Ground Beef",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-13"},
  {id:29,name:"Taco Salad with Pan Fried Tortilla Strips",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$10-12"},
  {id:30,name:"Honey Sriracha Shrimp Fried Cauliflower Rice",category:"Lunch/Dinner",protein:"Shrimp",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$12-15"},
  {id:31,name:"Microwavable BBQ Chicken Pasta Bake",category:"Lunch/Dinner",protein:"Chicken",method:"Microwave",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$8-11"},
  {id:32,name:"Pan Roasted Corn & Black Bean Burrito Bowls",category:"Lunch/Dinner",protein:"Vegetarian",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$6-9"},
  {id:33,name:"Slow Cooker Pesto Chicken Pasta",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:34,name:"Slow Cooker Sesame Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:35,name:"Slow Cooker Chicken Shawarma",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:36,name:"Slow Cooker Salsa Verde Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$8-11"},
  {id:37,name:"Slow Cooker BBQ Wings",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-14"},
  {id:38,name:"BBQ Pulled Pork Lettuce Wraps",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$12-16"},
  {id:39,name:"Crockpot Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:40,name:"Slow Cooker Turkey Meatball Subs",category:"Lunch/Dinner",protein:"Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$11-14"},
  {id:41,name:"Chipotle Chicken Tacos",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:42,name:"Slow Cooker Chicken Adobo",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$9-12"},
  {id:43,name:"Slow Cooker Meatball Soup",category:"Lunch/Dinner",protein:"Beef/Turkey",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:44,name:"Crockpot Pork Carnitas",category:"Lunch/Dinner",protein:"Pork",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$13-17"},
  {id:45,name:"Slow Cooker Thai Chicken Lettuce Wraps",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:46,name:"Slow Cooker Chicken Tortilla Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$10-13"},
  {id:47,name:"Slow Cooker Beef Carnitas",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Hungry Hobby",url:"https://hungryhobby.net/16-high-protein-crockpot-meals/",cost:"$14-18"},
  {id:48,name:"Korean Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/korean-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:49,name:"Turkey Taco Skillet",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/turkey-taco-skillet/",cost:"$9-12"},
  {id:50,name:"Firecracker Beef Meal Prep Bowls",category:"Lunch/Dinner",protein:"Beef",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/firecracker-beef-meal-prep-bowls/",cost:"$12-15"},
  {id:51,name:"Chicken Broccoli Rice Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-broccoli-rice-casserole/",cost:"$10-13"},
  {id:52,name:"Greek Turkey Meatballs",category:"Lunch/Dinner",protein:"Turkey",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-turkey-meatballs/",cost:"$9-12"},
  {id:53,name:"Greek Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/greek-chicken-casserole/",cost:"$11-14"},
  {id:54,name:"Sheet Pan Chicken and Broccoli",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-chicken-and-broccoli/",cost:"$9-12"},
  {id:55,name:"Spaghetti Squash Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spaghetti-squash-casserole/",cost:"$10-13"},
  {id:56,name:"Spinach Artichoke Chicken Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/spinach-artichoke-chicken-casserole/",cost:"$11-14"},
  {id:57,name:"Shredded Beef Tacos",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker",source:"Kay Nutrition",url:"https://kaynutrition.com/shredded-beef-tacos/",cost:"$14-18"},
  {id:58,name:"Beef Shawarma",category:"Lunch/Dinner",protein:"Beef",method:"Oven / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-shawarma/",cost:"$13-16"},
  {id:59,name:"Ground Turkey Meal Prep Bowls",category:"Lunch/Dinner",protein:"Turkey",method:"Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/ground-turkey-meal-prep-bowls/",cost:"$9-12"},
  {id:60,name:"Stuffed Pepper Casserole",category:"Lunch/Dinner",protein:"Ground Beef/Turkey",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/stuffed-pepper-casserole/",cost:"$10-13"},
  {id:61,name:"Beef and Mushroom Stew",category:"Lunch/Dinner",protein:"Beef",method:"Slow Cooker / Stovetop",source:"Kay Nutrition",url:"https://kaynutrition.com/beef-and-mushroom-stew/",cost:"$13-16"},
  {id:62,name:"Sheet Pan Steak Fajitas",category:"Lunch/Dinner",protein:"Beef",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-steak-fajitas/",cost:"$14-18"},
  {id:63,name:"Sheet Pan Bruschetta Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/sheet-pan-bruschetta-chicken/",cost:"$10-13"},
  {id:64,name:"Chicken Burrito Casserole",category:"Lunch/Dinner",protein:"Chicken",method:"Oven",source:"Kay Nutrition",url:"https://kaynutrition.com/chicken-burrito-casserole/",cost:"$10-13"},
  {id:65,name:"Meal Prep Instant Noodle Cups",category:"Lunch/Dinner",protein:"Chicken",method:"No Cook",source:"Kay Nutrition",url:"https://kaynutrition.com/meal-prep-instant-noodle-cups/",cost:"$8-11"},
  {id:66,name:"Air Fryer Broccoli",category:"Side",protein:"None",method:"Air Fryer",source:"Eating Bird Food",url:"https://www.eatingbirdfood.com/air-fryer-broccoli/",cost:"$2-4"},
  {id:67,name:"Honey Mustard Pan Roasted Brussels Sprouts",category:"Side",protein:"None",method:"Stovetop",source:"SISU Fitness",url:"https://sisufitness.com/eat-more-food-high-volume-recipes/",cost:"$3-5"},
  {id:68,name:"Crock Pot Salsa Chicken",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Budget Bytes",url:"https://www.budgetbytes.com/crock-pot-salsa-chicken/",cost:"$7-10"},
  {id:69,name:"Crockpot Swedish Meatballs",category:"Lunch/Dinner",protein:"Beef (Frozen Meatballs)",method:"Slow Cooker",source:"Cooking in the Midwest",url:"https://cookinginthemidwest.com/blog/crockpot-swedish-meatballs/",cost:"$11-14"},
  {id:70,name:"Crockpot Chicken Parmesan Soup",category:"Lunch/Dinner",protein:"Chicken",method:"Slow Cooker",source:"Eating on a Dime",url:"https://www.eatingonadime.com/crock-pot-creamy-chicken-parmesan-soup/",cost:"$12-15"}
];

const CAT_COLORS={
  "Breakfast":{bg:"#FFF3E0",text:"#E65100",dot:"#FF9800"},
  "Lunch/Dinner":{bg:"#E8F5E9",text:"#1B5E20",dot:"#4CAF50"},
  "Salad":{bg:"#E3F2FD",text:"#0D47A1",dot:"#2196F3"},
  "Side":{bg:"#F3E5F5",text:"#4A148C",dot:"#9C27B0"},
  "Dessert":{bg:"#FCE4EC",text:"#880E4F",dot:"#E91E63"}
};
const MI={"Slow Cooker":"ü•ò","Oven":"üî•","Stovetop":"üç≥","Air Fryer":"üí®","No Cook":"ü•ó","Microwave":"üì°","Stovetop / Air Fryer":"üç≥","Stovetop / Oven":"üç≥","Oven / Stovetop":"üî•","Slow Cooker / Stovetop":"ü•ò"};

let recipes=[...BASE];
let details={};   // id -> {ingredients:[],steps:[]}
let checked=new Set();
let fCat="",fProt="",fMeth="",sort="category",q="";
let pendingDetails=null;

async function init(){
  try{
    const r=await window.storage.get("extra-recipes-v2");
    if(r&&r.value){JSON.parse(r.value).forEach(x=>{if(!recipes.find(y=>y.id===x.id))recipes.push(x);});}
  }catch(e){}
  try{
    const r=await window.storage.get("recipe-details-v2");
    if(r&&r.value)details=JSON.parse(r.value);
  }catch(e){}
  buildSelects();
  render();
}

async function saveDetails(){try{await window.storage.set("recipe-details-v2",JSON.stringify(details));}catch(e){}}
async function saveExtras(){
  try{await window.storage.set("extra-recipes-v2",JSON.stringify(recipes.filter(r=>r.id>70)));}catch(e){}
}

function filtered(){
  return recipes.filter(r=>{
    const s=q.toLowerCase();
    return(!s||r.name.toLowerCase().includes(s)||r.protein.toLowerCase().includes(s)||r.source.toLowerCase().includes(s))
      &&(!fCat||r.category===fCat)&&(!fProt||r.protein===fProt)&&(!fMeth||r.method===fMeth);
  }).sort((a,b)=>{
    if(sort==="category")return a.category.localeCompare(b.category)||a.name.localeCompare(b.name);
    if(sort==="name")return a.name.localeCompare(b.name);
    if(sort==="protein")return a.protein.localeCompare(b.protein);
    if(sort==="method")return a.method.localeCompare(b.method);
    if(sort==="cost")return parseInt(a.cost||0)-parseInt(b.cost||0);
    return 0;
  });
}

function buildPills(){
  const counts={};
  recipes.forEach(r=>counts[r.category]=(counts[r.category]||0)+1);
  document.getElementById("pills").innerHTML=Object.entries(counts).map(([cat,n])=>{
    const c=CAT_COLORS[cat]||{bg:"#333",text:"#ccc",dot:"#888"};
    return`<span class="pill${fCat===cat?" active":""}" data-cat="${cat}" style="--bg:${c.bg};--text:${c.text};--dot:${c.dot}"><span class="dot"></span>${cat} ¬∑ ${n}</span>`;
  }).join("");
  document.getElementById("pills").querySelectorAll(".pill").forEach(p=>p.addEventListener("click",()=>{fCat=fCat===p.dataset.cat?"":p.dataset.cat;render();}));
}

function buildSelects(){
  const prots=[...new Set(recipes.map(r=>r.protein))].sort();
  const meths=[...new Set(recipes.map(r=>r.method))].sort();
  const pc=document.getElementById("filterProt"),mc=document.getElementById("filterMeth");
  const cv=pc.value,mv=mc.value;
  pc.innerHTML=`<option value="">All Proteins</option>`+prots.map(p=>`<option${p===cv?" selected":""}>${p}</option>`).join("");
  mc.innerHTML=`<option value="">All Methods</option>`+meths.map(m=>`<option${m===mv?" selected":""}>${m}</option>`).join("");
}

function render(){
  buildPills();
  const list=filtered();
  document.getElementById("total-badge").textContent=recipes.length+" recipes";
  document.getElementById("count").innerHTML=`Showing ${list.length} of ${recipes.length} recipes${(fCat||fProt||fMeth||q)?'<span class="clear-link" onclick="clearF()">Clear filters</span>':""}`;
  const gb=document.getElementById("grocery-btn");
  gb.style.display=checked.size>0?"inline-flex":"none";
  document.getElementById("grocery-count").textContent=checked.size;

  document.getElementById("rows").innerHTML=list.length===0
    ?'<div class="empty">No recipes match your filters.</div>'
    :list.map(r=>{
      const c=CAT_COLORS[r.category]||{bg:"#333",text:"#ccc",dot:"#888"};
      const hd=!!details[r.id];
      return`<div class="trow-wrap" id="wrap-${r.id}">
  <div class="trow${hd?" has-details":""}" onclick="rowClick(event,${r.id})">
    <div style="display:flex;align-items:center;justify-content:center"><input type="checkbox"${checked.has(r.id)?" checked":""} onclick="chk(event,${r.id})"></div>
    <div class="recipe-name">
      <span class="expand-icon">‚ñ∂</span>
      ${r.name}
      ${!hd?'<span class="no-details-hint">¬∑ click to fetch</span>':''}
    </div>
    <div><span class="badge" style="background:${c.bg};color:${c.text}"><span class="dot" style="background:${c.dot}"></span>${r.category}</span></div>
    <div class="meta">${r.protein}</div>
    <div class="meta">${MI[r.method]||"üç¥"} ${r.method}</div>
    <div class="source-col">${r.source}</div>
    <div class="cost">${r.cost}</div>
    <div><a href="${r.url}" target="_blank" class="link-btn" onclick="event.stopPropagation()">‚Üó</a></div>
  </div>
  <div class="detail-panel" id="dp-${r.id}">${hd?detailHTML(r.id):fetchPromptHTML(r.id)}</div>
</div>`;
    }).join("");
}

function detailHTML(id){
  const d=details[id];
  return`<div class="detail-inner">
    <div class="detail-section"><h3>Ingredients</h3><ul class="ingredient-list">${d.ingredients.map(i=>`<li>${esc(i)}</li>`).join("")}</ul></div>
    <div class="detail-section"><h3>Instructions</h3><ol class="steps-list">${d.steps.map(s=>`<li>${esc(s)}</li>`).join("")}</ol></div>
  </div>
  <div class="detail-actions"><button class="btn btn-danger" onclick="delDetails(${id})">üóë Remove Details</button></div>`;
}

function fetchPromptHTML(id){
  const r=recipes.find(x=>x.id===id);
  return`<div style="padding:18px 0">
    <p style="font-size:13px;color:#8a8f9e;margin-bottom:12px">No details saved yet. Click below to have AI read the recipe page and extract the ingredients &amp; steps.</p>
    <button class="btn btn-primary" onclick="fetchDetails(${id})">‚ú® Fetch Ingredients &amp; Steps</button>
  </div>`;
}

function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

function rowClick(e,id){
  if(e.target.type==="checkbox"||e.target.tagName==="A")return;
  document.getElementById("wrap-"+id)?.classList.toggle("open");
}

function chk(e,id){
  e.stopPropagation();
  e.target.checked?checked.add(id):checked.delete(id);
  const gb=document.getElementById("grocery-btn");
  gb.style.display=checked.size>0?"inline-flex":"none";
  document.getElementById("grocery-count").textContent=checked.size;
}

function clearF(){fCat="";fProt="";fMeth="";q="";document.getElementById("search").value="";document.getElementById("filterProt").value="";document.getElementById("filterMeth").value="";render();}

// Fetch details for an existing recipe
async function fetchDetails(id){
  const r=recipes.find(x=>x.id===id);
  const dp=document.getElementById("dp-"+id);
  dp.innerHTML=`<div class="detail-loading"><div class="spinner"></div>Fetching from ${r.source}‚Ä¶</div>`;
  try{
    const txt=await claude(`You are a recipe parser. Visit and extract the recipe at: ${r.url}
Return ONLY valid JSON, no markdown fences:
{"ingredients":["quantity ingredient, notes"],"steps":["Full sentence step."]}
Get ALL ingredients with exact quantities. Get ALL steps as clear complete sentences.`);
    const j=JSON.parse(txt.replace(/^```json\n?|^```\n?|```$/gm,"").trim());
    details[id]={ingredients:j.ingredients,steps:j.steps};
    await saveDetails();
    const wrap=document.getElementById("wrap-"+id);
    wrap.querySelector(".trow").classList.add("has-details");
    const nm=wrap.querySelector(".recipe-name");
    nm.innerHTML=`<span class="expand-icon" style="transform:rotate(90deg)">‚ñ∂</span>${r.name}`;
    dp.innerHTML=detailHTML(id);
    wrap.classList.add("open");
  }catch(err){
    dp.innerHTML=`<div style="padding:14px 0;color:#e07070;font-size:13px">‚ö† ${err.message} <button class="btn btn-outline" style="margin-left:8px;font-size:12px" onclick="fetchDetails(${id})">Retry</button></div>`;
  }
}

function delDetails(id){
  if(!confirm("Remove saved details?"))return;
  delete details[id];
  saveDetails();
  render();
}

// Add panel
function toggleAdd(){document.getElementById("add-panel").classList.toggle("show");}

async function fetchAndAdd(){
  const url=document.getElementById("new-url").value.trim();
  if(!url)return msg("Please enter a URL first.","error");
  setFB(true); msg("‚ú® AI is reading the recipe page‚Ä¶","loading");
  try{
    const txt=await claude(`You are a recipe parser. Visit and extract the recipe at: ${url}
Return ONLY valid JSON, no markdown fences:
{"name":"Recipe Name","source":"Blog Name","protein":"main protein","method":"cooking method","cost":"$X-Y (Aldi estimate)","ingredients":["qty ingredient"],"steps":["Full step."]}
For method use: Slow Cooker, Oven, Stovetop, Air Fryer, No Cook, Microwave, or combinations.`);
    const j=JSON.parse(txt.replace(/^```json\n?|^```\n?|```$/gm,"").trim());
    document.getElementById("new-name").value=j.name||"";
    document.getElementById("new-source").value=j.source||"";
    document.getElementById("new-protein").value=j.protein||"";
    document.getElementById("new-method").value=j.method||"";
    document.getElementById("new-cost").value=j.cost||"";
    pendingDetails={ingredients:j.ingredients||[],steps:j.steps||[]};
    msg("‚úÖ Done! Review the fields above then click Save Recipe.","success");
  }catch(err){msg("‚ö† "+err.message,"error");}
  setFB(false);
}

async function saveNew(){
  const name=document.getElementById("new-name").value.trim();
  const url=document.getElementById("new-url").value.trim();
  if(!name||!url)return msg("Fetch a URL first to fill in the fields.","error");
  const nid=Math.max(...recipes.map(r=>r.id))+1;
  recipes.push({id:nid,name,category:document.getElementById("new-cat").value,protein:document.getElementById("new-protein").value||"Other",method:document.getElementById("new-method").value||"Stovetop",source:document.getElementById("new-source").value||"Unknown",url,cost:document.getElementById("new-cost").value||"TBD"});
  if(pendingDetails){details[nid]=pendingDetails;pendingDetails=null;await saveDetails();}
  await saveExtras();
  buildSelects();
  ["new-url","new-name","new-protein","new-method","new-source","new-cost"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("add-panel").classList.remove("show");
  document.getElementById("add-msg").style.display="none";
  render();
  setTimeout(()=>{const w=document.getElementById("wrap-"+nid);if(w){w.scrollIntoView({behavior:"smooth",block:"center"});w.classList.add("open");}},200);
}

function msg(txt,type){const el=document.getElementById("add-msg");el.style.display="flex";el.className="add-msg "+type;el.innerHTML=type==="loading"?`<div class="spinner"></div>${txt}`:txt;}
function setFB(on){const b=document.getElementById("fetch-btn");b.disabled=on;b.textContent=on?"Fetching‚Ä¶":"‚ú® Fetch & Fill";}

// Grocery list
async function openGrocery(){
  if(!checked.size)return;
  const modal=document.getElementById("grocery-modal");
  modal.classList.add("show");
  const sel=recipes.filter(r=>checked.has(r.id));
  const withD=sel.filter(r=>details[r.id]);
  const noD=sel.filter(r=>!details[r.id]);
  document.getElementById("g-subtitle").textContent=`${sel.length} recipe${sel.length>1?"s":""} selected ¬∑ ${withD.length} with full ingredient lists`;
  const body=document.getElementById("g-body");
  if(!withD.length){body.innerHTML=`<p style="color:#8a8f9e;font-size:13px">None of your selected recipes have details yet. Click a recipe and use "Fetch Ingredients & Steps" first.</p>`;return;}
  body.innerHTML=`<div class="detail-loading"><div class="spinner"></div>Organizing your grocery list‚Ä¶</div>`;
  const ings=[];
  withD.forEach(r=>details[r.id].ingredients.forEach(i=>ings.push(`- ${i} (from: ${r.name})`)));
  try{
    const txt=await claude(`Organize these grocery ingredients into categories. Consolidate duplicates smartly.
${ings.join("\n")}
Return ONLY valid JSON:
{"Meat & Seafood":[{"item":"description","recipes":["name"]}],"Produce":[...],"Dairy & Eggs":[...],"Pantry & Dry Goods":[...],"Canned & Jarred":[...],"Frozen":[...],"Condiments & Sauces":[...],"Bread & Tortillas":[...],"Spices & Seasonings":[...],"Other":[...]}
Only include categories with items.`);
    const j=JSON.parse(txt.replace(/^```json\n?|^```\n?|```$/gm,"").trim());
    let html=Object.entries(j).filter(([,v])=>v&&v.length).map(([cat,items])=>
      `<div class="g-section"><h3>${cat}</h3>${items.map(x=>`<div class="g-item">${esc(x.item)}<span class="g-from">${(x.recipes||[]).join(", ")}</span></div>`).join("")}</div>`
    ).join("");
    if(noD.length)html+=`<div style="margin-top:16px;padding:12px;background:#1a1f2e;border:1px solid #2a2f3e;border-radius:8px;font-size:12px;color:#8a8f9e"><strong style="color:#aaa">‚ö† Missing details:</strong> ${noD.map(r=>`<em>${r.name}</em>`).join(", ")}</div>`;
    body.innerHTML=html;
  }catch(err){body.innerHTML=`<p style="color:#e07070;font-size:13px">‚ö† ${err.message}</p>`;}
}

function closeGrocery(){document.getElementById("grocery-modal").classList.remove("show");}

function copyList(){
  let text="üõí GROCERY LIST\n\n";
  document.querySelectorAll(".g-section").forEach(s=>{
    text+=s.querySelector("h3").textContent+"\n";
    s.querySelectorAll(".g-item").forEach(i=>text+="‚òê "+i.textContent.trim().replace(/\s+/g," ")+"\n");
    text+="\n";
  });
  navigator.clipboard.writeText(text).then(()=>{const b=event.target;b.textContent="‚úÖ Copied!";setTimeout(()=>b.textContent="üìã Copy",2000);});
}

// Claude API
async function claude(prompt){
  const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:4000,messages:[{role:"user",content:prompt}]})});
  const d=await res.json();
  if(d.error)throw new Error(d.error.message);
  return d.content[0].text;
}

// Events
document.getElementById("search").addEventListener("input",e=>{q=e.target.value;render();});
document.getElementById("filterProt").addEventListener("change",e=>{fProt=e.target.value;render();});
document.getElementById("filterMeth").addEventListener("change",e=>{fMeth=e.target.value;render();});
document.getElementById("sortBy").addEventListener("change",e=>{sort=e.target.value;render();});

init();
</script>
</body>
</html>
